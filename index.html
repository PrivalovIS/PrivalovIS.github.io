<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–æ—Ç–æ–≤–æ–π —Å–µ—Ç–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì°</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin:0; padding:0; height:100vh; overflow:hidden; background:#0a0e14; font-family:system-ui,sans-serif; color:#ddd; }
        #map { position:absolute; inset:0; z-index:0; }
        #c { position:absolute; inset:0; z-index:1; image-rendering:crisp-edges; pointer-events:none; }
        #controls {
            position:absolute; top:12px; left:12px; z-index:10;
            background:rgba(20,25,35,0.92); padding:16px; border-radius:10px;
            min-width:340px; box-shadow:0 4px 18px #0006;
        }
        label { display:block; margin:10px 0 4px; font-size:0.9em; }
        input[type=text], input[type=file], select, textarea {
            width:100%; padding:8px 10px; border-radius:6px;
            border:1px solid #3a4454; background:#1a2230; color:white;
            box-sizing:border-box;
        }
        input[type=range] { width:100%; margin:4px 0 10px 0; }
        .row { margin:12px 0; }
        .buttons-row {
            display: flex;
            gap: 8px;
            margin: 12px 0;
        }
        button {
            flex: 1;
            padding:8px 16px;
            background:#2a3444; color:#ddd; border:none; border-radius:6px;
            cursor:pointer;
        }
        button:hover { background:#3a4454; }
        button.active { background:#4af; color:#000; }
        .checkbox-row { margin:8px 0; display:flex; align-items:center; gap:8px; }
        
        /* –î–∏–∞–ª–æ–≥ –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞ */
        .marker-dialog {
            position: fixed;
            background: rgba(20,25,35,0.95);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            min-width: 320px;
            box-shadow: 0 4px 18px #0006;
            display: none;
        }
        .marker-dialog.active {
            display: block;
        }
        .dialog-title {
            margin-top: 0;
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.2em;
        }
        .dialog-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .dialog-buttons button {
            flex: 1;
        }
        .delete-btn {
            background: #ff4444 !important;
            color: white !important;
        }
        .delete-btn:hover {
            background: #ff6666 !important;
        }
        
        /* –ú–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ */
        .bs-marker {
            background: #ff4444;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            cursor: move;
            transition: transform 0.2s;
            position: relative;
        }
        .bs-marker:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .bs-marker:hover {
            transform: scale(1.2);
        }
        .bs-marker.temp {
            background: #ff8888;
            animation: pulse 1s infinite;
        }
        .bs-marker.dragging {
            z-index: 1000 !important;
            opacity: 0.7;
        }
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* –ö—É—Ä—Å–æ—Ä –≤ —Ä–µ–∂–∏–º–µ –ë–° */
        .bs-cursor {
            cursor: crosshair !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è Leaflet –ø–æ–ø–∞–ø–∞ */
        .leaflet-popup-content-wrapper {
            background: rgba(20,25,35,0.95) !important;
            color: #ddd !important;
            border-radius: 10px !important;
            box-shadow: 0 4px 18px #0006 !important;
            border: 1px solid #3a4454 !important;
        }
        .leaflet-popup-content {
            margin: 15px !important;
            min-width: 200px !important;
            font-family: system-ui, sans-serif !important;
        }
        .leaflet-popup-tip {
            background: rgba(20,25,35,0.95) !important;
            box-shadow: 0 4px 18px #0006 !important;
        }
        .marker-popup-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }
        .marker-popup-comment {
            margin-top: 10px;
            color: #aaa;
            font-size: 0.9em;
            line-height: 1.4;
        }
        .popup-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        .popup-buttons button {
            flex: 1;
            padding: 6px 12px;
            font-size: 0.9em;
        }
        .leaflet-popup-close-button {
            color: #ddd !important;
            font-size: 20px !important;
            padding: 5px !important;
        }
        .leaflet-popup-close-button:hover {
            color: #fff !important;
            background: transparent !important;
        }
        
        /* –ö—Ä—É–≥ –¥–ª—è –ë–° */
        .bs-circle {
            pointer-events: none;
            fill: none;
            stroke: #4af;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
        }
    </style>
</head>
<body>
<div id="map"></div>
<canvas id="c"></canvas>
<div id="controls">
    <label for="bgMode">–§–æ–Ω / –∫–∞—Ä—Ç–∞:</label>
    <select id="bgMode" onchange="toggleBgMode()">
        <option value="osm">OpenStreetMap</option>
        <option value="google-sat">Google –°–ø—É—Ç–Ω–∏–∫</option>
        <option value="google-hybrid">Google –ì–∏–±—Ä–∏–¥</option>
        <option value="yandex-sat">–Ø–Ω–¥–µ–∫—Å –°–ø—É—Ç–Ω–∏–∫</option>
        <option value="image">–°–≤–æ—ë –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
    </select>
    <div id="imageUpload" style="display:none; margin-top:10px;">
        <label for="bgImage">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
        <input type="file" id="bgImage" accept="image/*">
    </div>
    
    <div class="buttons-row">
        <button id="buildToggle" onclick="toggleBuild()">–°—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ—Ç–∏</button>
        <button id="bsToggle" onclick="toggleBSMode()">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ë–°</button>
    </div>
    
    <div class="row">
        <label>–†–∞–¥–∏—É—Å (10‚Ä¶5000 –º–µ—Ç—Ä–æ–≤):</label>
        <input type="range" id="radiusSlider" min="10" max="5000" value="500">
        <input type="text" id="radiusText" value="500">
    </div>
    <div class="row">
        <label>–í—Ä–∞—â–µ–Ω–∏–µ (-180‚Ä¶+180¬∞):</label>
        <input type="range" id="rotSlider" min="-180" max="180" value="0">
        <input type="text" id="rotText" value="0">
    </div>
    <div class="checkbox-row">
        <input type="checkbox" id="moveGrid"><label for="moveGrid">–ü–µ—Ä–µ–º–µ—â–∞—Ç—å —Å–µ—Ç–∫—É</label>
    </div>
    <div class="checkbox-row">
        <input type="checkbox" id="showHex" checked><label for="showHex">–°–æ—Ç—ã</label>
    </div>
    <div class="checkbox-row">
        <input type="checkbox" id="showCenters" checked><label for="showCenters">–¶–µ–Ω—Ç—Ä—ã</label>
    </div>
    <div class="checkbox-row">
        <input type="checkbox" id="showCircles"><label for="showCircles">–†–∞–¥–∏—É—Å—ã</label>
    </div>
    <button onclick="reset()">–°–±—Ä–æ—Å</button>
</div>

<!-- –î–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ -->
<div id="markerDialog" class="marker-dialog">
    <label for="markerName">–ù–∞–∑–≤–∞–Ω–∏–µ –ë–°:</label>
    <input type="text" id="markerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
    <label for="markerComment" style="margin-top:10px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
    <textarea id="markerComment" rows="2" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
    
    <div class="checkbox-row" style="margin-top:15px;">
        <input type="checkbox" id="markerShowCircle"><label for="markerShowCircle">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞–¥–∏—É—Å</label>
    </div>
    
    <div id="markerCircleControls" style="margin-top:10px; display:none;">
        <label>–†–∞–¥–∏—É—Å (10‚Ä¶5000 –º–µ—Ç—Ä–æ–≤):</label>
        <input type="range" id="markerCircleSlider" min="10" max="5000" value="500">
        <input type="text" id="markerCircleText" value="500">
    </div>
    
    <div class="dialog-buttons">
        <button onclick="saveMarker()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="cancelMarker()">–û—Ç–º–µ–Ω–∞</button>
        <button id="deleteMarkerBtn" class="delete-btn" onclick="deleteMarker()" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
</div>

<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let leafletMap = null;
let customImage = null;
let bgMode = 'osm';
let radiusMeters = 500; // –†–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö
let rotation = 0; // –í—Ä–∞—â–µ–Ω–∏–µ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
let showHex = true;
let showCenters = true;
let showCircles = false;
let buildEnabled = false;
let bsModeEnabled = false; // –†–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ë–°
let moveGridEnabled = false; // –†–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å–µ—Ç–∫–∏
let isDragging = false;
let dragStartPixelX = 0;
let dragStartPixelY = 0;
let dragStartLat = 0;
let dragStartLng = 0;

// –¶–µ–Ω—Ç—Ä —Å–µ—Ç–∫–∏ –≤ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
let gridCenterLat = null;
let gridCenterLng = null;

// –•—Ä–∞–Ω–∏–º —Å–µ—Ç–∫—É –≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (q, r) –≥–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω–æ–π —Å–µ—Ç–∫–∏
let activeHexes = new Map(); // –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Ç—ã: –∫–ª—é—á = "q,r", –∑–Ω–∞—á–µ–Ω–∏–µ = {q, r}
let possibleHexes = new Map(); // –í–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã: –∫–ª—é—á = "q,r", –∑–Ω–∞—á–µ–Ω–∏–µ = {q, r}

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π
let bsMarkers = [];
let leafletMarkers = []; // Leaflet –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
let currentMarkerData = null; // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–æ–±–∞–≤–ª—è–µ–º–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
let currentClickPosition = { x: 0, y: 0 }; // –ü–æ–∑–∏—Ü–∏—è –∫–ª–∏–∫–∞ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
let tempMarker = null; // –í—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
let editingMarkerId = null; // ID –º–∞—Ä–∫–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è
let bsCircles = new Map(); // –ö—Ä—É–≥–∏ –¥–ª—è –ë–°: –∫–ª—é—á = markerId, –∑–Ω–∞—á–µ–Ω–∏–µ = L.circle
let isDraggingMarker = false; // –§–ª–∞–≥ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
let draggedMarkerId = null; // ID –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
let previewCircle = null; // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫—Ä—É–≥–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ë–°

// –ì–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—à–µ—Å—Ç—å —Å–æ—Å–µ–¥–µ–π)
const hexDirections = [
    { q: 1, r: 0 },   // –í–ø—Ä–∞–≤–æ
    { q: 1, r: -1 },  // –í–ø—Ä–∞–≤–æ-–≤–≤–µ—Ä—Ö
    { q: 0, r: -1 },  // –í–ª–µ–≤–æ-–≤–≤–µ—Ä—Ö
    { q: -1, r: 0 },  // –í–ª–µ–≤–æ
    { q: -1, r: 1 },  // –í–ª–µ–≤–æ-–≤–Ω–∏–∑
    { q: 0, r: 1 }    // –í–ø—Ä–∞–≤–æ-–≤–Ω–∏–∑
];

// –°–ª–æ–∏ –∫–∞—Ä—Ç—ã
const googleSat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '¬© Google'
});
const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '¬© Google'
});
const yandexSat = L.tileLayer('https://core-sat.maps.yandex.net/tiles?l=sat&v=23.10.26-0&x={x}&y={y}&z={z}&scale=1&lang=ru_RU', {
    maxZoom: 19, attribution: '¬© –Ø–Ω–¥–µ–∫—Å'
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–¥–∏—É—Å–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –Ω–∞ —Ç–µ–∫—É—â–µ–º –∑—É–º–µ
function getRadiusInPixels() {
    if (!leafletMap) return radiusMeters; // –î–ª—è —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ—Ç—Ä—ã –∫–∞–∫ –ø–∏–∫—Å–µ–ª–∏
    
    // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—Ç—Ä —Å–µ—Ç–∫–∏ (–∏–ª–∏ —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ —Å–µ—Ç–∫–∞ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞)
    let centerLat, centerLng;
    if (gridCenterLat !== null && gridCenterLng !== null) {
        centerLat = gridCenterLat;
        centerLng = gridCenterLng;
    } else {
        const mapCenter = leafletMap.getCenter();
        centerLat = mapCenter.lat;
        centerLng = mapCenter.lng;
    }
    
    const centerPx = leafletMap.latLngToContainerPoint([centerLat, centerLng]);
    
    // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫—É –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ radiusMeters –∫ –≤–æ—Å—Ç–æ–∫—É –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
    const degreesPerMeter = 1 / (111111 * Math.cos(centerLat * Math.PI / 180));
    const eastPoint = L.latLng(centerLat, centerLng + radiusMeters * degreesPerMeter);
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–∏–∫—Å–µ–ª–∏
    const eastPx = leafletMap.latLngToContainerPoint(eastPoint);
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    return Math.abs(eastPx.x - centerPx.x);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Å–µ—Ç–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö (–∏–ª–∏ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ —Å–µ—Ç–∫–∞ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞)
function getGridCenterInPixels() {
    if (leafletMap) {
        if (gridCenterLat !== null && gridCenterLng !== null) {
            return leafletMap.latLngToContainerPoint([gridCenterLat, gridCenterLng]);
        } else {
            // –ï—Å–ª–∏ —Å–µ—Ç–∫–∞ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã
            const center = leafletMap.getCenter();
            return leafletMap.latLngToContainerPoint([center.lat, center.lng]);
        }
    } else {
        return { 
            x: canvas.width / 2, 
            y: canvas.height / 2 
        };
    }
}

// –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä –≤—Ä–∞—â–µ–Ω–∏—è (—Ç–æ—á–∫–∞ (0,0) –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö —Å–µ—Ç–∫–∏)
function getRotationCenter() {
    // –¶–µ–Ω—Ç—Ä –≤—Ä–∞—â–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –≤ —Ç–æ—á–∫–µ (0,0) –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å–µ—Ç–∫–∏
    return { x: 0, y: 0 };
}

// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≥–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (q, r) –≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
function hexToRelativeCoords(q, r) {
    const radiusPx = getRadiusInPixels();
    const height = Math.sqrt(3) * radiusPx;
    const x = height * (q + r / 2);
    const y = radiusPx * 1.5 * r;
    return { x, y, radius: radiusPx };
}

// –í—Ä–∞—â–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞
function rotatePointAroundCenter(pointX, pointY, centerX, centerY, angle) {
    const rad = angle * Math.PI / 180;
    const cos = Math.cos(rad);
    const sin = Math.sin(rad);
    
    // –°–º–µ—â–∞–µ–º —Ç–æ—á–∫—É –≤ –Ω–∞—á–∞–ª–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    const x = pointX - centerX;
    const y = pointY - centerY;
    
    // –í—Ä–∞—â–∞–µ–º
    const xRotated = x * cos - y * sin;
    const yRotated = x * sin + y * cos;
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –º–µ—Å—Ç–æ
    return {
        x: xRotated + centerX,
        y: yRotated + centerY
    };
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // –í —Ä–µ–∂–∏–º–µ –ë–° –¥–∞–µ–º –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–æ–±—ã—Ç–∏—è–º –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
    if (bsModeEnabled) {
        canvas.style.pointerEvents = 'auto';
        document.body.classList.add('bs-cursor');
    } else {
        canvas.style.pointerEvents = (buildEnabled || moveGridEnabled) ? 'auto' : 'none';
        document.body.classList.remove('bs-cursor');
    }
    
    updateCursor();
    draw();
}

function parseNum(str, fallback = 0) {
    if (!str.trim()) return fallback;
    const cleaned = str.trim().replace(',', '.');
    const num = parseFloat(cleaned);
    return isNaN(num) ? fallback : num;
}

function applyRadius() {
    const slider = document.getElementById('radiusSlider');
    const text = document.getElementById('radiusText');
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ
    if (text.value !== slider.value) {
        radiusMeters = parseNum(text.value, radiusMeters);
    } else {
        radiusMeters = parseFloat(slider.value) || radiusMeters;
    }
    
    radiusMeters = Math.max(10, Math.min(5000, radiusMeters));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
    slider.value = radiusMeters;
    text.value = Math.round(radiusMeters * 100) / 100;
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –Ω–æ–≤—ã–º —Ä–∞–¥–∏—É—Å–æ–º
    if (buildEnabled && activeHexes.size > 0) {
        updatePossibleHexes();
    }
    draw();
}

function applyRotation() {
    const slider = document.getElementById('rotSlider');
    const text = document.getElementById('rotText');
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ
    if (text.value !== slider.value) {
        rotation = parseNum(text.value, rotation);
    } else {
        rotation = parseFloat(slider.value) || rotation;
    }
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª –≤ –¥–∏–∞–ø–∞–∑–æ–Ω -180..180
    while (rotation < -180) rotation += 360;
    while (rotation > 180) rotation -= 360;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
    const displayRotation = rotation;
    slider.value = displayRotation;
    text.value = Math.round(displayRotation * 100) / 100;
    
    draw();
}

function toggleBuild() {
    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –ë–° –≤–∫–ª—é—á–µ–Ω, –≤—ã–∫–ª—é—á–∞–µ–º –µ–≥–æ
    if (bsModeEnabled) {
        bsModeEnabled = false;
        document.getElementById('bsToggle').classList.remove('active');
        document.getElementById('bsToggle').textContent = '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ë–°';
        document.body.classList.remove('bs-cursor');
        
        // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫—Ä—É–≥–∞
        removeTempMarker();
        removePreviewCircle();
        
        // –í–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π
        if (leafletMap) {
            leafletMap.dragging.enable();
            leafletMap.scrollWheelZoom.enable();
        }
    }
    
    buildEnabled = !buildEnabled;
    const btn = document.getElementById('buildToggle');
    btn.textContent = '–°—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ—Ç–∏';
    btn.classList.toggle('active', buildEnabled);
    canvas.style.pointerEvents = (buildEnabled || moveGridEnabled) ? 'auto' : 'none';
    updateCursor();
    
    if (buildEnabled && ((leafletMap && gridCenterLat === null && gridCenterLng === null) || (!leafletMap && gridCenterLat === null))) {
        if (leafletMap) {
            const center = leafletMap.getCenter();
            gridCenterLat = center.lat;
            gridCenterLng = center.lng;
        } else {
            // –î–ª—è —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä –∫–∞–Ω–≤–∞—Å–∞
            gridCenterLat = 0;
            gridCenterLng = 0;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Å–æ—Ç—É (0,0)
        activeHexes.set("0,0", { q: 0, r: 0 });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã
        updatePossibleHexes();
    } else if (!buildEnabled) {
        // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã
        possibleHexes.clear();
    } else if (buildEnabled && activeHexes.size > 0) {
        // –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤–∫–ª—é—á–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã
        updatePossibleHexes();
    }
    
    draw();
}

function toggleBSMode() {
    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω, –≤—ã–∫–ª—é—á–∞–µ–º –µ–≥–æ
    if (buildEnabled) {
        buildEnabled = false;
        document.getElementById('buildToggle').classList.remove('active');
        possibleHexes.clear();
    }
    
    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å–µ—Ç–∫–∏ –≤–∫–ª—é—á–µ–Ω, –≤—ã–∫–ª—é—á–∞–µ–º –µ–≥–æ
    if (moveGridEnabled) {
        moveGridEnabled = false;
        document.getElementById('moveGrid').checked = false;
        if (leafletMap) {
            leafletMap.dragging.enable();
            leafletMap.scrollWheelZoom.enable();
        }
    }
    
    bsModeEnabled = !bsModeEnabled;
    const btn = document.getElementById('bsToggle');
    btn.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ë–°';
    btn.classList.toggle('active', bsModeEnabled);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    updateCursor();
    
    // –í —Ä–µ–∂–∏–º–µ –ë–° –¥–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –∫–∞—Ä—Ç—É
    if (leafletMap) {
        if (bsModeEnabled) {
            leafletMap.dragging.enable();
            leafletMap.scrollWheelZoom.enable();
        } else {
            // –ï—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å–µ—Ç–∫–∏, –æ—Å—Ç–∞–≤–ª—è–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            if (!moveGridEnabled) {
                leafletMap.dragging.enable();
                leafletMap.scrollWheelZoom.enable();
            }
        }
    }
    
    // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫—Ä—É–≥–∞ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞
    if (!bsModeEnabled) {
        removeTempMarker();
        removePreviewCircle();
    }
    
    draw();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
function updateCursor() {
    if (bsModeEnabled) {
        canvas.style.cursor = 'crosshair';
        canvas.style.pointerEvents = 'auto';
        document.body.classList.add('bs-cursor');
    } else if (buildEnabled || moveGridEnabled) {
        canvas.style.cursor = 'pointer';
        canvas.style.pointerEvents = 'auto';
        document.body.classList.remove('bs-cursor');
    } else {
        canvas.style.cursor = 'default';
        canvas.style.pointerEvents = 'none';
        document.body.classList.remove('bs-cursor');
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ—Å–µ–¥–µ–π –≥–µ–∫—Å–∞–≥–æ–Ω–∞
function getHexNeighbors(q, r) {
    return hexDirections.map(dir => ({
        q: q + dir.q,
        r: r + dir.r
    }));
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ—Ç
function updatePossibleHexes() {
    if (!buildEnabled || activeHexes.size === 0) {
        possibleHexes.clear();
        return;
    }
    
    possibleHexes.clear();
    
    // –î–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π —Å–æ—Ç—ã –ø–æ–ª—É—á–∞–µ–º –µ—ë —Å–æ—Å–µ–¥–µ–π
    for (const hex of activeHexes.values()) {
        const neighbors = getHexNeighbors(hex.q, hex.r);
        
        for (const neighbor of neighbors) {
            const key = `${neighbor.q},${neighbor.r}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–∞ —Å–æ—Ç–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ–π
            if (!activeHexes.has(key) && !possibleHexes.has(key)) {
                possibleHexes.set(key, neighbor);
            }
        }
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ü–µ–Ω—Ç—Ä–∞ —Å–æ—Ç—ã
function getHexScreenPosition(q, r) {
    const gridCenterPx = getGridCenterInPixels();
    const relativeCoords = hexToRelativeCoords(q, r);
    const rotationCenter = getRotationCenter();
    
    // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ç–∫–∏
    let x = gridCenterPx.x + relativeCoords.x;
    let y = gridCenterPx.y + relativeCoords.y;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –≤—Å–µ–π —Å–µ—Ç–∫–∏ –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞ –≤—Ä–∞—â–µ–Ω–∏—è
    if (rotation !== 0) {
        const centerX = gridCenterPx.x + rotationCenter.x;
        const centerY = gridCenterPx.y + rotationCenter.y;
        const rotated = rotatePointAroundCenter(x, y, centerX, centerY, rotation);
        x = rotated.x;
        y = rotated.y;
    }
    
    return { 
        x, 
        y,
        radius: relativeCoords.radius
    };
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞
function isPointInHexagon(px, py, hexX, hexY, hexRadius) {
    // –í—Ä–∞—â–∞–µ–º —Ç–æ—á–∫—É –∫–ª–∏–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –Ω–µ–≤—Ä–∞—â–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    const gridCenterPx = getGridCenterInPixels();
    const rotationCenter = getRotationCenter();
    
    if (rotation !== 0) {
        const centerX = gridCenterPx.x + rotationCenter.x;
        const centerY = gridCenterPx.y + rotationCenter.y;
        
        // –í—Ä–∞—â–∞–µ–º —Ç–æ—á–∫—É –∫–ª–∏–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —É–≥–æ–ª)
        const unrotatedPoint = rotatePointAroundCenter(px, py, centerX, centerY, -rotation);
        px = unrotatedPoint.x;
        py = unrotatedPoint.y;
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ —Å–æ—Ç—ã –±–µ–∑ –≤—Ä–∞—â–µ–Ω–∏—è
        const unrotatedCenter = rotatePointAroundCenter(hexX, hexY, centerX, centerY, -rotation);
        hexX = unrotatedCenter.x;
        hexY = unrotatedCenter.y;
    }
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞
    const dx = px - hexX;
    const dy = py - hexY;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞
    const distance = Math.sqrt(dx * dx + dy * dy);
    if (distance > hexRadius) return false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≥–æ–ª –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –≥—Ä–∞–Ω–µ–π
    // –£–≥–æ–ª —Ç–æ—á–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞
    let angle = Math.atan2(dy, dx);
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª –æ—Ç 0 –¥–æ 2œÄ
    if (angle < 0) angle += 2 * Math.PI;
    
    // –ù–∞—Ö–æ–¥–∏–º, –∫ –∫–∞–∫–æ–π –≥—Ä–∞–Ω–∏ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞ –±–ª–∏–∂–µ —Ç–æ—á–∫–∞
    const segmentAngle = Math.PI / 3; // 60 –≥—Ä–∞–¥—É—Å–æ–≤
    const segment = Math.floor(angle / segmentAngle);
    
    // –£–≥–æ–ª –≤–Ω—É—Ç—Ä–∏ —Å–µ–≥–º–µ–Ω—Ç–∞
    const segmentStart = segment * segmentAngle;
    const segmentEnd = segmentStart + segmentAngle;
    const angleInSegment = angle - segmentStart;
    
    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –≥—Ä–∞–Ω–∏ –≤ —ç—Ç–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ
    const maxDistance = hexRadius * Math.cos(segmentAngle / 2 - angleInSegment) / Math.cos(segmentAngle / 2);
    
    return distance <= maxDistance;
}

// –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
function createTempMarker(lat, lng) {
    if (!leafletMap) return null;
    
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
    removeTempMarker();
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π HTML –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
    const markerHtml = document.createElement('div');
    markerHtml.className = 'bs-marker temp';
    markerHtml.title = '–ù–æ–≤–∞—è –±–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è';
    
    // –°–æ–∑–¥–∞–µ–º Leaflet –º–∞—Ä–∫–µ—Ä
    tempMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            html: markerHtml.outerHTML,
            iconSize: [24, 24],
            iconAnchor: [12, 12],
            className: 'bs-marker-icon'
        }),
        draggable: false
    }).addTo(leafletMap);
    
    return tempMarker;
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
function removeTempMarker() {
    if (tempMarker && leafletMap) {
        leafletMap.removeLayer(tempMarker);
        tempMarker = null;
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫—Ä—É–≥–∞
function createPreviewCircle(lat, lng, radius) {
    if (!leafletMap) return null;
    
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫—Ä—É–≥–∞
    removePreviewCircle();
    
    // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    previewCircle = L.circle([lat, lng], {
        radius: radius,
        color: '#4af',
        fillColor: '#4af',
        fillOpacity: 0.1,
        weight: 2,
        dashArray: '5, 5'
    }).addTo(leafletMap);
    
    return previewCircle;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫—Ä—É–≥–∞
function updatePreviewCircle(lat, lng, radius) {
    if (!previewCircle) {
        createPreviewCircle(lat, lng, radius);
    } else {
        previewCircle.setLatLng([lat, lng]);
        previewCircle.setRadius(radius);
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫—Ä—É–≥–∞
function removePreviewCircle() {
    if (previewCircle && leafletMap) {
        leafletMap.removeLayer(previewCircle);
        previewCircle = null;
    }
}

// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ —Ä—è–¥–æ–º —Å –∫–ª–∏–∫–æ–º
function positionDialogNearMarker(x, y) {
    const dialog = document.getElementById('markerDialog');
    const rect = canvas.getBoundingClientRect();
    const dialogWidth = 350;
    const dialogHeight = 350;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–∏–∞–ª–æ–≥–∞
    let left = rect.left + x + 20;
    let top = rect.top + y;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –¥–∏–∞–ª–æ–≥ –Ω–µ –≤—ã—Ö–æ–¥–∏–ª –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –æ–∫–Ω–∞
    if (left + dialogWidth > window.innerWidth) {
        left = rect.left + x - dialogWidth - 20;
    }
    if (top + dialogHeight > window.innerHeight) {
        top = rect.top + y - dialogHeight;
    }
    
    dialog.style.left = left + 'px';
    dialog.style.top = top + 'px';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞–Ω–≤–∞—Å—É
canvas.addEventListener('click', function(e) {
    if (!buildEnabled && !moveGridEnabled && !bsModeEnabled) return;
    
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–ª–∏–∫–∞ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
    currentClickPosition = { x: clickX, y: clickY };
    
    // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ë–°
    if (bsModeEnabled && leafletMap) {
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –≤ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        const latLng = leafletMap.containerPointToLatLng([clickX, clickY]);
        
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
        createTempMarker(latLng.lat, latLng.lng);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
        currentMarkerData = {
            lat: latLng.lat,
            lng: latLng.lng,
            temp: true
        };
        
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫—Ä—É–≥–∞, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–¥–∏—É—Å–∞
        const showCircle = document.getElementById('markerShowCircle').checked;
        const circleRadius = parseInt(document.getElementById('markerCircleText').value) || 500;
        if (showCircle) {
            createPreviewCircle(latLng.lat, latLng.lng, circleRadius);
        }
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
        positionDialogNearMarker(clickX, clickY);
        showMarkerDialog(false);
        return;
    }
    
    // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å–æ—Ç–∞–º
    if (buildEnabled) {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–æ—Ç–µ (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)
        let clickedActiveHex = null;
        for (const hex of activeHexes.values()) {
            const screenPos = getHexScreenPosition(hex.q, hex.r);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞
            if (isPointInHexagon(clickX, clickY, screenPos.x, screenPos.y, screenPos.radius)) {
                clickedActiveHex = hex;
                break;
            }
        }
        
        // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–æ—Ç–µ - —É–¥–∞–ª—è–µ–º –µ—ë
        if (clickedActiveHex) {
            // –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–æ—Ç—É
            if (activeHexes.size > 1) {
                const key = `${clickedActiveHex.q},${clickedActiveHex.r}`;
                activeHexes.delete(key);
                updatePossibleHexes();
                draw();
            }
            return;
        }
        
        // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–µ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–æ—Ç–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã (–¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)
        if (possibleHexes.size === 0) return;
        
        let clickedPossibleHex = null;
        for (const hex of possibleHexes.values()) {
            const screenPos = getHexScreenPosition(hex.q, hex.r);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞
            if (isPointInHexagon(clickX, clickY, screenPos.x, screenPos.y, screenPos.radius)) {
                clickedPossibleHex = hex;
                break;
            }
        }
        
        if (clickedPossibleHex) {
            const key = `${clickedPossibleHex.q},${clickedPossibleHex.r}`;
            activeHexes.set(key, clickedPossibleHex);
            updatePossibleHexes();
            draw();
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Å–µ—Ç–∫–∏
canvas.addEventListener('mousedown', function(e) {
    if (!moveGridEnabled || !leafletMap || activeHexes.size === 0) return;
    
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    dragStartPixelX = mouseX;
    dragStartPixelY = mouseY;
    dragStartLat = gridCenterLat;
    dragStartLng = gridCenterLng;
    
    isDragging = true;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
    e.preventDefault();
});

canvas.addEventListener('mousemove', function(e) {
    if (!isDragging || !moveGridEnabled || !leafletMap) return;
    
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    const deltaPixelX = mouseX - dragStartPixelX;
    const deltaPixelY = mouseY - dragStartPixelY;
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –≤ –ø–∏–∫—Å–µ–ª–∏
    const startPx = leafletMap.latLngToContainerPoint([dragStartLat, dragStartLng]);
    
    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    const newPx = {
        x: startPx.x + deltaPixelX,
        y: startPx.y + deltaPixelY
    };
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    const newLatLng = leafletMap.containerPointToLatLng([newPx.x, newPx.y]);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä —Å–µ—Ç–∫–∏
    gridCenterLat = newLatLng.lat;
    gridCenterLng = newLatLng.lng;
    
    draw();
});

canvas.addEventListener('mouseup', function() {
    isDragging = false;
});

canvas.addEventListener('mouseleave', function() {
    isDragging = false;
});

// –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
function createMarker(lat, lng, name = '', comment = '', id = null, showCircle = false, circleRadius = 500) {
    if (!leafletMap) return null;
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π HTML –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –ë–°
    const markerHtml = document.createElement('div');
    markerHtml.className = 'bs-marker';
    markerHtml.title = name || '–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è';
    
    // –°–æ–∑–¥–∞–µ–º Leaflet –º–∞—Ä–∫–µ—Ä
    const marker = L.marker([lat, lng], {
        icon: L.divIcon({
            html: markerHtml.outerHTML,
            iconSize: [24, 24],
            iconAnchor: [12, 12],
            className: 'bs-marker-icon'
        }),
        draggable: true // –î–µ–ª–∞–µ–º –º–∞—Ä–∫–µ—Ä –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
    }).addTo(leafletMap);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
    marker.on('dragstart', function(e) {
        isDraggingMarker = true;
        draggedMarkerId = id;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        const iconElement = marker.getElement();
        if (iconElement) {
            iconElement.classList.add('dragging');
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        marker.closePopup();
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
    marker.on('drag', function(e) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫—Ä—É–≥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        const markerIndex = leafletMarkers.findIndex(m => m.id === id);
        if (markerIndex !== -1) {
            const markerData = leafletMarkers[markerIndex];
            if (markerData.circle) {
                markerData.circle.setLatLng(e.target.getLatLng());
            }
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
    marker.on('dragend', function(e) {
        isDraggingMarker = false;
        draggedMarkerId = null;
        
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        const iconElement = marker.getElement();
        if (iconElement) {
            iconElement.classList.remove('dragging');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        const markerIndex = leafletMarkers.findIndex(m => m.id === id);
        if (markerIndex !== -1) {
            const newLatLng = e.target.getLatLng();
            leafletMarkers[markerIndex].lat = newLatLng.lat;
            leafletMarkers[markerIndex].lng = newLatLng.lng;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            const bsMarkerIndex = bsMarkers.findIndex(m => m.id === id);
            if (bsMarkerIndex !== -1) {
                bsMarkers[bsMarkerIndex].lat = newLatLng.lat;
                bsMarkers[bsMarkerIndex].lng = newLatLng.lng;
            }
        }
    });
    
    // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è –ø–æ–ø–∞–ø–∞
    const popupContent = document.createElement('div');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    const title = document.createElement('div');
    title.className = 'marker-popup-title';
    title.textContent = name || '–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è';
    popupContent.appendChild(title);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (comment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'marker-popup-comment';
        commentDiv.textContent = comment;
        popupContent.appendChild(commentDiv);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–¥–∏—É—Å–µ, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
    if (showCircle) {
        const circleInfo = document.createElement('div');
        circleInfo.className = 'marker-popup-comment';
        circleInfo.textContent = `–†–∞–¥–∏—É—Å: ${circleRadius} –º`;
        circleInfo.style.color = '#4af';
        popupContent.appendChild(circleInfo);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'popup-buttons';
    buttonsDiv.innerHTML = `
        <button onclick="editMarker(${id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="deleteMarkerById(${id})" style="background:#ff4444;color:white;">–£–¥–∞–ª–∏—Ç—å</button>
    `;
    popupContent.appendChild(buttonsDiv);
    
    marker.bindPopup(popupContent);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–ø–∞–ø–∞ - –¥–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –∫–∞—Ä—Ç—É
    marker.on('popupopen', function(e) {
        // –í–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –ø–æ–ø–∞–ø–µ
        if (leafletMap) {
            leafletMap.dragging.enable();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–ø–∞–ø–∞
    marker.on('popupclose', function(e) {
        // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∫–ª—é—á–µ–Ω–Ω—ã–º
    });
    
    // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    let circle = null;
    if (showCircle && circleRadius > 0) {
        circle = L.circle([lat, lng], {
            radius: circleRadius,
            color: '#4af',
            fillColor: '#4af',
            fillOpacity: 0.1,
            weight: 2,
            dashArray: '5, 5'
        }).addTo(leafletMap);
    }
    
    return { 
        marker, 
        id: id || Date.now(), 
        lat, 
        lng, 
        name, 
        comment,
        showCircle: showCircle || false,
        circleRadius: circleRadius || 500,
        circle: circle
    };
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä—É–≥–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞
function updateMarkerCircle(markerData) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫—Ä—É–≥
    if (markerData.circle && leafletMap) {
        leafletMap.removeLayer(markerData.circle);
        markerData.circle = null;
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫—Ä—É–≥, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if (markerData.showCircle && markerData.circleRadius > 0) {
        markerData.circle = L.circle([markerData.lat, markerData.lng], {
            radius: markerData.circleRadius,
            color: '#4af',
            fillColor: '#4af',
            fillOpacity: 0.1,
            weight: 2,
            dashArray: '5, 5'
        }).addTo(leafletMap);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–ø–∞–ø–∞
    if (markerData.marker) {
        const popupContent = document.createElement('div');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
        const title = document.createElement('div');
        title.className = 'marker-popup-title';
        title.textContent = markerData.name || '–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è';
        popupContent.appendChild(title);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (markerData.comment) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'marker-popup-comment';
            commentDiv.textContent = markerData.comment;
            popupContent.appendChild(commentDiv);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–¥–∏—É—Å–µ, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
        if (markerData.showCircle) {
            const circleInfo = document.createElement('div');
            circleInfo.className = 'marker-popup-comment';
            circleInfo.textContent = `–†–∞–¥–∏—É—Å: ${markerData.circleRadius} –º`;
            circleInfo.style.color = '#4af';
            popupContent.appendChild(circleInfo);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'popup-buttons';
        buttonsDiv.innerHTML = `
            <button onclick="editMarker(${markerData.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button onclick="deleteMarkerById(${markerData.id})" style="background:#ff4444;color:white;">–£–¥–∞–ª–∏—Ç—å</button>
        `;
        popupContent.appendChild(buttonsDiv);
        
        markerData.marker.bindPopup(popupContent);
    }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
function editMarker(markerId) {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
    const markerIndex = leafletMarkers.findIndex(m => m.id === markerId);
    if (markerIndex !== -1) {
        leafletMarkers[markerIndex].marker.closePopup();
    }
    
    const markerIndex2 = bsMarkers.findIndex(m => m.id === markerId);
    if (markerIndex2 === -1) return;
    
    const marker = bsMarkers[markerIndex2];
    editingMarkerId = markerId;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∏–∞–ª–æ–≥ –¥–∞–Ω–Ω—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞
    document.getElementById('markerName').value = marker.name || '';
    document.getElementById('markerComment').value = marker.comment || '';
    document.getElementById('markerShowCircle').checked = marker.showCircle || false;
    document.getElementById('markerCircleSlider').value = marker.circleRadius || 500;
    document.getElementById('markerCircleText').value = marker.circleRadius || 500;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –∫—Ä—É–≥–∞
    const circleControls = document.getElementById('markerCircleControls');
    circleControls.style.display = marker.showCircle ? 'block' : 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
    document.getElementById('deleteMarkerBtn').style.display = 'block';
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥ —Ä—è–¥–æ–º —Å –º–∞—Ä–∫–µ—Ä–æ–º
    const markerPx = leafletMap.latLngToContainerPoint([marker.lat, marker.lng]);
    positionDialogNearMarker(markerPx.x, markerPx.y);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
    showMarkerDialog(true);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ ID
function deleteMarkerById(markerId) {
    const markerIndex = bsMarkers.findIndex(m => m.id === markerId);
    if (markerIndex === -1) return;
    
    // –£–¥–∞–ª—è–µ–º Leaflet –º–∞—Ä–∫–µ—Ä
    const leafletMarkerIndex = leafletMarkers.findIndex(m => m.id === markerId);
    if (leafletMarkerIndex !== -1) {
        const leafletMarker = leafletMarkers[leafletMarkerIndex];
        if (leafletMarker.marker && leafletMap) {
            leafletMap.removeLayer(leafletMarker.marker);
        }
        // –£–¥–∞–ª—è–µ–º –∫—Ä—É–≥
        if (leafletMarker.circle && leafletMap) {
            leafletMap.removeLayer(leafletMarker.circle);
        }
        leafletMarkers.splice(leafletMarkerIndex, 1);
    }
    
    // –£–¥–∞–ª—è–µ–º –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    bsMarkers.splice(markerIndex, 1);
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
    if (editingMarkerId === markerId) {
        hideMarkerDialog();
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ (–∏–∑ –¥–∏–∞–ª–æ–≥–∞)
function deleteMarker() {
    if (!editingMarkerId) return;
    
    deleteMarkerById(editingMarkerId);
    hideMarkerDialog();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–∞
function showMarkerDialog(isEditing = false) {
    const dialog = document.getElementById('markerDialog');
    dialog.classList.add('active');
    
    if (isEditing) {
        document.getElementById('deleteMarkerBtn').style.display = 'block';
    } else {
        document.getElementById('markerName').value = '';
        document.getElementById('markerComment').value = '';
        document.getElementById('markerShowCircle').checked = false;
        document.getElementById('markerCircleSlider').value = 500;
        document.getElementById('markerCircleText').value = 500;
        document.getElementById('markerCircleControls').style.display = 'none';
        document.getElementById('deleteMarkerBtn').style.display = 'none';
    }
    
    document.getElementById('markerName').focus();
}

// –°–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥
function hideMarkerDialog() {
    document.getElementById('markerDialog').classList.remove('active');
    currentMarkerData = null;
    editingMarkerId = null;
    
    // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫—Ä—É–≥–∞
    removeTempMarker();
    removePreviewCircle();
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä–∫–µ—Ä
function saveMarker() {
    const name = document.getElementById('markerName').value.trim();
    const comment = document.getElementById('markerComment').value.trim();
    const showCircle = document.getElementById('markerShowCircle').checked;
    const circleRadius = parseInt(document.getElementById('markerCircleText').value) || 500;
    
    if (editingMarkerId) {
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
        const markerIndex = bsMarkers.findIndex(m => m.id === editingMarkerId);
        if (markerIndex !== -1) {
            bsMarkers[markerIndex].name = name || '–ë–°';
            bsMarkers[markerIndex].comment = comment;
            bsMarkers[markerIndex].showCircle = showCircle;
            bsMarkers[markerIndex].circleRadius = circleRadius;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º Leaflet –º–∞—Ä–∫–µ—Ä
            const leafletMarkerIndex = leafletMarkers.findIndex(m => m.id === editingMarkerId);
            if (leafletMarkerIndex !== -1) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–≥
                leafletMarkers[leafletMarkerIndex].showCircle = showCircle;
                leafletMarkers[leafletMarkerIndex].circleRadius = circleRadius;
                updateMarkerCircle(leafletMarkers[leafletMarkerIndex]);
            }
        }
    } else if (currentMarkerData) {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
        const markerId = Date.now();
        const marker = {
            id: markerId,
            lat: currentMarkerData.lat,
            lng: currentMarkerData.lng,
            name: name || '–ë–°',
            comment: comment,
            showCircle: showCircle,
            circleRadius: circleRadius
        };
        
        bsMarkers.push(marker);
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
        const leafletMarker = createMarker(
            marker.lat, 
            marker.lng, 
            marker.name, 
            marker.comment, 
            markerId,
            marker.showCircle,
            marker.circleRadius
        );
        if (leafletMarker) {
            leafletMarkers.push(leafletMarker);
        }
    }
    
    hideMarkerDialog();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ë–° –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤)
    if (!editingMarkerId && bsModeEnabled) {
        toggleBSMode();
    }
}

// –û—Ç–º–µ–Ω–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
function cancelMarker() {
    hideMarkerDialog();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ë–° –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤)
    if (!editingMarkerId && bsModeEnabled) {
        toggleBSMode();
    }
}

// –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã
function clearMarkers() {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ Leaflet –º–∞—Ä–∫–µ—Ä—ã —Å –∫–∞—Ä—Ç—ã
    leafletMarkers.forEach(markerData => {
        if (markerData.marker && leafletMap) {
            leafletMap.removeLayer(markerData.marker);
        }
        // –£–¥–∞–ª—è–µ–º –∫—Ä—É–≥–∏
        if (markerData.circle && leafletMap) {
            leafletMap.removeLayer(markerData.circle);
        }
    });
    
    // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤—ã
    bsMarkers = [];
    leafletMarkers = [];
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π —Ñ–æ–Ω–∞
function saveMapState() {
    if (!leafletMap) return null;
    
    return {
        center: leafletMap.getCenter(),
        zoom: leafletMap.getZoom(),
        gridCenterLat: gridCenterLat,
        gridCenterLng: gridCenterLng,
        activeHexes: Array.from(activeHexes.entries()),
        bsMarkers: bsMarkers
    };
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ñ–æ–Ω–∞
function restoreMapState(state) {
    if (!state || !leafletMap) return;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä –∏ –∑—É–º –∫–∞—Ä—Ç—ã
    leafletMap.setView(state.center, state.zoom);
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä —Å–µ—Ç–∫–∏
    gridCenterLat = state.gridCenterLat;
    gridCenterLng = state.gridCenterLng;
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Ç—ã
    activeHexes.clear();
    for (const [key, hex] of state.activeHexes) {
        activeHexes.set(key, hex);
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –ë–°
    clearMarkers();
    bsMarkers = state.bsMarkers || [];
    
    // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ
    bsMarkers.forEach(marker => {
        const leafletMarker = createMarker(
            marker.lat, 
            marker.lng, 
            marker.name, 
            marker.comment, 
            marker.id,
            marker.showCircle,
            marker.circleRadius
        );
        if (leafletMarker) {
            leafletMarkers.push(leafletMarker);
        }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ
    if (buildEnabled && activeHexes.size > 0) {
        updatePossibleHexes();
    }
}

function initBackground() {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π —Ñ–æ–Ω–∞
    const savedState = saveMapState();
    
    if (leafletMap) {
        leafletMap.off();
        leafletMap.remove();
        leafletMap = null;
    }
    
    // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤—ã –º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ñ–æ–Ω–∞
    leafletMarkers = [];
    tempMarker = null;
    previewCircle = null;
    
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = '';
    mapDiv.style.background = '';
    
    const selectedMode = document.getElementById('bgMode').value;
    bgMode = selectedMode;
    
    if (['osm', 'google-sat', 'google-hybrid', 'yandex-sat'].includes(selectedMode)) {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É
        leafletMap = L.map('map', {
            zoomControl: false,
            attributionControl: true,
            zoomAnimation: false,
            fadeAnimation: false,
            dragging: true // –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã
        });
        
        let baseLayer;
        if (selectedMode === 'osm') {
            baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            });
        } else if (selectedMode === 'google-sat') {
            baseLayer = googleSat;
        } else if (selectedMode === 'google-hybrid') {
            baseLayer = googleHybrid;
        } else if (selectedMode === 'yandex-sat') {
            baseLayer = yandexSat;
        }
        baseLayer.addTo(leafletMap);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–ª–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (savedState) {
            restoreMapState(savedState);
        } else {
            leafletMap.setView([54.7388, 55.9722], 12);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã
        leafletMap.on('move zoom', function() {
            draw();
        });
        
        // –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π
        leafletMap.dragging.enable();
        leafletMap.scrollWheelZoom.enable();
        
    } else if (selectedMode === 'image' && customImage) {
        mapDiv.style.background = `url(${customImage}) center/contain no-repeat`;
        // –î–ª—è —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∫–∏
        if (savedState) {
            gridCenterLat = savedState.gridCenterLat;
            gridCenterLng = savedState.gridCenterLng;
            activeHexes.clear();
            for (const [key, hex] of savedState.activeHexes) {
                activeHexes.set(key, hex);
            }
            bsMarkers = savedState.bsMarkers || [];
            if (buildEnabled && activeHexes.size > 0) {
                updatePossibleHexes();
            }
        }
    } else {
        mapDiv.style.background = '#0a0e14';
        // –î–ª—è –æ–¥–Ω–æ—Ç–æ–Ω–Ω–æ–≥–æ —Ñ–æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ç–∫–∏
        if (savedState) {
            gridCenterLat = savedState.gridCenterLat;
            gridCenterLng = savedState.gridCenterLng;
            activeHexes.clear();
            for (const [key, hex] of savedState.activeHexes) {
                activeHexes.set(key, hex);
            }
            bsMarkers = savedState.bsMarkers || [];
            if (buildEnabled && activeHexes.size > 0) {
                updatePossibleHexes();
            }
        }
    }
    
    draw();
}

function toggleBgMode() {
    document.getElementById('imageUpload').style.display =
        document.getElementById('bgMode').value === 'image' ? 'block' : 'none';
    initBackground();
}

document.getElementById('bgImage').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        customImage = ev.target.result;
        initBackground();
    };
    reader.readAsDataURL(file);
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawHexagon(ctx, centerX, centerY, radius, color = '#4af', lineWidth = 2, hexRotation = 0) {
    ctx.beginPath();
    for (let i = 0; i < 6; i++) {
        const angle = i * Math.PI / 3 - Math.PI / 2 + hexRotation;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.stroke();
}

function drawCenter(ctx, centerX, centerY, radius, color = '#f44') {
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
}

function drawCircle(ctx, centerX, centerY, radius, color = 'rgba(244,68,68,0.5)') {
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.strokeStyle = color;
    ctx.lineWidth = 1;
    ctx.stroke();
}

// –†–∏—Å–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Å–æ—Ç—ã (–∫–æ–≥–¥–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ –∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç)
function drawPreviewHex() {
    if (buildEnabled || activeHexes.size > 0) return;
    
    const gridCenterPx = getGridCenterInPixels();
    const radiusPx = getRadiusInPixels();
    const rotationCenter = getRotationCenter();
    
    // –¶–µ–Ω—Ç—Ä –±—É–¥—É—â–µ–π —Å–æ—Ç—ã (0,0)
    let centerX = gridCenterPx.x;
    let centerY = gridCenterPx.y;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    if (rotation !== 0) {
        const rotationCenterX = gridCenterPx.x + rotationCenter.x;
        const rotationCenterY = gridCenterPx.y + rotationCenter.y;
        const rotated = rotatePointAroundCenter(centerX, centerY, rotationCenterX, rotationCenterY, rotation);
        centerX = rotated.x;
        centerY = rotated.y;
    }
    
    // –†–∏—Å—É–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é —Å–æ—Ç—É (–ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—É—é)
    if (showHex) {
        ctx.globalAlpha = 0.3;
        drawHexagon(ctx, centerX, centerY, radiusPx, '#4af', 2, rotation * Math.PI / 180);
        ctx.globalAlpha = 1.0;
    }
    
    // –†–∏—Å—É–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä
    if (showCenters) {
        ctx.globalAlpha = 0.3;
        drawCenter(ctx, centerX, centerY, 4, '#f44');
        ctx.globalAlpha = 1.0;
    }
    
    // –†–∏—Å—É–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∫—Ä—É–≥
    if (showCircles) {
        ctx.globalAlpha = 0.3;
        drawCircle(ctx, centerX, centerY, radiusPx, 'rgba(244,68,68,0.3)');
        ctx.globalAlpha = 1.0;
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ–π —Å–µ—Ç–∫–∏ –∫–∞–∫ –µ–¥–∏–Ω–æ–≥–æ —Å–ª–æ—è
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawGrid() {
    const gridCenterPx = getGridCenterInPixels();
    
    // –†–∏—Å—É–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã (—Å–µ—Ä—ã–µ) - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏
    if (buildEnabled) {
        for (const hex of possibleHexes.values()) {
            const screenPos = getHexScreenPosition(hex.q, hex.r);
            const { x, y, radius: currentRadius } = screenPos;
            
            // –®–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ—Ç —Å —É—á–µ—Ç–æ–º –≤—Ä–∞—â–µ–Ω–∏—è
            if (showHex) {
                drawHexagon(ctx, x, y, currentRadius, '#888', 1.5, rotation * Math.PI / 180);
            }
            
            // –¶–µ–Ω—Ç—Ä—ã –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ—Ç
            if (showCenters) {
                drawCenter(ctx, x, y, 3, '#888');
            }
            
            // –ö—Ä—É–≥–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ—Ç
            if (showCircles) {
                drawCircle(ctx, x, y, currentRadius, 'rgba(136,136,136,0.5)');
            }
        }
    }
    
    // –†–∏—Å—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Ç—ã (—Å–∏–Ω–∏–µ)
    for (const hex of activeHexes.values()) {
        const screenPos = getHexScreenPosition(hex.q, hex.r);
        const { x, y, radius: currentRadius } = screenPos;
        
        // –®–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç —Å —É—á–µ—Ç–æ–º –≤—Ä–∞—â–µ–Ω–∏—è
        if (showHex) {
            drawHexagon(ctx, x, y, currentRadius, '#4af', 2, rotation * Math.PI / 180);
        }
        
        // –¶–µ–Ω—Ç—Ä—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç
        if (showCenters) {
            drawCenter(ctx, x, y, 4, '#f44');
        }
        
        // –ö—Ä—É–≥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç
        if (showCircles) {
            drawCircle(ctx, x, y, currentRadius, 'rgba(244,68,68,0.5)');
        }
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if ((!leafletMap && bgMode !== 'image') || (activeHexes.size === 0 && !buildEnabled && !moveGridEnabled && !bsModeEnabled)) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –∫–∞—Ä—Ç—ã –∏–ª–∏ —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∏—Å—É–µ–º
        if (!leafletMap && bgMode !== 'image') return;
        
        // –†–∏—Å—É–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é —Å–æ—Ç—É, –µ—Å–ª–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ –∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç
        drawPreviewHex();
        return;
    }
    
    // –†–∏—Å—É–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é —Å–æ—Ç—É, –µ—Å–ª–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ –∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç
    if (!buildEnabled && activeHexes.size === 0) {
        drawPreviewHex();
    }
    
    // –†–∏—Å—É–µ–º –≤—Å—é —Å–µ—Ç–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Ç—ã –∏–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ)
    if (activeHexes.size > 0 || buildEnabled) {
        drawGrid();
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('radiusSlider').oninput = function() {
    document.getElementById('radiusText').value = this.value;
    applyRadius();
};

document.getElementById('radiusText').addEventListener('blur', function() {
    applyRadius();
});

document.getElementById('radiusText').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        applyRadius();
    }
});

document.getElementById('rotSlider').oninput = function() {
    document.getElementById('rotText').value = this.value;
    applyRotation();
};

document.getElementById('rotText').addEventListener('blur', function() {
    applyRotation();
});

document.getElementById('rotText').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        applyRotation();
    }
});

document.getElementById('moveGrid').onchange = function() {
    moveGridEnabled = this.checked;
    canvas.style.pointerEvents = (buildEnabled || moveGridEnabled) ? 'auto' : 'none';
    updateCursor();
    
    // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ—Ç–∫–ª—é—á–∞–µ–º/–≤–∫–ª—é—á–∞–µ–º –µ—ë —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    if (leafletMap) {
        if (moveGridEnabled) {
            leafletMap.dragging.disable();
            leafletMap.scrollWheelZoom.disable();
        } else {
            leafletMap.dragging.enable();
            leafletMap.scrollWheelZoom.enable();
        }
    }
    
    draw();
};

document.getElementById('showHex').onchange = function() {
    showHex = this.checked;
    draw();
};

document.getElementById('showCenters').onchange = function() {
    showCenters = this.checked;
    draw();
};

document.getElementById('showCircles').onchange = function() {
    showCircles = this.checked;
    draw();
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞–¥–∏—É—Å–∞ –ë–° –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
document.getElementById('markerShowCircle').onchange = function() {
    const circleControls = document.getElementById('markerCircleControls');
    circleControls.style.display = this.checked ? 'block' : 'none';
    
    // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è –ë–° –∏ –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    if (currentMarkerData && tempMarker) {
        const showCircle = this.checked;
        const circleRadius = parseInt(document.getElementById('markerCircleText').value) || 500;
        
        if (showCircle) {
            updatePreviewCircle(currentMarkerData.lat, currentMarkerData.lng, circleRadius);
        } else {
            removePreviewCircle();
        }
    }
    
    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ä–∫–µ—Ä - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if (editingMarkerId) {
        const markerIndex = leafletMarkers.findIndex(m => m.id === editingMarkerId);
        if (markerIndex !== -1) {
            leafletMarkers[markerIndex].showCircle = this.checked;
            updateMarkerCircle(leafletMarkers[markerIndex]);
        }
    }
};

document.getElementById('markerCircleSlider').oninput = function() {
    const value = this.value;
    document.getElementById('markerCircleText').value = value;
    
    // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è –ë–° –∏ –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    if (currentMarkerData && tempMarker && document.getElementById('markerShowCircle').checked) {
        updatePreviewCircle(currentMarkerData.lat, currentMarkerData.lng, parseInt(value));
    }
    
    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ä–∫–µ—Ä - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if (editingMarkerId) {
        const markerIndex = leafletMarkers.findIndex(m => m.id === editingMarkerId);
        if (markerIndex !== -1) {
            leafletMarkers[markerIndex].circleRadius = parseInt(value);
            updateMarkerCircle(leafletMarkers[markerIndex]);
        }
    }
};

document.getElementById('markerCircleText').addEventListener('blur', function() {
    const value = parseInt(this.value) || 500;
    const clampedValue = Math.max(10, Math.min(5000, value));
    this.value = clampedValue;
    document.getElementById('markerCircleSlider').value = clampedValue;
    
    // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è –ë–° –∏ –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    if (currentMarkerData && tempMarker && document.getElementById('markerShowCircle').checked) {
        updatePreviewCircle(currentMarkerData.lat, currentMarkerData.lng, clampedValue);
    }
    
    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ä–∫–µ—Ä - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if (editingMarkerId) {
        const markerIndex = leafletMarkers.findIndex(m => m.id === editingMarkerId);
        if (markerIndex !== -1) {
            leafletMarkers[markerIndex].circleRadius = clampedValue;
            updateMarkerCircle(leafletMarkers[markerIndex]);
        }
    }
});

document.getElementById('markerCircleText').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const value = parseInt(this.value) || 500;
        const clampedValue = Math.max(10, Math.min(5000, value));
        this.value = clampedValue;
        document.getElementById('markerCircleSlider').value = clampedValue;
        
        // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è –ë–° –∏ –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        if (currentMarkerData && tempMarker && document.getElementById('markerShowCircle').checked) {
            updatePreviewCircle(currentMarkerData.lat, currentMarkerData.lng, clampedValue);
        }
        
        // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ä–∫–µ—Ä - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (editingMarkerId) {
            const markerIndex = leafletMarkers.findIndex(m => m.id === editingMarkerId);
            if (markerIndex !== -1) {
                leafletMarkers[markerIndex].circleRadius = clampedValue;
                updateMarkerCircle(leafletMarkers[markerIndex]);
            }
        }
    }
});

function reset() {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ–Ω–∞
    const currentBgMode = document.getElementById('bgMode').value;
    const currentCustomImage = customImage;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ç–∫–∏ –∏ –º–∞—Ä–∫–µ—Ä—ã
    radiusMeters = 500;
    rotation = 0;
    buildEnabled = false;
    bsModeEnabled = false;
    moveGridEnabled = false;
    gridCenterLat = null;
    gridCenterLng = null;
    activeHexes.clear();
    possibleHexes.clear();
    showHex = true;
    showCenters = true;
    showCircles = false;
    
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã
    clearMarkers();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    document.getElementById('buildToggle').textContent = '–°—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ—Ç–∏';
    document.getElementById('buildToggle').classList.remove('active');
    document.getElementById('bsToggle').textContent = '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ë–°';
    document.getElementById('bsToggle').classList.remove('active');
    document.getElementById('moveGrid').checked = false;
    document.getElementById('showHex').checked = true;
    document.getElementById('showCenters').checked = true;
    document.getElementById('showCircles').checked = false;
    document.getElementById('radiusText').value = '500';
    document.getElementById('rotText').value = '0';
    document.getElementById('radiusSlider').value = 500;
    document.getElementById('rotSlider').min = -180;
    document.getElementById('rotSlider').max = 180;
    document.getElementById('rotSlider').value = 0;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä
    canvas.style.pointerEvents = 'none';
    document.body.classList.remove('bs-cursor');
    updateCursor();
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω (–Ω–µ –∏–∑–º–µ–Ω—è–µ–º –≤—ã–±–æ—Ä –≤ —Å–µ–ª–µ–∫—Ç–µ)
    if (currentBgMode === 'image' && currentCustomImage) {
        customImage = currentCustomImage;
        document.getElementById('bgMode').value = currentBgMode;
    }
    
    // –í–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
    if (leafletMap) {
        leafletMap.dragging.enable();
        leafletMap.scrollWheelZoom.enable();
    }
    
    draw();
}

window.onresize = resize;
window.onload = () => {
    resize();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    document.getElementById('radiusSlider').min = 10;
    document.getElementById('radiusSlider').max = 5000;
    document.getElementById('radiusSlider').value = 500;
    document.getElementById('radiusSlider').step = 10;
    
    document.getElementById('rotSlider').min = -180;
    document.getElementById('rotSlider').max = 180;
    document.getElementById('rotSlider').value = 0;
    document.getElementById('rotSlider').step = 1;
    
    document.getElementById('radiusText').value = '500';
    document.getElementById('rotText').value = '0';
    document.getElementById('moveGrid').checked = false;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–¥–∏—É—Å–∞ –ë–°
    document.getElementById('markerCircleSlider').min = 10;
    document.getElementById('markerCircleSlider').max = 5000;
    document.getElementById('markerCircleSlider').value = 500;
    document.getElementById('markerCircleSlider').step = 10;
    document.getElementById('markerCircleText').value = '500';
    
    initBackground();
};
</script>
</body>
</html>