<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–æ—Ç–æ–≤–æ–π —Å–µ—Ç–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì°</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin:0; padding:0; height:100vh; overflow:hidden; background:#0a0e14; font-family:system-ui,sans-serif; color:#ddd; }
        #map { position:absolute; inset:0; z-index:0; }
        #c { position:absolute; inset:0; z-index:1; image-rendering:crisp-edges; pointer-events:none; }
        #controls {
            position:absolute; top:12px; left:12px; z-index:10;
            background:rgba(20,25,35,0.92); padding:16px; border-radius:10px;
            min-width:340px; box-shadow:0 4px 18px #0006;
        }
        label { display:block; margin:10px 0 4px; font-size:0.9em; }
        input[type=text], input[type=file], select {
            width:100%; padding:8px 10px; border-radius:6px;
            border:1px solid #3a4454; background:#1a2230; color:white;
            box-sizing:border-box;
        }
        input[type=range] { width:100%; margin:4px 0 10px 0; }
        .row { margin:12px 0; }
        button {
            margin-top:8px; padding:8px 16px;
            background:#2a3444; color:#ddd; border:none; border-radius:6px;
            cursor:pointer;
        }
        button:hover { background:#3a4454; }
        button.active { background:#4af; color:#000; }
        .checkbox-row { margin:8px 0; display:flex; align-items:center; gap:8px; }
    </style>
</head>
<body>
<div id="map"></div>
<canvas id="c"></canvas>
<div id="controls">
    <label for="bgMode">–§–æ–Ω / –∫–∞—Ä—Ç–∞:</label>
    <select id="bgMode" onchange="toggleBgMode()">
        <option value="osm">OpenStreetMap</option>
        <option value="google-sat">Google –°–ø—É—Ç–Ω–∏–∫</option>
        <option value="google-hybrid">Google –ì–∏–±—Ä–∏–¥</option>
        <option value="yandex-sat">–Ø–Ω–¥–µ–∫—Å –°–ø—É—Ç–Ω–∏–∫</option>
        <option value="image">–°–≤–æ—ë –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
    </select>
    <div id="imageUpload" style="display:none; margin-top:10px;">
        <label for="bgImage">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
        <input type="file" id="bgImage" accept="image/*">
    </div>
    <button id="buildToggle" onclick="toggleBuild()">–í–∫–ª—é—á–∏—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ</button>
    <div class="row">
        <label>–†–∞–¥–∏—É—Å (10‚Ä¶3000 –º–µ—Ç—Ä–æ–≤):</label>
        <input type="range" id="radiusSlider" min="10" max="3000" value="500">
        <input type="text" id="radiusText" value="500">
    </div>
    <div class="row">
        <label>–í—Ä–∞—â–µ–Ω–∏–µ (-180‚Ä¶+180¬∞):</label>
        <input type="range" id="rotSlider" min="-180" max="180" value="0">
        <input type="text" id="rotText" value="0">
    </div>
    <div class="checkbox-row">
        <input type="checkbox" id="moveGrid"><label for="moveGrid">–ü–µ—Ä–µ–º–µ—â–∞—Ç—å —Å–µ—Ç–∫—É</label>
    </div>
    <div class="checkbox-row">
        <input type="checkbox" id="showHex" checked><label for="showHex">–°–æ—Ç—ã</label>
    </div>
    <div class="checkbox-row">
        <input type="checkbox" id="showCenters" checked><label for="showCenters">–¶–µ–Ω—Ç—Ä—ã</label>
    </div>
    <div class="checkbox-row">
        <input type="checkbox" id="showCircles"><label for="showCircles">–†–∞–¥–∏—É—Å—ã</label>
    </div>
    <button onclick="reset()">–°–±—Ä–æ—Å</button>
</div>
<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let leafletMap = null;
let customImage = null;
let bgMode = 'osm';
let radiusMeters = 500; // –†–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö
let rotation = 0; // –í—Ä–∞—â–µ–Ω–∏–µ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
let showHex = true;
let showCenters = true;
let showCircles = false;
let buildEnabled = false;
let moveGridEnabled = false; // –†–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å–µ—Ç–∫–∏
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;
let gridOffsetX = 0;
let gridOffsetY = 0;

// –¶–µ–Ω—Ç—Ä —Å–µ—Ç–∫–∏ –≤ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
let gridCenterLat = null;
let gridCenterLng = null;

// –•—Ä–∞–Ω–∏–º —Å–µ—Ç–∫—É –≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (q, r) –≥–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω–æ–π —Å–µ—Ç–∫–∏
let activeHexes = new Map(); // –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Ç—ã: –∫–ª—é—á = "q,r", –∑–Ω–∞—á–µ–Ω–∏–µ = {q, r}
let possibleHexes = new Map(); // –í–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã: –∫–ª—é—á = "q,r", –∑–Ω–∞—á–µ–Ω–∏–µ = {q, r}

// –ì–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—à–µ—Å—Ç—å —Å–æ—Å–µ–¥–µ–π)
const hexDirections = [
    { q: 1, r: 0 },   // –í–ø—Ä–∞–≤–æ
    { q: 1, r: -1 },  // –í–ø—Ä–∞–≤–æ-–≤–≤–µ—Ä—Ö
    { q: 0, r: -1 },  // –í–ª–µ–≤–æ-–≤–≤–µ—Ä—Ö
    { q: -1, r: 0 },  // –í–ª–µ–≤–æ
    { q: -1, r: 1 },  // –í–ª–µ–≤–æ-–≤–Ω–∏–∑
    { q: 0, r: 1 }    // –í–ø—Ä–∞–≤–æ-–≤–Ω–∏–∑
];

// –°–ª–æ–∏ –∫–∞—Ä—Ç—ã
const googleSat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '¬© Google'
});
const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '¬© Google'
});
const yandexSat = L.tileLayer('https://core-sat.maps.yandex.net/tiles?l=sat&v=23.10.26-0&x={x}&y={y}&z={z}&scale=1&lang=ru_RU', {
    maxZoom: 19, attribution: '¬© –Ø–Ω–¥–µ–∫—Å'
});

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–¥–∏—É—Å–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –Ω–∞ —Ç–µ–∫—É—â–µ–º –∑—É–º–µ
function getRadiusInPixels() {
    if (!leafletMap) return radiusMeters; // –î–ª—è —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ—Ç—Ä—ã –∫–∞–∫ –ø–∏–∫—Å–µ–ª–∏
    
    // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—Ç—Ä —Å–µ—Ç–∫–∏
    const center = leafletMap.latLngToContainerPoint([gridCenterLat, gridCenterLng]);
    
    // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫—É –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ radiusMeters –∫ –≤–æ—Å—Ç–æ–∫—É –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
    const degreesPerMeter = 1 / (111111 * Math.cos(gridCenterLat * Math.PI / 180));
    const eastPoint = L.latLng(gridCenterLat, gridCenterLng + radiusMeters * degreesPerMeter);
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–∏–∫—Å–µ–ª–∏
    const eastPx = leafletMap.latLngToContainerPoint(eastPoint);
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
    return Math.abs(eastPx.x - center.x);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Å–µ—Ç–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
function getGridCenterInPixels() {
    if (leafletMap && gridCenterLat !== null && gridCenterLng !== null) {
        const centerPx = leafletMap.latLngToContainerPoint([gridCenterLat, gridCenterLng]);
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        return { 
            x: centerPx.x + gridOffsetX, 
            y: centerPx.y + gridOffsetY 
        };
    } else {
        return { 
            x: canvas.width / 2 + gridOffsetX, 
            y: canvas.height / 2 + gridOffsetY 
        };
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç
function getActiveGridCenter() {
    if (activeHexes.size === 0) {
        return { x: 0, y: 0 };
    }
    
    let sumX = 0;
    let sumY = 0;
    let count = 0;
    
    for (const hex of activeHexes.values()) {
        const relativeCoords = hexToRelativeCoords(hex.q, hex.r);
        sumX += relativeCoords.x;
        sumY += relativeCoords.y;
        count++;
    }
    
    return {
        x: sumX / count,
        y: sumY / count
    };
}

// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≥–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (q, r) –≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
function hexToRelativeCoords(q, r) {
    const radiusPx = getRadiusInPixels();
    const height = Math.sqrt(3) * radiusPx;
    const x = height * (q + r / 2);
    const y = radiusPx * 1.5 * r;
    return { x, y, radius: radiusPx };
}

// –í—Ä–∞—â–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞
function rotatePointAroundCenter(pointX, pointY, centerX, centerY, angle) {
    const rad = angle * Math.PI / 180;
    const cos = Math.cos(rad);
    const sin = Math.sin(rad);
    
    // –°–º–µ—â–∞–µ–º —Ç–æ—á–∫—É –≤ –Ω–∞—á–∞–ª–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    const x = pointX - centerX;
    const y = pointY - centerY;
    
    // –í—Ä–∞—â–∞–µ–º
    const xRotated = x * cos - y * sin;
    const yRotated = x * sin + y * cos;
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –º–µ—Å—Ç–æ
    return {
        x: xRotated + centerX,
        y: yRotated + centerY
    };
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.pointerEvents = (buildEnabled || moveGridEnabled) ? 'auto' : 'none';
    draw();
}

function parseNum(str, fallback = 0) {
    if (!str.trim()) return fallback;
    const cleaned = str.trim().replace(',', '.');
    const num = parseFloat(cleaned);
    return isNaN(num) ? fallback : num;
}

function applyRadius() {
    const slider = document.getElementById('radiusSlider');
    const text = document.getElementById('radiusText');
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ
    if (text.value !== slider.value) {
        radiusMeters = parseNum(text.value, radiusMeters);
    } else {
        radiusMeters = parseFloat(slider.value) || radiusMeters;
    }
    
    radiusMeters = Math.max(10, Math.min(3000, radiusMeters));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
    slider.value = radiusMeters;
    text.value = Math.round(radiusMeters * 100) / 100;
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –Ω–æ–≤—ã–º —Ä–∞–¥–∏—É—Å–æ–º
    if (buildEnabled && activeHexes.size > 0) {
        updatePossibleHexes();
    }
    draw();
}

function applyRotation() {
    const slider = document.getElementById('rotSlider');
    const text = document.getElementById('rotText');
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ
    if (text.value !== slider.value) {
        rotation = parseNum(text.value, rotation);
    } else {
        rotation = parseFloat(slider.value) || rotation;
    }
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª –≤ –¥–∏–∞–ø–∞–∑–æ–Ω -180..180
    while (rotation < -180) rotation += 360;
    while (rotation > 180) rotation -= 360;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
    const displayRotation = rotation;
    slider.value = displayRotation;
    text.value = Math.round(displayRotation * 100) / 100;
    
    draw();
}

function toggleBuild() {
    buildEnabled = !buildEnabled;
    const btn = document.getElementById('buildToggle');
    btn.textContent = buildEnabled ? '–í—ã–∫–ª—é—á–∏—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ' : '–í–∫–ª—é—á–∏—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ';
    btn.classList.toggle('active', buildEnabled);
    canvas.style.pointerEvents = (buildEnabled || moveGridEnabled) ? 'auto' : 'none';
    
    if (buildEnabled && ((leafletMap && gridCenterLat === null && gridCenterLng === null) || (!leafletMap && gridCenterLat === null))) {
        if (leafletMap) {
            const center = leafletMap.getCenter();
            gridCenterLat = center.lat;
            gridCenterLng = center.lng;
        } else {
            // –î–ª—è —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä –∫–∞–Ω–≤–∞—Å–∞
            gridCenterLat = 0;
            gridCenterLng = 0;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Å–æ—Ç—É (0,0)
        activeHexes.set("0,0", { q: 0, r: 0 });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã
        updatePossibleHexes();
    } else if (!buildEnabled) {
        // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã
        possibleHexes.clear();
    } else if (buildEnabled && activeHexes.size > 0) {
        // –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤–∫–ª—é—á–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã
        updatePossibleHexes();
    }
    
    draw();
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ—Å–µ–¥–µ–π –≥–µ–∫—Å–∞–≥–æ–Ω–∞
function getHexNeighbors(q, r) {
    return hexDirections.map(dir => ({
        q: q + dir.q,
        r: r + dir.r
    }));
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ—Ç
function updatePossibleHexes() {
    if (!buildEnabled || activeHexes.size === 0) {
        possibleHexes.clear();
        return;
    }
    
    possibleHexes.clear();
    
    // –î–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π —Å–æ—Ç—ã –ø–æ–ª—É—á–∞–µ–º –µ—ë —Å–æ—Å–µ–¥–µ–π
    for (const hex of activeHexes.values()) {
        const neighbors = getHexNeighbors(hex.q, hex.r);
        
        for (const neighbor of neighbors) {
            const key = `${neighbor.q},${neighbor.r}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–∞ —Å–æ—Ç–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ–π
            if (!activeHexes.has(key) && !possibleHexes.has(key)) {
                possibleHexes.set(key, neighbor);
            }
        }
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ü–µ–Ω—Ç—Ä–∞ —Å–æ—Ç—ã
function getHexScreenPosition(q, r) {
    const gridCenterPx = getGridCenterInPixels();
    const relativeCoords = hexToRelativeCoords(q, r);
    const activeGridCenter = getActiveGridCenter();
    
    // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ç–∫–∏
    let x = gridCenterPx.x + relativeCoords.x;
    let y = gridCenterPx.y + relativeCoords.y;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –≤—Å–µ–π —Å–µ—Ç–∫–∏ –≤–æ–∫—Ä—É–≥ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç
    if (rotation !== 0) {
        const centerX = gridCenterPx.x + activeGridCenter.x;
        const centerY = gridCenterPx.y + activeGridCenter.y;
        const rotated = rotatePointAroundCenter(x, y, centerX, centerY, rotation);
        x = rotated.x;
        y = rotated.y;
    }
    
    return { 
        x, 
        y,
        radius: relativeCoords.radius
    };
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞
function isPointInHexagon(px, py, hexX, hexY, hexRadius) {
    // –í—Ä–∞—â–∞–µ–º —Ç–æ—á–∫—É –∫–ª–∏–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –Ω–µ–≤—Ä–∞—â–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    const gridCenterPx = getGridCenterInPixels();
    const activeGridCenter = getActiveGridCenter();
    
    if (rotation !== 0) {
        const centerX = gridCenterPx.x + activeGridCenter.x;
        const centerY = gridCenterPx.y + activeGridCenter.y;
        
        // –í—Ä–∞—â–∞–µ–º —Ç–æ—á–∫—É –∫–ª–∏–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —É–≥–æ–ª)
        const unrotatedPoint = rotatePointAroundCenter(px, py, centerX, centerY, -rotation);
        px = unrotatedPoint.x;
        py = unrotatedPoint.y;
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ —Å–æ—Ç—ã –±–µ–∑ –≤—Ä–∞—â–µ–Ω–∏—è
        const unrotatedCenter = rotatePointAroundCenter(hexX, hexY, centerX, centerY, -rotation);
        hexX = unrotatedCenter.x;
        hexY = unrotatedCenter.y;
    }
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞
    const dx = px - hexX;
    const dy = py - hexY;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞
    const distance = Math.sqrt(dx * dx + dy * dy);
    if (distance > hexRadius) return false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≥–æ–ª –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –≥—Ä–∞–Ω–µ–π
    // –£–≥–æ–ª —Ç–æ—á–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞
    let angle = Math.atan2(dy, dx);
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª –æ—Ç 0 –¥–æ 2œÄ
    if (angle < 0) angle += 2 * Math.PI;
    
    // –ù–∞—Ö–æ–¥–∏–º, –∫ –∫–∞–∫–æ–π –≥—Ä–∞–Ω–∏ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞ –±–ª–∏–∂–µ —Ç–æ—á–∫–∞
    const segmentAngle = Math.PI / 3; // 60 –≥—Ä–∞–¥—É—Å–æ–≤
    const segment = Math.floor(angle / segmentAngle);
    
    // –£–≥–æ–ª –≤–Ω—É—Ç—Ä–∏ —Å–µ–≥–º–µ–Ω—Ç–∞
    const segmentStart = segment * segmentAngle;
    const segmentEnd = segmentStart + segmentAngle;
    const angleInSegment = angle - segmentStart;
    
    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –≥—Ä–∞–Ω–∏ –≤ —ç—Ç–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ
    const maxDistance = hexRadius * Math.cos(segmentAngle / 2 - angleInSegment) / Math.cos(segmentAngle / 2);
    
    return distance <= maxDistance;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞–Ω–≤–∞—Å—É
canvas.addEventListener('click', function(e) {
    if (!buildEnabled && !moveGridEnabled) return;
    
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    
    // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å–æ—Ç–∞–º
    if (buildEnabled) {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–æ—Ç–µ (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)
        let clickedActiveHex = null;
        for (const hex of activeHexes.values()) {
            const screenPos = getHexScreenPosition(hex.q, hex.r);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞
            if (isPointInHexagon(clickX, clickY, screenPos.x, screenPos.y, screenPos.radius)) {
                clickedActiveHex = hex;
                break;
            }
        }
        
        // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–æ—Ç–µ - —É–¥–∞–ª—è–µ–º –µ—ë
        if (clickedActiveHex) {
            // –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–æ—Ç—É
            if (activeHexes.size > 1) {
                const key = `${clickedActiveHex.q},${clickedActiveHex.r}`;
                activeHexes.delete(key);
                updatePossibleHexes();
                draw();
            }
            return;
        }
        
        // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–µ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–æ—Ç–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã (–¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)
        if (possibleHexes.size === 0) return;
        
        let clickedPossibleHex = null;
        for (const hex of possibleHexes.values()) {
            const screenPos = getHexScreenPosition(hex.q, hex.r);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞
            if (isPointInHexagon(clickX, clickY, screenPos.x, screenPos.y, screenPos.radius)) {
                clickedPossibleHex = hex;
                break;
            }
        }
        
        if (clickedPossibleHex) {
            const key = `${clickedPossibleHex.q},${clickedPossibleHex.r}`;
            activeHexes.set(key, clickedPossibleHex);
            updatePossibleHexes();
            draw();
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Å–µ—Ç–∫–∏
canvas.addEventListener('mousedown', function(e) {
    if (!moveGridEnabled || activeHexes.size === 0) return;
    
    const rect = canvas.getBoundingClientRect();
    dragStartX = e.clientX - rect.left;
    dragStartY = e.clientY - rect.top;
    isDragging = true;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
    e.preventDefault();
});

canvas.addEventListener('mousemove', function(e) {
    if (!isDragging || !moveGridEnabled) return;
    
    const rect = canvas.getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ
    gridOffsetX += currentX - dragStartX;
    gridOffsetY += currentY - dragStartY;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    dragStartX = currentX;
    dragStartY = currentY;
    
    draw();
});

canvas.addEventListener('mouseup', function() {
    isDragging = false;
});

canvas.addEventListener('mouseleave', function() {
    isDragging = false;
});

function initBackground() {
    if (leafletMap) {
        leafletMap.off();
        leafletMap.remove();
        leafletMap = null;
    }
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = '';
    mapDiv.style.background = '';
    const selectedMode = document.getElementById('bgMode').value;
    bgMode = selectedMode;
    
    if (['osm', 'google-sat', 'google-hybrid', 'yandex-sat'].includes(selectedMode)) {
        leafletMap = L.map('map', {
            zoomControl: false,
            attributionControl: true,
            zoomAnimation: false,
            fadeAnimation: false
        }).setView([54.7388, 55.9722], 12);
        let baseLayer;
        if (selectedMode === 'osm') {
            baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            });
        } else if (selectedMode === 'google-sat') {
            baseLayer = googleSat;
        } else if (selectedMode === 'google-hybrid') {
            baseLayer = googleHybrid;
        } else if (selectedMode === 'yandex-sat') {
            baseLayer = yandexSat;
        }
        baseLayer.addTo(leafletMap);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã
        leafletMap.on('move zoom', function() {
            draw();
        });
    } else if (selectedMode === 'image' && customImage) {
        mapDiv.style.background = `url(${customImage}) center/contain no-repeat`;
    } else {
        mapDiv.style.background = '#0a0e14';
    }
    draw();
}

function toggleBgMode() {
    document.getElementById('imageUpload').style.display =
        document.getElementById('bgMode').value === 'image' ? 'block' : 'none';
    initBackground();
}

document.getElementById('bgImage').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        customImage = ev.target.result;
        initBackground();
    };
    reader.readAsDataURL(file);
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawHexagon(ctx, centerX, centerY, radius, color = '#4af', lineWidth = 2, hexRotation = 0) {
    ctx.beginPath();
    for (let i = 0; i < 6; i++) {
        const angle = i * Math.PI / 3 - Math.PI / 2 + hexRotation;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.stroke();
}

function drawCenter(ctx, centerX, centerY, radius, color = '#f44') {
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
}

function drawCircle(ctx, centerX, centerY, radius, color = 'rgba(244,68,68,0.5)') {
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.strokeStyle = color;
    ctx.lineWidth = 1;
    ctx.stroke();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ–π —Å–µ—Ç–∫–∏ –∫–∞–∫ –µ–¥–∏–Ω–æ–≥–æ —Å–ª–æ—è
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawGrid() {
    const gridCenterPx = getGridCenterInPixels();
    const activeGridCenter = getActiveGridCenter();
    
    // –†–∏—Å—É–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Ç—ã (—Å–µ—Ä—ã–µ) - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏
    if (buildEnabled) {
        for (const hex of possibleHexes.values()) {
            const relativeCoords = hexToRelativeCoords(hex.q, hex.r);
            let x = gridCenterPx.x + relativeCoords.x;
            let y = gridCenterPx.y + relativeCoords.y;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –≤—Å–µ–π —Å–µ—Ç–∫–∏ –≤–æ–∫—Ä—É–≥ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞
            if (rotation !== 0) {
                const centerX = gridCenterPx.x + activeGridCenter.x;
                const centerY = gridCenterPx.y + activeGridCenter.y;
                const rotated = rotatePointAroundCenter(x, y, centerX, centerY, rotation);
                x = rotated.x;
                y = rotated.y;
            }
            
            // –®–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ—Ç —Å —É—á–µ—Ç–æ–º –≤—Ä–∞—â–µ–Ω–∏—è
            if (showHex) {
                drawHexagon(ctx, x, y, relativeCoords.radius, '#888', 1.5, rotation * Math.PI / 180);
            }
            
            // –¶–µ–Ω—Ç—Ä—ã –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ—Ç
            if (showCenters) {
                drawCenter(ctx, x, y, 3, '#888');
            }
            
            // –ö—Ä—É–≥–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–æ—Ç
            if (showCircles) {
                drawCircle(ctx, x, y, relativeCoords.radius, 'rgba(136,136,136,0.5)');
            }
        }
    }
    
    // –†–∏—Å—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Ç—ã (—Å–∏–Ω–∏–µ)
    for (const hex of activeHexes.values()) {
        const relativeCoords = hexToRelativeCoords(hex.q, hex.r);
        let x = gridCenterPx.x + relativeCoords.x;
        let y = gridCenterPx.y + relativeCoords.y;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –≤—Å–µ–π —Å–µ—Ç–∫–∏ –≤–æ–∫—Ä—É–≥ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞
        if (rotation !== 0) {
            const centerX = gridCenterPx.x + activeGridCenter.x;
            const centerY = gridCenterPx.y + activeGridCenter.y;
            const rotated = rotatePointAroundCenter(x, y, centerX, centerY, rotation);
            x = rotated.x;
            y = rotated.y;
        }
        
        // –®–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç —Å —É—á–µ—Ç–æ–º –≤—Ä–∞—â–µ–Ω–∏—è
        if (showHex) {
            drawHexagon(ctx, x, y, relativeCoords.radius, '#4af', 2, rotation * Math.PI / 180);
        }
        
        // –¶–µ–Ω—Ç—Ä—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç
        if (showCenters) {
            drawCenter(ctx, x, y, 4, '#f44');
        }
        
        // –ö—Ä—É–≥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç
        if (showCircles) {
            drawCircle(ctx, x, y, relativeCoords.radius, 'rgba(244,68,68,0.5)');
        }
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if ((!leafletMap && bgMode !== 'image') || (activeHexes.size === 0 && !buildEnabled)) return;
    
    // –†–∏—Å—É–µ–º –≤—Å—é —Å–µ—Ç–∫—É
    drawGrid();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('radiusSlider').oninput = function() {
    document.getElementById('radiusText').value = this.value;
    applyRadius();
};

document.getElementById('radiusText').addEventListener('blur', function() {
    applyRadius();
});

document.getElementById('radiusText').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        applyRadius();
    }
});

document.getElementById('rotSlider').oninput = function() {
    document.getElementById('rotText').value = this.value;
    applyRotation();
};

document.getElementById('rotText').addEventListener('blur', function() {
    applyRotation();
});

document.getElementById('rotText').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        applyRotation();
    }
});

document.getElementById('moveGrid').onchange = function() {
    moveGridEnabled = this.checked;
    canvas.style.pointerEvents = (buildEnabled || moveGridEnabled) ? 'auto' : 'none';
    draw();
};

document.getElementById('showHex').onchange = function() {
    showHex = this.checked;
    draw();
};

document.getElementById('showCenters').onchange = function() {
    showCenters = this.checked;
    draw();
};

document.getElementById('showCircles').onchange = function() {
    showCircles = this.checked;
    draw();
};

function reset() {
    radiusMeters = 500;
    rotation = 0;
    buildEnabled = false;
    moveGridEnabled = false;
    gridCenterLat = null;
    gridCenterLng = null;
    gridOffsetX = 0;
    gridOffsetY = 0;
    activeHexes.clear();
    possibleHexes.clear();
    showHex = true;
    showCenters = true;
    showCircles = false;
    
    document.getElementById('buildToggle').textContent = '–í–∫–ª—é—á–∏—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ';
    document.getElementById('buildToggle').classList.remove('active');
    document.getElementById('moveGrid').checked = false;
    document.getElementById('showHex').checked = true;
    document.getElementById('showCenters').checked = true;
    document.getElementById('showCircles').checked = false;
    document.getElementById('bgMode').value = 'osm';
    document.getElementById('bgImage').value = '';
    document.getElementById('radiusText').value = '500';
    document.getElementById('rotText').value = '0';
    document.getElementById('radiusSlider').value = 500;
    document.getElementById('rotSlider').min = -180;
    document.getElementById('rotSlider').max = 180;
    document.getElementById('rotSlider').value = 0;
    canvas.style.pointerEvents = 'none';
    
    initBackground();
}

window.onresize = resize;
window.onload = () => {
    resize();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    document.getElementById('radiusSlider').min = 10;
    document.getElementById('radiusSlider').max = 3000;
    document.getElementById('radiusSlider').value = 500;
    document.getElementById('radiusSlider').step = 10;
    
    document.getElementById('rotSlider').min = -180;
    document.getElementById('rotSlider').max = 180;
    document.getElementById('rotSlider').value = 0;
    document.getElementById('rotSlider').step = 1;
    
    document.getElementById('radiusText').value = '500';
    document.getElementById('rotText').value = '0';
    document.getElementById('moveGrid').checked = false;
    
    initBackground();
};
</script>
</body>
</html>