<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–æ—Ç–æ–≤–æ–π —Å–µ—Ç–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì°</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin:0; padding:0; height:100vh; overflow:hidden; background:#0a0e14; font-family:system-ui,sans-serif; color:#ddd; }
        #map { position:absolute; inset:0; z-index:0; }
        #c { position:absolute; inset:0; z-index:1; image-rendering:crisp-edges; pointer-events:none; }
        #controls {
            position:absolute; top:12px; left:12px; z-index:10;
            background:rgba(20,25,35,0.92); padding:12px; border-radius:8px;
            width:300px; box-shadow:0 4px 12px #0006;
            max-height: 95vh;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        #controls::-webkit-scrollbar {
            width: 8px;
        }
        
        #controls::-webkit-scrollbar-track {
            background: rgba(30,35,45,0.5);
            border-radius: 4px;
        }
        
        #controls::-webkit-scrollbar-thumb {
            background: #2a3444;
            border-radius: 4px;
        }
        
        #controls::-webkit-scrollbar-thumb:hover {
            background: #3a4454;
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ */
        .accordion-section {
            margin-bottom: 8px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #2a3444;
        }
        .accordion-header {
            padding: 10px 12px;
            background: #1a2230;
            color: #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: background 0.2s;
            font-size: 0.95em;
        }
        .accordion-header:hover {
            background: #2a3444;
        }
        .accordion-header.active {
            background: #2a3444;
        }
        .accordion-header button {
            padding: 6px 12px;
            background: #2a3444;
            color: #ddd;
            border: 1px solid #3a4454;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 8px;
            transition: all 0.2s;
        }
        #fileToggle {
            background: #4af !important;
            color: #000 !important;
            border-color: #4af !important;
        }

        #fileToggle:hover {
            background: #2a8cff !important;
            border-color: #2a8cff !important;
        }

        #fileToggle.changed {
            background: #ff9900 !important;
            color: #000 !important;
            border-color: #ff9900 !important;
        }

        #fileToggle.changed:hover {
            background: #e68a00 !important;
            border-color: #e68a00 !important;
        }
        .accordion-header button:hover {
            background: #3a4454;
        }
        .accordion-header button.active {
            background: #4af;
            color: #000;
            border-color: #4af;
        }
        .accordion-header button.changed {
            background: #ff9900;
            color: #000;
            border-color: #ff9900;
        }
        .accordion-icon {
            transition: transform 0.2s;
            font-size: 0.9em;
            color: #888;
        }
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
            color: #ddd;
        }
        .accordion-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: none;
            background: rgba(15,20,30,0.8);
        }
        .accordion-content.active {
            padding: 12px;
            max-height: 1000px;
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .compact-row {
            margin: 8px 0;
        }
        label {
            display: block;
            margin: 6px 0 3px;
            font-size: 0.85em;
            color: #bbb;
        }
        .range-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0 8px;
        }
        input[type=range] {
            flex: 1;
            height: 4px;
            background: #2a3444;
            border-radius: 2px;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            width: 14px;
            height: 14px;
            background: #4af;
            border-radius: 50%;
            cursor: pointer;
        }
        .number-input {
            width: 60px;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid #3a4454;
            background: #1a2230;
            color: white;
            font-size: 0.9em;
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã */
        .compact-checkbox {
            display: flex;
            align-items: center;
            margin: 6px 0;
            cursor: pointer;
            font-size: 0.9em;
        }
        .compact-checkbox input[type="checkbox"] {
            margin: 0 8px 0 0;
            width: 14px;
            height: 14px;
            cursor: pointer;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        button {
            padding: 6px 12px;
            background: #2a3444;
            color: #ddd;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        button:hover {
            background: #3a4454;
        }
        button.active {
            background: #4af;
            color: #000;
        }
        .delete-btn {
            background: #ff4444 !important;
            color: white !important;
        }
        .delete-btn:hover {
            background: #ff6666 !important;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –º–µ–Ω—é */
        .file-btn-open {
            background: #4af !important;
            color: white !important;
        }
        .file-btn-open:hover {
            background: #2a8cff !important;
        }

        .file-btn-save {
            background: #ff9900 !important;
            color: white !important;
        }
        .file-btn-save:hover {
            background: #e68a00 !important;
        }

        .file-btn-save-image {
            background: #4caf50 !important;
            color: white !important;
        }
        .file-btn-save-image:hover {
            background: #3d8b40 !important;
        }

        .file-btn-close {
            background: #ff4444 !important;
            color: white !important;
        }
        .file-btn-close:hover {
            background: #ff3333 !important;
        }
        
        /* –î–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ */
        .marker-dialog {
            position: fixed;
            background: rgba(20,25,35,0.95);
            padding: 16px;
            border-radius: 8px;
            z-index: 1000;
            min-width: 280px;
            box-shadow: 0 4px 12px #0006;
            display: none;
        }
        .marker-dialog.active {
            display: block;
        }
        .dialog-title {
            margin-top: 0;
            margin-bottom: 12px;
            color: #fff;
            font-size: 1.1em;
        }
        .dialog-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .dialog-buttons button {
            flex: 1;
            padding: 6px 10px;
        }
        
        /* –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ */
        .empty-section {
            padding: 16px 0;
            text-align: center;
            color: #888;
            font-style: italic;
            font-size: 0.9em;
        }
        
        /* –°–µ–ª–µ–∫—Ç –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ */
        select, input[type="file"] {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #3a4454;
            background: #1a2230;
            color: white;
            font-size: 0.9em;
            margin: 4px 0 8px;
        }
        
        /* –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è */
        input[type="text"], textarea {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #3a4454;
            background: #1a2230;
            color: white;
            font-size: 0.9em;
            margin: 4px 0 8px;
            box-sizing: border-box;
        }
        
        textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        /* –ú–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ */
        .bs-marker {
            background: #ff4444;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
            cursor: move;
            transition: transform 0.2s;
            position: relative;
        }
        .bs-marker:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .bs-marker.temp {
            background: #ff8888;
            animation: pulse 1s infinite;
        }
        .bs-marker.dragging {
            z-index: 1000 !important;
            opacity: 0.7;
        }
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* –ö—É—Ä—Å–æ—Ä –≤ —Ä–µ–∂–∏–º–µ –ë–° */
        .bs-cursor {
            cursor: crosshair !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è Leaflet –ø–æ–ø–∞–ø–∞ */
        .leaflet-popup-content-wrapper {
            background: rgba(20,25,35,0.95) !important;
            color: #ddd !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px #0006 !important;
            border: 1px solid #3a4454 !important;
        }
        .leaflet-popup-content {
            margin: 12px !important;
            min-width: 180px !important;
            font-family: system-ui, sans-serif !important;
        }
        .leaflet-popup-tip {
            background: rgba(20,25,35,0.95) !important;
            box-shadow: 0 4px 12px #0006 !important;
        }
        .marker-popup-title {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 6px;
            color: #fff;
        }
        .marker-popup-comment {
            margin-top: 8px;
            color: #aaa;
            font-size: 0.85em;
            line-height: 1.3;
        }
        .popup-buttons {
            display: flex;
            gap: 6px;
            margin-top: 12px;
        }
        .popup-buttons button {
            flex: 1;
            padding: 5px 10px;
            font-size: 0.85em;
        }
        .leaflet-popup-close-button {
            color: #ddd !important;
            font-size: 18px !important;
            padding: 4px !important;
        }
        .leaflet-popup-close-button:hover {
            color: #fff !important;
            background: transparent !important;
        }
        
        /* –ö—Ä—É–≥ –¥–ª—è –ë–° */
        .bs-circle {
            pointer-events: none;
            fill: none;
            stroke: #4af;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
        }
        
        /* –°–ø–∏—Å–æ–∫ –ë–° - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Å—Ç–∏–ª—å */
        .bs-list {
            max-height: 500px;
            overflow-y: auto;
            margin: 8px 0;
            border: 1px solid #2a3444;
            border-radius: 4px;
            background: rgba(15,20,30,0.8);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ —Å–ø–∏—Å–∫–∞ –ë–° */
        .bs-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .bs-list::-webkit-scrollbar-track {
            background: rgba(30,35,45,0.3);
            border-radius: 3px;
        }
        
        .bs-list::-webkit-scrollbar-thumb {
            background: #3a4454;
            border-radius: 3px;
        }
        
        .bs-list::-webkit-scrollbar-thumb:hover {
            background: #4a5464;
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ë–° */
        .bs-list-item {
            padding: 4px 8px;
            background: rgba(26,34,48,0.5);
            border-bottom: 1px solid #2a3444;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
            font-size: 1em;
            min-height: 24px;
            overflow: hidden;
        }

        .bs-list-item:last-child {
            border-bottom: none;
        }

        .bs-list-item:hover {
            background: rgba(42,52,68,0.8);
        }

        .bs-list-item.active {
            background: rgba(42,52,68,0.8);
            border-left: 3px solid #4af;
        }

        .bs-list-item-name {
            flex: 1;
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .bs-list-item-info {
            font-size: 0.7em;
            color: #aaa;
            margin-left: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
            flex-shrink: 0;
        }
        
        .bs-count {
            font-size: 0.85em;
            color: #4af;
            margin: 6px 0;
            text-align: center;
        }
        
        .button-description {
            font-size: 0.8em;
            color: #888;
            margin-top: 2px;
            margin-bottom: 8px;
        }
        
        .file-section-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .file-section-buttons button {
            width: 100%;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –ö–∞—Ä—Ç–∞ */
        .map-option {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .map-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .map-option.selected {
            background: rgba(68, 136, 255, 0.2);
            border-left: 3px solid #4af;
        }
        
        .map-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .map-option label {
            flex: 1;
            margin: 0;
            cursor: pointer;
        }
		
		/* –ö–ª–∞—Å—Ç–µ—Ä—ã –≤ —Å–ø–∏—Å–∫–µ */
		.bs-list-item.cluster {
			background: var(--cluster-bg, #2a3444);
			border-left: 4px solid var(--cluster-accent);
			font-weight: 600;
			color: #f8f9fa;
			padding: 4px 8px;               /* –∫–∞–∫ —É —è—á–µ–µ–∫ */
			min-height: 24px;               /* —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å .bs-list-item */
			line-height: 1.4;
			display: flex;
			align-items: center;
			transition: background 0.18s;
		}

		.bs-list-item.cluster:hover {
			background: var(--cluster-bg-hover, rgba(255,255,255,0.08));
		}

		.bs-list-item.cluster .bs-list-item-name {
			flex: 1;
			font-weight: 700;
			text-shadow: 0 1px 2px rgba(0,0,0,0.5);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.bs-list-item.cluster .bs-list-item-info {
			font-size: 0.78em;
			color: rgba(255,255,255,0.82);
			margin-left: 8px;
			font-weight: 400;
		}

		/* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã, —á—Ç–æ–±—ã –≤—ã—Å–æ—Ç–∞ –±—ã–ª–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–π —è—á–µ–π–∫–∞–º */
		#cellList .bs-list-item {
			min-height: 24px;
			padding: 4px 8px;
		}
		
		/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É */
		#createZoneBtn {
			transition: all 0.2s ease;
		}

		#createZoneBtn:hover {
			opacity: 0.9;
			background: #3a4454 !important;
		}

		#createZoneBtn.active:hover {
			opacity: 0.9;
			background: #2a8cff !important; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π —Å–∏–Ω–∏–π –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
		}

		#createZoneBtn:active {
			opacity: 0.7;
			transform: scale(0.98);
		}
		
		/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–µ—Ä—à–∏–Ω –∑–æ–Ω—ã –∫–∞–∫ —É –ë–° */
		.bs-marker {
			cursor: move !important;
			transition: transform 0.2s;
		}

		.bs-marker.dragging {
			z-index: 1000 !important;
			opacity: 0.7;
			transform: scale(1.2);
		}

		/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–µ—Ä—à–∏–Ω –∑–æ–Ω—ã */
		.zone-vertex-marker {
			cursor: move !important;
		}

		.zone-vertex-marker .dragging {
			z-index: 1000 !important;
			opacity: 0.7;
			transform: scale(1.2);
		}

		/* –ö—É—Ä—Å–æ—Ä –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
		.zone-vertex-marker.dragging {
		    z-index: 1000 !important;
			opacity: 0.7;
			transform: scale(1.2);
		}
		
		/* –£–±–∏—Ä–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
		.leaflet-marker-icon {
			transition: none !important;
		}
		
		/* –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é Leaflet –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ */
		.leaflet-marker-icon.leaflet-zoom-animated {
			transition: none !important;
		}
		
		/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ä–µ–¥–∏–Ω–Ω—ã—Ö –≤–µ—Ä—à–∏–Ω */
		.zone-mid-vertex-marker {
			cursor: move !important;
			transition: all 0.1s;
		}

		.zone-mid-vertex-marker:hover {
			opacity: 1 !important;
			transform: scale(1.2);
		}

		.zone-mid-vertex-marker .dragging,
		.zone-mid-vertex-marker.dragging {
			opacity: 0.9 !important;
			transform: scale(1.3);
			z-index: 1000 !important;
		}

		/* –û—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
		.zone-vertex-marker:hover {
			transform: scale(1.2);
		}
		
		/* –ü–æ–ø–∞–ø –≤–µ—Ä—à–∏–Ω—ã */
		.vertex-popup .leaflet-popup-content-wrapper {
			padding: 6px !important;
			min-width: 0 !important;
			width: fit-content !important;
			background: rgba(20,25,35,0.95) !important;
		}

		.vertex-popup .leaflet-popup-content {
			margin: 0 !important;
			padding: 0 !important;
			width: fit-content !important;
			min-width: 0 !important;
		}

		.vertex-popup .leaflet-popup-tip {
			background: rgba(20,25,35,0.95) !important;
		}
    </style>
</head>
<body>
<div id="map"></div>
<canvas id="c"></canvas>
<div id="controls">
    <!-- –°–µ–∫—Ü–∏—è –§–∞–π–ª (–∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div class="accordion-section">
        <div class="accordion-header" onclick="toggleAccordion('file')">
            <div style="display: flex; align-items: center; gap: 8px;">
                <button id="fileToggle">–û—Ç–∫—Ä—ã—Ç—å</button>
                <span>–§–∞–π–ª</span>
            </div>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div class="accordion-content" id="file-content">
            <div class="file-section-buttons">
                <button class="file-btn-open">–û—Ç–∫—Ä—ã—Ç—å</button>
                <button class="file-btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="file-btn-save-image">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                <button class="file-btn-close" onclick="reset()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    <!-- –°–µ–∫—Ü–∏—è –ö–∞—Ä—Ç–∞ (–∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div class="accordion-section">
        <div class="accordion-header" onclick="toggleAccordion('map-section')">
            <div style="display: flex; align-items: center; gap: 8px;">
                <button id="changeMapBtn" onclick="changeMap(event)">–°–º–µ–Ω–∏—Ç—å</button>
                <span>–ö–∞—Ä—Ç–∞</span>
            </div>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div class="accordion-content" id="map-section-content">
            <div class="map-option selected" onclick="selectMapType('osm')">
                <input type="radio" name="mapType" id="mapOsm" checked>
                <label for="mapOsm">OpenStreetMap</label>
            </div>
            
            <div class="map-option" onclick="selectMapType('google-hybrid')">
                <input type="radio" name="mapType" id="mapGoogleHybrid">
                <label for="mapGoogleHybrid">Google –ì–∏–±—Ä–∏–¥</label>
            </div>
            
            <div class="map-option" onclick="selectMapType('google-sat')">
                <input type="radio" name="mapType" id="mapGoogleSat">
                <label for="mapGoogleSat">Google –°–ø—É—Ç–Ω–∏–∫</label>
            </div>
            
            <div class="map-option" onclick="selectMapType('yandex')">
                <input type="radio" name="mapType" id="mapYandex">
                <label for="mapYandex">–Ø–Ω–¥–µ–∫—Å</label>
            </div>
            
            <div class="map-option" onclick="selectMapType('yandex-hybrid')">
                <input type="radio" name="mapType" id="mapYandexHybrid">
                <label for="mapYandexHybrid">–Ø–Ω–¥–µ–∫—Å –ì–∏–±—Ä–∏–¥</label>
            </div>
            
            <div class="map-option" onclick="selectMapType('yandex-sat')">
                <input type="radio" name="mapType" id="mapYandexSat">
                <label for="mapYandexSat">–Ø–Ω–¥–µ–∫—Å –°–ø—É—Ç–Ω–∏–∫</label>
            </div>
        </div>
    </div>
    
    <!-- –°–µ–∫—Ü–∏—è –°–æ—Ç–æ–≤–æ–µ —Å—Ç—Ä–æ–µ–Ω–∏–µ (–∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div class="accordion-section">
        <div class="accordion-header" onclick="toggleAccordion('network-build')">
			<div style="display: flex; align-items: center; gap: 8px;">
				<button id="networkToggleBtn" onclick="toggleNetworkMode(event)" class="active">–í—ã–∫–ª—é—á–∏—Ç—å</button>
				<span>–°–æ—Ç–æ–≤–æ–µ —Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
			</div>
			<span class="accordion-icon">‚ñº</span>
		</div>
        <div class="accordion-content" id="network-build-content">
		<button id="buildToggleInside" onclick="toggleBuild(event)" style="width: 100%; margin-top: 10px; margin-bottom: 8px;">
			–í–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–µ–Ω–∏–µ
		</button>
            <div class="compact-row">
                <label>–†–∞–¥–∏—É—Å, –º (10-5000)</label>
                <div class="range-group">
                    <input type="range" id="radiusSlider" min="10" max="5000" value="750" step="10">
                </div>
                <input type="text" id="radiusText" class="number-input" value="750" style="width: 100%;">
            </div>
            
            <div class="compact-row">
                <label>–í—Ä–∞—â–µ–Ω–∏–µ, ¬∞ (-180-180)</label>
                <div class="range-group">
                    <input type="range" id="rotSlider" min="-180" max="180" value="0" step="1">
                </div>
                <input type="text" id="rotText" class="number-input" value="0" style="width: 100%;">
            </div>
            
            <div class="compact-checkbox">
                <input type="checkbox" id="moveGrid">
                <label for="moveGrid">–ü–µ—Ä–µ–º–µ—â–∞—Ç—å —Ä–∞–∑–º–µ—Ç–∫—É</label>
            </div>
            
            <div class="compact-checkbox">
                <input type="checkbox" id="showHex" checked>
                <label for="showHex">–Ø—á–µ–π–∫–∏</label>
            </div>
            
            <div class="compact-checkbox">
                <input type="checkbox" id="showCenters" checked>
                <label for="showCenters">–£–∑–ª—ã</label>
            </div>
            
            <div class="compact-checkbox">
                <input type="checkbox" id="showCircles">
                <label for="showCircles">–†–∞–¥–∏—É—Å—ã</label>
            </div>
			
			<div class="compact-checkbox">
				<input type="checkbox" id="showNames">
				<label for="showNames">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è</label>
			</div>
			
			<button id="createClusterBtn" style="width: 100%; margin-top: 10px; margin-bottom: 8px;">
				–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä
			</button>

			<!-- –î–æ–±–∞–≤—å—Ç–µ –Ω–∞–¥–ø–∏—Å—å –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ -->
			<div id="clusterCount" class="bs-count" style="text-align: center; margin-bottom: 12px;">
				–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: 0
			</div>
			
			<div id="cellCount" class="bs-count" style="margin-top: 12px; text-align: center;">
                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —è—á–µ–µ–∫: 0
            </div>
			
			<div id="cellList" class="bs-list" style="display: none; max-height: 200px;">
				<!-- –°–ø–∏—Å–æ–∫ —è—á–µ–µ–∫ –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
			</div>

			<div id="cellEmptyMessage" class="empty-section" style="display: none;">
				–Ø—á–µ–π–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
			</div>
			
        </div>
    </div>
	
	<!-- –°–µ–∫—Ü–∏—è –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ —Å—Ç—Ä–æ–µ–Ω–∏–µ (–∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
	<div class="accordion-section">
		<div class="accordion-header" onclick="toggleAccordion('kml-import')">
			<div style="display: flex; align-items: center; gap: 8px;">
				<button id="arbitraryToggleBtn" onclick="toggleArbitraryMode(event)">–í–∫–ª—é—á–∏—Ç—å</button>
				<span>–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ —Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
			</div>
			<span class="accordion-icon">‚ñº</span>
		</div>
		<div class="accordion-content" id="kml-import-content">
			<!-- –ö–ù–û–ü–ö–ê –°–û–ó–î–ê–ù–ò–Ø –ó–û–ù–´ (–ö–ê–ö –ö–ù–û–ü–ö–ê –°–û–ó–î–ê–¢–¨ –ö–õ–ê–°–¢–ï–†) -->
			<button id="createZoneBtn" onclick="toggleZoneMode(event)" style="width: 100%; margin-top: 10px; margin-bottom: 8px;">
				–°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É
			</button>
			
			<!-- –ù–ê–î–ü–ò–°–¨ –ö–û–õ–ò–ß–ï–°–¢–í–û –ó–û–ù (–ö–ê–ö –£ –ö–õ–ê–°–¢–ï–†–û–í) -->
			<div id="zoneCount" class="bs-count" style="text-align: center; margin-bottom: 12px;">
				–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–Ω: 0
			</div>
			
			<!-- –°–ü–ò–°–û–ö –ó–û–ù -->
			<div id="zoneList" class="bs-list" style="display: none; max-height: 200px;">
				<!-- –°–ø–∏—Å–æ–∫ –∑–æ–Ω –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
			</div>
			
			<div id="zoneEmptyMessage" class="empty-section" style="display: none;">
				–ó–æ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
			</div>
		</div>
	</div>
    
    <!-- –°–µ–∫—Ü–∏—è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ë–° (–∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div class="accordion-section">
        <div class="accordion-header" onclick="toggleAccordion('bs-install')">
            <div style="display: flex; align-items: center; gap: 8px;">
                <button id="bsToggle" onclick="toggleBSMode(event)">–í–∫–ª—é—á–∏—Ç—å</button>
                <span>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ë–°</span>
            </div>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div class="accordion-content" id="bs-install-content">
            <div id="bsCount" class="bs-count">–ë–∞–∑–æ–≤—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π: 0</div>
            
            <div id="bsList" class="bs-list" style="display: none;">
                <!-- –°–ø–∏—Å–æ–∫ –ë–° –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            
            <div id="bsEmptyMessage" class="empty-section" style="display: none;">
            </div>
        </div>
    </div>
	
	<!-- –°–µ–∫—Ü–∏—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
	<div class="accordion-section">
		<div class="accordion-header" onclick="toggleAccordion('analytics')">
			<div style="display: flex; align-items: center; gap: 8px;">
				<span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
			</div>
			<span class="accordion-icon">‚ñº</span>
		</div>
		<div class="accordion-content" id="analytics-content">
			<!-- –ö–ù–û–ü–ö–ê –°–û–ó–î–ê–ù–ò–Ø –û–ë–™–ï–ö–¢–ê -->
			<button id="createObjectBtn" onclick="createObject()" style="width: 100%; margin-top: 10px; margin-bottom: 8px; background: #2a3444; color: #ddd; border: none; transition: background 0.2s;" 
					onmouseover="this.style.background='#3a4454'" 
					onmouseout="this.style.background='#2a3444'">
				–°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç
			</button>
			
			<!-- –ö–ù–û–ü–ö–ê –ò–ú–ü–û–†–¢–ê –û–ë–™–ï–ö–¢–û–í -->
			<button id="importObjectsBtn" onclick="importObjects()" style="width: 100%; margin-bottom: 8px; background: #2a3444; color: #ddd; border: none; transition: background 0.2s;" 
					onmouseover="this.style.background='#3a4454'" 
					onmouseout="this.style.background='#2a3444'">
				–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã
			</button>
			
			<!-- –ù–ê–î–ü–ò–°–¨ –ö–û–õ–ò–ß–ï–°–¢–í–û –û–ë–™–ï–ö–¢–û–í -->
			<div id="objectCount" class="bs-count" style="text-align: center; margin-bottom: 12px;">
				–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤: 0
			</div>
			
			<!-- –°–ü–ò–°–û–ö –û–ë–™–ï–ö–¢–û–í -->
			<div id="objectList" class="bs-list" style="display: none; max-height: 200px;">
				<!-- –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
			</div>
			
			<div id="objectEmptyMessage" class="empty-section" style="display: none;">
				–û–±—ä–µ–∫—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
			</div>
		</div>
	</div>

	<!-- –î–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ -->
	<div id="markerDialog" class="marker-dialog">
		<label for="markerName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
		<input type="text" id="markerName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
		
		<label for="markerComment" style="margin-top:8px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
		<textarea id="markerComment" rows="2" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
		
		<div class="compact-checkbox" style="margin-top:12px;">
			<input type="checkbox" id="markerShowCircle">
			<label for="markerShowCircle">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–∞–¥–∏—É—Å</label>
		</div>
		
		<div id="markerCircleControls" style="margin-top:8px; display:none;">
			<label>–†–∞–¥–∏—É—Å, –º (10-15000)</label>
			<div class="range-group">
				<input type="range" id="markerCircleSlider" min="10" max="15000" value="500" step="10">
			</div>
			<input type="text" id="markerCircleText" class="number-input" value="500" style="width: 100%;">
		</div>
		
		<div class="dialog-buttons">
			<button onclick="saveMarker()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
			<button onclick="cancelMarker()">–û—Ç–º–µ–Ω–∞</button>
			<button id="deleteMarkerBtn" class="delete-btn" onclick="deleteMarker()" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
		</div>
	</div>

	<!-- –î–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —è—á–µ–π–∫–∏ -->
	<div id="cellDialog" class="marker-dialog">
		<label for="cellName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
		<input type="text" id="cellName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
		
		<label for="cellComment" style="margin-top:8px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
		<textarea id="cellComment" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
		
		<div class="dialog-buttons">
		<button onclick="saveItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
		<button onclick="cancelItem()">–û—Ç–º–µ–Ω–∞</button>
		<button id="deleteCellBtn" class="delete-btn" onclick="deleteItem()" style="display:none;">
			–£–¥–∞–ª–∏—Ç—å
		</button>
	</div>
</div>

<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const CONFIG = {
    MIN_RADIUS: 10,
    MAX_RADIUS: 5000,
    DEFAULT_RADIUS: 750,
    MIN_BS_RADIUS: 10,
    MAX_BS_RADIUS: 15000,
    DEFAULT_BS_RADIUS: 500
};

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let leafletMap = null;
let bgMode = 'osm';
let radiusMeters = CONFIG.DEFAULT_RADIUS;
let rotation = 0;
let showHex = true;
let showCenters = true;
let showCircles = false;
let showNames = false;
let buildEnabled = false;
let bsModeEnabled = false;
let moveGridEnabled = false;
let isDragging = false;
let dragStartPixelX = 0;
let dragStartPixelY = 0;
let dragStartLat = 0;
let dragStartLng = 0;
let originalMarkerValues = null;
let clusters = [];
let editingItem = null;


// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –∑–æ–Ω (–ø–æ–ª–∏–≥–æ–Ω–æ–≤)
let zoneModeEnabled = false;
let zones = [];
let currentPolygon = [];
let tempPolygonLayer = null;
let tempPoints = [];
let selectedZoneId = null;
let zoneCounter = 0;
let currentZoneColor = null;
let zoneColorIndex = 0;

// –¶–µ–Ω—Ç—Ä —Å–µ—Ç–∫–∏ –≤ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
let gridCenterLat = null;
let gridCenterLng = null;

// –•—Ä–∞–Ω–∏–º —Å–µ—Ç–∫—É –≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (q, r) –≥–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω–æ–π —Å–µ—Ç–∫–∏
let activeHexes = new Map();
let possibleHexes = new Map();
let selectedCellKey = null;
let editingCellKey = null; // –ö–ª—é—á —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π —è—á–µ–π–∫–∏

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π
let bsMarkers = [];
let leafletMarkers = [];
let currentMarkerData = null;
let currentClickPosition = { x: 0, y: 0 };
let tempMarker = null;
let editingMarkerId = null;
let isDraggingMarker = false;
let draggedMarkerId = null;
let previewCircle = null;
let bsCounter = 0;
let isMapChanged = false;
let selectedBsId = null;

// –ì–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—à–µ—Å—Ç—å —Å–æ—Å–µ–¥–µ–π)
const hexDirections = [
    { q: 1, r: 0 },
    { q: 1, r: -1 },
    { q: 0, r: -1 },
    { q: -1, r: 0 },
    { q: -1, r: 1 },
    { q: 0, r: 1 }
];

// –°–ª–æ–∏ –∫–∞—Ä—Ç—ã
const googleSat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '¬© Google'
});
const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '¬© Google'
});
const yandexMap = L.tileLayer('https://core-renderer-tiles.maps.yandex.net/tiles?l=map&v=23.10.26-0&x={x}&y={y}&z={z}&scale=1&lang=ru_RU', {
    maxZoom: 19, attribution: '¬© –Ø–Ω–¥–µ–∫—Å'
});
const yandexHybrid = L.tileLayer('https://core-renderer-tiles.maps.yandex.net/tiles?l=skl&v=23.10.26-0&x={x}&y={y}&z={z}&scale=1&lang=ru_RU', {
    maxZoom: 19, attribution: '¬© –Ø–Ω–¥–µ–∫—Å'
});
const yandexSat = L.tileLayer('https://core-sat.maps.yandex.net/tiles?l=sat&v=23.10.26-0&x={x}&y={y}&z={z}&scale=1&lang=ru_RU', {
    maxZoom: 19, attribution: '¬© –Ø–Ω–¥–µ–∫—Å'
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é
function changeMap(event) {
    if (event) event.stopPropagation();
    
    const mapTypes = ['osm', 'google-hybrid', 'google-sat', 'yandex', 'yandex-hybrid', 'yandex-sat'];
    const currentIndex = mapTypes.indexOf(bgMode);
    const nextIndex = (currentIndex + 1) % mapTypes.length;
    const nextMapType = mapTypes[nextIndex];
    
    selectMapType(nextMapType);
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–æ–Ω—ã
function toggleZoneMode(event) {
    if (event) event.stopPropagation();
    
    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –∑–æ–Ω –≤–∫–ª—é—á–µ–Ω - —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∑–æ–Ω—É –∏ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é
    if (zoneModeEnabled) {
        // –û—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ
        cancelPolygon();
        currentZoneColor = getNextZoneColor(); // –ù–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è –Ω–æ–≤–æ–π –∑–æ–Ω—ã
        
        // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∑–æ–Ω—É —Å—Ä–∞–∑—É
        if (leafletMap) {
            leafletMap.dragging.disable();
            leafletMap.scrollWheelZoom.enable();
            leafletMap.on('click', onMapClickForZone);
            leafletMap.on('mousemove', onMapMouseMoveForZone);
            startNewPolygon();
        }
        
        updateCursor();
        return;
    }
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã
    if (buildEnabled) {
        buildEnabled = false;
        const buildBtn = document.getElementById('buildToggleInside');
        if (buildBtn) {
            buildBtn.textContent = '–í–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–µ–Ω–∏–µ';
            buildBtn.classList.remove('active');
            buildBtn.style.background = '#2a3444';
            buildBtn.style.color = '#ddd';
            buildBtn.style.border = 'none';
        }
        possibleHexes.clear();
        draw();
    }
    
    if (bsModeEnabled) {
        bsModeEnabled = false;
        document.getElementById('bsToggle').textContent = '–í–∫–ª—é—á–∏—Ç—å';
        document.getElementById('bsToggle').classList.remove('active');
        removeTempMarker();
        removePreviewCircle();
    }
    
    if (moveGridEnabled) {
        moveGridEnabled = false;
        document.getElementById('moveGrid').checked = false;
    }
    
    // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∑–æ–Ω
    zoneModeEnabled = true;
    currentZoneColor = getNextZoneColor();
    
    const btn = document.getElementById('createZoneBtn');
    btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É';
    btn.classList.add('active'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active
    btn.style.background = '#4af'; // –°–∏–Ω–∏–π —Ü–≤–µ—Ç
    btn.style.color = '#000';
    btn.style.border = 'none';
    
    // –í–ê–ñ–ù–û: –æ—Ç–∫–ª—é—á–∞–µ–º canvas pointer events, —á—Ç–æ–±—ã –∫–ª–∏–∫–∏ —É—Ö–æ–¥–∏–ª–∏ –Ω–∞ –∫–∞—Ä—Ç—É
    canvas.style.pointerEvents = 'none';
    document.body.classList.remove('bs-cursor');
    
    if (leafletMap) {
        leafletMap.dragging.disable();
        leafletMap.scrollWheelZoom.enable();
        leafletMap.on('click', onMapClickForZone);
        leafletMap.on('mousemove', onMapMouseMoveForZone);
        startNewPolygon();
    }
    
    updateCursor();
}

// –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–æ–º–µ—Ä –ë–°
function getNextBSNumber() {
    if (bsMarkers.length === 0) return 1;
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–º–µ—Ä–∞ –ë–°
    const usedNumbers = new Set();
    
    bsMarkers.forEach(marker => {
        const match = marker.name.match(/^–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è (\d+)$/); // –¢–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ "–ë–° N"
        if (match) {
            const num = parseInt(match[1], 10);
            if (!isNaN(num)) {
                usedNumbers.add(num);
            }
        }
    });
    
    // –ò—â–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ —á–∏—Å–ª–æ, –Ω–∞—á–∏–Ω–∞—è —Å 1
    let number = 1;
    while (usedNumbers.has(number)) {
        number++;
    }
    
    return number;
}

// –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ –ø–æ–ª–∏–≥–æ–Ω–∞
function startNewPolygon() {
    currentPolygon = [];
    tempPoints = [];
    removeTempPolygon();
    
    if (leafletMap) {
        leafletMap.dragging.disable();
        leafletMap.scrollWheelZoom.enable();
        leafletMap.on('click', onMapClickForZone);
        leafletMap.on('mousemove', onMapMouseMoveForZone);
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –ª–∏–Ω–∏–∏
function onMapMouseMoveForZone(e) {
    if (!zoneModeEnabled || tempPoints.length === 0) return;
    
    // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
    if (window.tempGuideLine) {
        leafletMap.removeLayer(window.tempGuideLine);
        window.tempGuideLine = null;
    }
    
    const lastPoint = tempPoints[tempPoints.length - 1];
    const hasIntersection = isLineIntersecting(lastPoint.lat, lastPoint.lng, e.latlng.lat, e.latlng.lng);
    
    // –¢–æ–ª—å–∫–æ –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ª–∏–Ω–∏–∏, –Ω–æ –≤—Å–µ —Ä–∞–≤–Ω–æ —Ä–∏—Å—É–µ–º
    const lineColor = hasIntersection ? '#ff4444' : (currentZoneColor || '#4af');
    
    window.tempGuideLine = L.polyline([lastPoint, e.latlng], {
        color: lineColor,
        weight: 2,
        opacity: 0.7,
        dashArray: '5, 8'
    }).addTo(leafletMap);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–æ–Ω—ã
function onMapClickForZone(e) {
    if (!zoneModeEnabled) return;
    
    const latlng = e.latlng;
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Ç–æ—á–∫–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
    if (tempPoints.length > 0) {
        const lastPoint = tempPoints[tempPoints.length - 1];
        
        if (isLineIntersecting(lastPoint.lat, lastPoint.lng, latlng.lat, latlng.lng)) {
            // –ü—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫
            return;
        }
    }
    
    // –û–±—ã—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏
    currentPolygon.push([latlng.lat, latlng.lng]);
    tempPoints.push(latlng);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    drawTempPolygon();
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–æ–ª–∏–≥–æ–Ω–∞
function drawTempPolygon() {
    removeTempPolygon();
    
    if (!leafletMap || tempPoints.length === 0) return;
    
    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ - –¶–í–ï–¢–û–ú –ó–û–ù–´
    if (tempPoints.length > 1) {
        tempPolygonLayer = L.polyline(tempPoints, {
            color: currentZoneColor || '#4af',
            weight: 3,
            opacity: 0.8,
            dashArray: '5, 5'
        }).addTo(leafletMap);
    }
    
    // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏
    window.tempPointMarkers = [];
    tempPoints.forEach((point, index) => {
        const marker = L.marker([point.lat, point.lng], {
            icon: L.divIcon({
                html: `<div style="background: ${currentZoneColor || '#4af'}; width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8],
                className: 'zone-point-marker'
            }),
            draggable: false,
            interactive: true
        }).addTo(leafletMap);
        
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –ü–ï–†–í–û–ô –¢–û–ß–ö–ò - –æ—Ç–º–µ–Ω–∞/–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        if (index === 0) {
            marker.on('click', function() {
                if (tempPoints.length < 3) {
                    cancelPolygon();
                    zoneModeEnabled = false;
                    currentZoneColor = null;
                    
                    const btn = document.getElementById('createZoneBtn');
                    btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É';
                    btn.classList.remove('active');
                    btn.style.background = '#2a3444';
                    btn.style.color = '#ddd';
                    btn.style.border = 'none';
                    
                    if (leafletMap) {
                        leafletMap.dragging.enable();
                        leafletMap.off('click', onMapClickForZone);
                        leafletMap.off('mousemove', onMapMouseMoveForZone);
                    }
                    
                    canvas.style.pointerEvents = 'none';
                    updateCursor();
                } else {
                    finishZone();
                }
            });
        }
        
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –í–¢–û–†–û–ô –¢–û–ß–ö–ò - –æ—Ç–º–µ–Ω–∞ –ø—Ä–∏ 2 —Ç–æ—á–∫–∞—Ö
        if (index === 1 && tempPoints.length === 2) {
            marker.on('click', function() {
                cancelPolygon();
                zoneModeEnabled = false;
                currentZoneColor = null;
                
                const btn = document.getElementById('createZoneBtn');
                btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É';
                btn.classList.remove('active');
                btn.style.background = '#2a3444';
                btn.style.color = '#ddd';
                btn.style.border = 'none';
                
                if (leafletMap) {
                    leafletMap.dragging.enable();
                    leafletMap.off('click', onMapClickForZone);
                    leafletMap.off('mousemove', onMapMouseMoveForZone);
                }
                
                canvas.style.pointerEvents = 'none';
                updateCursor();
            });
        }
        
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –ü–û–°–õ–ï–î–ù–ï–ô –¢–û–ß–ö–ò - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ—á–µ–∫ >= 3
        if (index === tempPoints.length - 1 && tempPoints.length >= 3) {
            marker.on('click', function() {
                finishZone();
            });
        }
        
        window.tempPointMarkers.push(marker);
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–æ–ª–∏–≥–æ–Ω–∞
function removeTempPolygon() {
    if (tempPolygonLayer && leafletMap) {
        leafletMap.removeLayer(tempPolygonLayer);
        tempPolygonLayer = null;
    }
    
    if (window.tempPointMarkers) {
        window.tempPointMarkers.forEach(marker => {
            if (leafletMap) leafletMap.removeLayer(marker);
        });
        window.tempPointMarkers = [];
    }
    
    // –£–¥–∞–ª—è–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–æ—á–Ω—É—é –ª–∏–Ω–∏—é
    if (window.tempGuideLine && leafletMap) {
        leafletMap.removeLayer(window.tempGuideLine);
        window.tempGuideLine = null;
    }
}

// –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–æ–Ω–∞–º–∏
function isLineIntersecting(lat1, lng1, lat2, lng2, excludeZoneId = null) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ—è—â–µ–π—Å—è –∑–æ–Ω–æ–π
    if (tempPoints.length > 0) {
        for (let i = 0; i < tempPoints.length - 1; i++) {
            const p1 = tempPoints[i];
            const p2 = tempPoints[i + 1];
            
            if (linesIntersect(
                lat1, lng1, lat2, lng2,
                p1.lat, p1.lng, p2.lat, p2.lng
            )) {
                return true;
            }
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–æ–Ω—ã
    for (const zone of zones) {
        if (excludeZoneId && zone.id === excludeZoneId) continue;
        
        for (let i = 0; i < zone.points.length - 1; i++) {
            const p1 = zone.points[i];
            const p2 = zone.points[i + 1];
            
            if (linesIntersect(
                lat1, lng1, lat2, lng2,
                p1[0], p1[1], p2[0], p2[1]
            )) {
                return true;
            }
        }
    }
    
    return false;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –¥–≤—É—Ö –æ—Ç—Ä–µ–∑–∫–æ–≤
function linesIntersect(x1, y1, x2, y2, x3, y3, x4, y4) {
    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏–µ –≤–µ–∫—Ç–æ—Ä—ã
    const v1 = [x2 - x1, y2 - y1];
    const v2 = [x4 - x3, y4 - y3];
    const v3 = [x3 - x1, y3 - y1];
    const v4 = [x4 - x1, y4 - y1];
    const v5 = [x1 - x3, y1 - y3];
    const v6 = [x2 - x3, y2 - y3];
    
    // –í—ã—á–∏—Å–ª—è–µ–º –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    const d1 = v1[0] * v3[1] - v1[1] * v3[0];
    const d2 = v1[0] * v4[1] - v1[1] * v4[0];
    const d3 = v2[0] * v5[1] - v2[1] * v5[0];
    const d4 = v2[0] * v6[1] - v2[1] * v6[0];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–æ–≥–æ–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ (–Ω–µ –∫–∞—Å–∞–Ω–∏–µ)
    return (d1 > 0 && d2 < 0 || d1 < 0 && d2 > 0) && 
           (d3 > 0 && d4 < 0 || d3 < 0 && d4 > 0);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è –ª–∏ –ø–æ–ª–∏–≥–æ–Ω —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–æ–Ω–∞–º–∏ (–∫—Ä–æ–º–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π)
function isPolygonIntersectingZones(points, excludeZoneId = null) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å—Ç–æ—Ä–æ–Ω—É –ø–æ–ª–∏–≥–æ–Ω–∞
    for (let i = 0; i < points.length - 1; i++) {
        const p1 = points[i];
        const p2 = points[i + 1];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ –≤—Å–µ–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–æ–Ω–∞–º–∏
        for (const zone of zones) {
            if (excludeZoneId && zone.id === excludeZoneId) continue;
            
            for (let j = 0; j < zone.points.length - 1; j++) {
                const p3 = zone.points[j];
                const p4 = zone.points[j + 1];
                
                if (linesIntersect(
                    p1[0], p1[1], p2[0], p2[1],
                    p3[0], p3[1], p4[0], p4[1]
                )) {
                    return { intersects: true, zoneId: zone.id };
                }
            }
        }
    }
    return { intersects: false };
}

// –û—Ç–º–µ–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–∏–≥–æ–Ω–∞
function cancelPolygon() {
    currentPolygon = [];
    tempPoints = [];
    removeTempPolygon();
    currentZoneColor = null;
    
    if (leafletMap) {
        leafletMap.dragging.enable();
        leafletMap.off('click', onMapClickForZone);
        leafletMap.off('mousemove', onMapMouseMoveForZone);
    }
}

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–æ–Ω—ã
function finishZone() {
    if (currentPolygon.length < 3) {
        // –ü—Ä–æ—Å—Ç–æ –æ—Ç–º–µ–Ω—è–µ–º –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        cancelPolygon();
        zoneModeEnabled = false;
        currentZoneColor = null;
        
        const btn = document.getElementById('createZoneBtn');
        btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É';
        btn.classList.remove('active');
        btn.style.background = '#2a3444';
        btn.style.color = '#ddd';
        btn.style.border = 'none';
        
        if (leafletMap) {
            leafletMap.dragging.enable();
            leafletMap.off('click', onMapClickForZone);
            leafletMap.off('mousemove', onMapMouseMoveForZone);
        }
        
        canvas.style.pointerEvents = 'none';
        updateCursor();
        return;
    }
    
    // ===== –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–°–ï–ß–ï–ù–ò–ô –ó–ê–ú–´–ö–ê–Æ–©–ï–ô –õ–ò–ù–ò–ò =====
    const firstPoint = tempPoints[0];
    const lastPoint = tempPoints[tempPoints.length - 1];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∑–∞–º—ã–∫–∞—é—â–µ–π –ª–∏–Ω–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ª–∏–Ω–∏—è–º–∏ –∑–æ–Ω—ã
    for (let i = 0; i < tempPoints.length - 1; i++) {
        const p1 = tempPoints[i];
        const p2 = tempPoints[i + 1];
        
        if (linesIntersect(
            firstPoint.lat, firstPoint.lng, lastPoint.lat, lastPoint.lng,
            p1.lat, p1.lng, p2.lat, p2.lng
        )) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–º –ó–ê–ú–´–ö–ê–Æ–©–£–Æ –õ–ò–ù–ò–Æ
            const errorLine = L.polyline([firstPoint, lastPoint], {
                color: '#ff4444',
                weight: 4,
                opacity: 0.9,
                dashArray: '5, 5'
            }).addTo(leafletMap);
            
            setTimeout(() => {
                if (leafletMap) leafletMap.removeLayer(errorLine);
            }, 1000);
            
            return; // –û—Ç–º–µ–Ω—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∑–æ–Ω—ã
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∑–∞–º—ã–∫–∞—é—â–µ–π –ª–∏–Ω–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–æ–Ω–∞–º–∏
    for (const zone of zones) {
        for (let j = 0; j < zone.points.length - 1; j++) {
            const p3 = zone.points[j];
            const p4 = zone.points[j + 1];
            
            if (linesIntersect(
                firstPoint.lat, firstPoint.lng, lastPoint.lat, lastPoint.lng,
                p3[0], p3[1], p4[0], p4[1]
            )) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–º –ó–ê–ú–´–ö–ê–Æ–©–£–Æ –õ–ò–ù–ò–Æ
                const errorLine = L.polyline([firstPoint, lastPoint], {
                    color: '#ff4444',
                    weight: 4,
                    opacity: 0.9,
                    dashArray: '5, 5'
                }).addTo(leafletMap);
                
                setTimeout(() => {
                    if (leafletMap) leafletMap.removeLayer(errorLine);
                }, 1000);
                
                return; // –û—Ç–º–µ–Ω—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∑–æ–Ω—ã
            }
        }
    }
    
    // –ó–∞–º—ã–∫–∞–µ–º –ø–æ–ª–∏–≥–æ–Ω
    currentPolygon.push(currentPolygon[0]);
    
    const zoneId = Date.now();
    
    // –ü–û–õ–£–ß–ê–ï–ú –°–õ–ï–î–£–Æ–©–ò–ô –î–û–°–¢–£–ü–ù–´–ô –ù–û–ú–ï–† –ó–û–ù–´
    const zoneNumber = getNextZoneNumber();
    const zoneName = `–ó–æ–Ω–∞ ${zoneNumber}`;
    
    const newZone = {
        id: zoneId,
        name: zoneName,
        comment: '',
        points: [...currentPolygon],
        color: currentZoneColor || getNextZoneColor()
    };
    
    zones.push(newZone);
    
    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∑–æ–Ω—É –Ω–∞ –∫–∞—Ä—Ç–µ
    drawZone(newZone);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏ —Å—á–µ—Ç—á–∏–∫
    updateZoneList();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º
    zoneModeEnabled = false;
    currentZoneColor = null;
    
    const btn = document.getElementById('createZoneBtn');
    btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É';
    btn.classList.remove('active');
    btn.style.background = '#2a3444';
    btn.style.color = '#ddd';
    btn.style.border = 'none';
    
    if (leafletMap) {
        leafletMap.off('mousemove', onMapMouseMoveForZone);
    }
    
    cancelPolygon();
    
    if (leafletMap) {
        leafletMap.dragging.enable();
        leafletMap.off('click', onMapClickForZone);
    }
    
    canvas.style.pointerEvents = 'none';
    
    markMapAsChanged();
}

// –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–æ–º–µ—Ä –∑–æ–Ω—ã
function getNextZoneNumber() {
    if (zones.length === 0) return 1;
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–º–µ—Ä–∞ –∑–æ–Ω
    const usedNumbers = new Set();
    
    zones.forEach(zone => {
        const match = zone.name.match(/–ó–æ–Ω–∞ (\d+)/);
        if (match) {
            const num = parseInt(match[1], 10);
            if (!isNaN(num)) {
                usedNumbers.add(num);
            }
        }
    });
    
    // –ò—â–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ —á–∏—Å–ª–æ, –Ω–∞—á–∏–Ω–∞—è —Å 1
    let number = 1;
    while (usedNumbers.has(number)) {
        number++;
    }
    
    return number;
}

// –ü–∞–ª–∏—Ç—Ä–∞ —è—Ä–∫–∏—Ö –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –∑–æ–Ω (–ø–æ –ø–æ—Ä—è–¥–∫—É)
const zoneColorPalette = [
    '#FF3333', // 1. —è—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π
    '#FF9500', // 2. —è—Ä–∫–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
    '#FFD600', // 3. —è—Ä–∫–æ-–∂–µ–ª—Ç—ã–π
    '#00CCFF', // 4. —è—Ä–∫–æ-–≥–æ–ª—É–±–æ–π
    '#3366FF', // 5. —è—Ä–∫–æ-—Å–∏–Ω–∏–π
    '#FF6699', // 6. —Ä–æ–∑–æ–≤–æ-–∫—Ä–∞—Å–Ω—ã–π
    '#00FF99'  // 7. —è—Ä–∫–æ-–º—è—Ç–Ω—ã–π
];

// –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ü–≤–µ—Ç –ø–æ –ø–æ—Ä—è–¥–∫—É
function getNextZoneColor() {
    const color = zoneColorPalette[zoneColorIndex % zoneColorPalette.length];
    zoneColorIndex++;
    return color;
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–æ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ
function drawZone(zone) {
    if (!leafletMap) return;
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª–æ–π –µ—Å–ª–∏ –µ—Å—Ç—å
    if (zone.layer) {
        leafletMap.removeLayer(zone.layer);
    }
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ–ª–∏–≥–æ–Ω –∑–∞–º–∫–Ω—É—Ç (–ø–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞ = –ø–µ—Ä–≤–∞—è)
    if (zone.points.length > 0) {
        const firstPoint = zone.points[0];
        zone.points[zone.points.length - 1] = [firstPoint[0], firstPoint[1]];
    }
    
    // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏–≥–æ–Ω
    zone.layer = L.polygon(zone.points, {
        color: zone.color,
        weight: 2,
        opacity: 0.8,
        fillColor: zone.color,
        fillOpacity: 0.2,
        dashArray: null,
        smoothFactor: 0,
        noClip: true
    }).addTo(leafletMap);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ
    const popupContent = document.createElement('div');
    
    const title = document.createElement('div');
    title.className = 'marker-popup-title';
    title.textContent = zone.name;
    popupContent.appendChild(title);
    
    if (zone.comment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'marker-popup-comment';
        commentDiv.textContent = zone.comment;
        popupContent.appendChild(commentDiv);
    }
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'popup-buttons';
    buttonsDiv.innerHTML = `
        <button onclick="editZone(${zone.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="deleteZoneById(${zone.id})" style="background:#ff4444;color:white;">–£–¥–∞–ª–∏—Ç—å</button>
    `;
    popupContent.appendChild(buttonsDiv);
    
    zone.layer.bindPopup(popupContent);
    
    // –ü–†–ò –û–¢–ö–†–´–¢–ò–ò –ü–û–ü–ê–ü–ê - –ü–û–ö–ê–ó–´–í–ê–ï–ú –í–ï–†–®–ò–ù–´
    zone.layer.on('popupopen', function() {
        showZoneVertices(zone);
    });
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–†–ò –ó–ê–ö–†–´–¢–ò–ò –ü–û–ü–ê–ü–ê - –ü–†–û–í–ï–†–Ø–ï–ú, –ß–¢–û –≠–¢–û –ö–†–ï–°–¢–ò–ö
    zone.layer.on('popupclose', function(e) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –ø–æ –∫—Ä–µ—Å—Ç–∏–∫—É
        const popup = zone.layer.getPopup();
        if (popup && popup._closeButton) {
            // –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–ª–∏ –∫—Ä–µ—Å—Ç–∏–∫–æ–º - –≤–µ—Ä—à–∏–Ω—ã –æ—Å—Ç–∞—é—Ç—Å—è
            return;
        }
        // –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö - —Å–∫—Ä—ã–≤–∞–µ–º –≤–µ—Ä—à–∏–Ω—ã
        hideZoneVertices(zone);
        if (selectedZoneId === zone.id) {
            selectedZoneId = null;
            updateZoneList();
        }
    });
    
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–õ–ò–ö–ê - –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –û–¢–ö–†–´–í–ê–ï–ú –ü–û–ü–ê–ü –ò –ü–û–ö–ê–ó–´–í–ê–ï–ú –í–ï–†–®–ò–ù–´
    zone.layer.on('click', function() {
        // –°–∫—Ä—ã–≤–∞–µ–º –≤–µ—Ä—à–∏–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–æ–Ω—ã
        if (selectedZoneId && selectedZoneId !== zone.id) {
            const oldZone = zones.find(z => z.id === selectedZoneId);
            if (oldZone) {
                hideZoneVertices(oldZone);
            }
        }
        
        selectedZoneId = zone.id;
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
        zone.layer.openPopup();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—à–∏–Ω—ã
        showZoneVertices(zone);
        
        updateZoneList();
    });
}

// –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∏–≥–æ–Ω –∑–æ–Ω—ã –ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤–µ—Ä—à–∏–Ω
function updateZonePolygon(zone) {
    if (zone.layer && leafletMap) {
        zone.layer.setLatLngs(zone.points);
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—à–∏–Ω—ã –∑–æ–Ω—ã
function showZoneVertices(zone) {
    if (!leafletMap) return;
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã –µ—Å–ª–∏ –µ—Å—Ç—å
    if (zone.vertexMarkers) {
        zone.vertexMarkers.forEach(marker => {
            if (leafletMap) leafletMap.removeLayer(marker);
        });
    }
    
    zone.vertexMarkers = [];
    
    // ===== –û–°–ù–û–í–ù–´–ï –í–ï–†–®–ò–ù–´ =====
    for (let i = 0; i < zone.points.length - 1; i++) {
        const point = zone.points[i];
        const latlng = L.latLng(point[0], point[1]);
        
        const marker = L.marker(latlng, {
            icon: L.divIcon({
                html: `<div style="background: ${zone.color}; width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.5); cursor: move;"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8],
                className: 'zone-vertex-marker'
            }),
            draggable: true
        }).addTo(leafletMap);
        
        marker.vertexIndex = i;
        marker.zoneId = zone.id;
        marker.isMainVertex = true;
        
		// ===== –ü–û–ü–ê–ü –î–õ–Ø –û–°–ù–û–í–ù–û–ô –í–ï–†–®–ò–ù–´ =====
		const popupContent = document.createElement('div');
		popupContent.style.cssText = `
			padding: 0;
			margin: 0;
			min-width: auto;
			width: fit-content;
		`;

		const buttonsDiv = document.createElement('div');
		buttonsDiv.className = 'popup-buttons';
		buttonsDiv.style.cssText = `
			padding: 0;
			margin: 0;
			width: fit-content;
		`;

		buttonsDiv.innerHTML = `
			<button onclick="deleteVertex(${zone.id}, ${i});" 
					style="background:#ff4444; color:white; border:none; border-radius:4px; padding:5px 12px; font-size:0.85em; cursor:pointer; width:100%; white-space:nowrap;">
				–£–¥–∞–ª–∏—Ç—å
			</button>
		`;

		popupContent.appendChild(buttonsDiv);

		// –£–±–∏—Ä–∞–µ–º –∫—Ä–µ—Å—Ç–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –∏ –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã
		marker.bindPopup(popupContent, {
			closeButton: false,
			className: 'vertex-popup'
		});
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–ø–∞–ø–∞
        marker.on('click', function(e) {
            this.openPopup();
        });
        
        // –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ drag –≤–µ—Ä—à–∏–Ω—ã - –£–ü–†–û–©–ê–ï–ú, –£–ë–ò–†–ê–ï–ú –ü–†–û–í–ï–†–ö–£
		marker.on('drag', function(e) {
			const newLatLng = e.target.getLatLng();
			const currentZone = zones.find(z => z.id === marker.zoneId);
			if (!currentZone) return;
			
			// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
			const oldLat = currentZone.points[marker.vertexIndex][0];
			const oldLng = currentZone.points[marker.vertexIndex][1];
			
			// –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
			const prevPos = marker._prevLatLng || L.latLng(oldLat, oldLng);
			
			// –ò–ù–¢–ï–†–ü–û–õ–Ø–¶–ò–Ø - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
			const steps = 5;
			for (let s = 1; s <= steps; s++) {
				const t = s / steps;
				const checkLat = prevPos.lat + (newLatLng.lat - prevPos.lat) * t;
				const checkLng = prevPos.lng + (newLatLng.lng - prevPos.lng) * t;
				
				// –í—Ä–µ–º–µ–Ω–Ω–æ —Å—Ç–∞–≤–∏–º —Ç–æ—á–∫—É –≤ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
				currentZone.points[marker.vertexIndex] = [checkLat, checkLng];
				
				if (marker.vertexIndex === 0) {
					const lastIndex = currentZone.points.length - 1;
					currentZone.points[lastIndex] = [checkLat, checkLng];
				}
				
				// ===== –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø –° –°–û–ë–°–¢–í–ï–ù–ù–û–ô –ó–û–ù–û–ô =====
				const selfIntersects = isSelfIntersecting(currentZone.points);
				
				// ===== –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø –° –î–†–£–ì–ò–ú–ò –ó–û–ù–ê–ú–ò =====
				const { intersects: otherIntersects } = isPolygonIntersectingZones(currentZone.points, currentZone.id);
				
				if (selfIntersects || otherIntersects) {
					// –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
					const safeLat = s === 1 ? oldLat : prevPos.lat + (newLatLng.lat - prevPos.lat) * ((s - 1) / steps);
					const safeLng = s === 1 ? oldLng : prevPos.lng + (newLatLng.lng - prevPos.lng) * ((s - 1) / steps);
					
					currentZone.points[marker.vertexIndex] = [safeLat, safeLng];
					if (marker.vertexIndex === 0) {
						const lastIndex = currentZone.points.length - 1;
						currentZone.points[lastIndex] = [safeLat, safeLng];
					}
					
					e.target.setLatLng([safeLat, safeLng]);
					
					if (currentZone.layer) {
						currentZone.layer.setLatLngs(currentZone.points);
					}
					updateMidVertices(currentZone);
					
					marker._prevLatLng = L.latLng(safeLat, safeLng);
					return;
				}
			}
			
			// –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
			currentZone.points[marker.vertexIndex] = [newLatLng.lat, newLatLng.lng];
			if (marker.vertexIndex === 0) {
				const lastIndex = currentZone.points.length - 1;
				currentZone.points[lastIndex] = [newLatLng.lat, newLatLng.lng];
			}
			
			marker._prevLatLng = newLatLng;
			
			if (currentZone.layer) {
				currentZone.layer.setLatLngs(currentZone.points);
			}
			updateMidVertices(currentZone);
		});
        
        marker.on('dragstart', function(e) {
			const iconElement = marker.getElement();
			if (iconElement) iconElement.classList.add('dragging');
			leafletMap.dragging.disable();
			
			// –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
			const currentZone = zones.find(z => z.id === marker.zoneId);
			if (currentZone) {
				const point = currentZone.points[marker.vertexIndex];
				marker._prevLatLng = L.latLng(point[0], point[1]);
			}
		});
        
        marker.on('dragend', function(e) {
            const iconElement = marker.getElement();
            if (iconElement) iconElement.classList.remove('dragging');
            leafletMap.dragging.enable();
            
            const currentZone = zones.find(z => z.id === marker.zoneId);
            if (currentZone) markMapAsChanged();
        });
        
        zone.vertexMarkers.push(marker);
    }
    
    // ===== –°–†–ï–î–ò–ù–ù–´–ï –í–ï–†–®–ò–ù–´ =====
    updateMidVertices(zone);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤–µ—Ä—à–∏–Ω—ã –∑–æ–Ω—ã
function deleteVertex(zoneId, vertexIndex) {
    const zone = zones.find(z => z.id === zoneId);
    if (!zone) return;
    
    // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–µ—Ç—Å—è 3 —Ç–æ—á–∫–∏ –∏–ª–∏ –º–µ–Ω—å—à–µ - —É–¥–∞–ª—è–µ–º –≤—Å—é –∑–æ–Ω—É
    if (zone.points.length <= 4) { // 4 –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –¥—É–±–ª–∏—Ä—É–µ—Ç –ø–µ—Ä–≤—É—é
        deleteZone(zoneId);
        return;
    }
    
    // –£–¥–∞–ª—è–µ–º –≤–µ—Ä—à–∏–Ω—É
    zone.points.splice(vertexIndex, 1);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω
    if (zone.layer) {
        zone.layer.setLatLngs(zone.points);
    }
    
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–µ—Ä—à–∏–Ω—ã
    showZoneVertices(zone);
    
    markMapAsChanged();
}

// –û–¢–î–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–†–ï–î–ò–ù–ù–´–• –í–ï–†–®–ò–ù
function updateMidVertices(zone) {
    if (!leafletMap || !zone) return;
    
    // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ä–µ–¥–∏–Ω–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã
    if (zone.midVertexMarkers) {
        zone.midVertexMarkers.forEach(marker => {
            if (leafletMap) leafletMap.removeLayer(marker);
        });
    }
    
    zone.midVertexMarkers = [];
    
    // –°–æ–∑–¥–∞–µ–º —Å—Ä–µ–¥–∏–Ω–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã –∑–∞–Ω–æ–≤–æ
    for (let i = 0; i < zone.points.length - 1; i++) {
        const currentPoint = zone.points[i];
        const nextPoint = zone.points[i + 1];
        
        const midLat = (currentPoint[0] + nextPoint[0]) / 2;
        const midLng = (currentPoint[1] + nextPoint[1]) / 2;
        const midLatLng = L.latLng(midLat, midLng);
        
        const midMarker = L.marker(midLatLng, {
            icon: L.divIcon({
                html: `<div style="background: ${zone.color}; width: 10px; height: 10px; border: 1.5px solid white; border-radius: 50%; opacity: 0.6; box-shadow: 0 0 3px rgba(0,0,0,0.3); cursor: move;"></div>`,
                iconSize: [14, 14],
                iconAnchor: [7, 7],
                className: 'zone-mid-vertex-marker'
            }),
            draggable: true
        }).addTo(leafletMap);
        
        midMarker.vertexIndex = i;
        midMarker.zoneId = zone.id;
        midMarker.isMidVertex = true;
        
        // –í–ê–ñ–ù–û: –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —ç—Ç–∞ –≤–µ—Ä—à–∏–Ω–∞ —Å–µ–π—á–∞—Å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ—Ç—Å—è
        let isDragging = false;
        
        midMarker.on('dragstart', function(e) {
			isDragging = true;
			const iconElement = midMarker.getElement();
			if (iconElement) iconElement.classList.add('dragging');
			leafletMap.dragging.disable();
			
			// –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
			const currentZone = zones.find(z => z.id === midMarker.zoneId);
			if (currentZone && midMarker.newVertexIndex !== undefined) {
				const point = currentZone.points[midMarker.newVertexIndex];
				midMarker._prevLatLng = L.latLng(point[0], point[1]);
			}
		});
        
        midMarker.on('drag', function(e) {
			if (!isDragging) return;
			
			const newLatLng = e.target.getLatLng();
			const currentZone = zones.find(z => z.id === midMarker.zoneId);
			if (!currentZone) return;
			
			const idx = midMarker.vertexIndex;
			
			if (!midMarker.vertexInserted) {
				const newPoint = [newLatLng.lat, newLatLng.lng];
				currentZone.points.splice(idx + 1, 0, newPoint);
				midMarker.vertexInserted = true;
				midMarker.newVertexIndex = idx + 1;
				midMarker._prevLatLng = newLatLng;
				
				if (currentZone.layer) {
					currentZone.layer.setLatLngs(currentZone.points);
				}
			} else {
				const oldLat = currentZone.points[midMarker.newVertexIndex][0];
				const oldLng = currentZone.points[midMarker.newVertexIndex][1];
				
				const prevPos = midMarker._prevLatLng || L.latLng(oldLat, oldLng);
				
				// –ò–ù–¢–ï–†–ü–û–õ–Ø–¶–ò–Ø
				const steps = 5;
				for (let s = 1; s <= steps; s++) {
					const t = s / steps;
					const checkLat = prevPos.lat + (newLatLng.lat - prevPos.lat) * t;
					const checkLng = prevPos.lng + (newLatLng.lng - prevPos.lng) * t;
					
					currentZone.points[midMarker.newVertexIndex] = [checkLat, checkLng];
					
					// ===== –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø –° –°–û–ë–°–¢–í–ï–ù–ù–û–ô –ó–û–ù–û–ô =====
					const selfIntersects = isSelfIntersecting(currentZone.points);
					
					// ===== –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø –° –î–†–£–ì–ò–ú–ò –ó–û–ù–ê–ú–ò =====
					const { intersects: otherIntersects } = isPolygonIntersectingZones(currentZone.points, currentZone.id);
					
					if (selfIntersects || otherIntersects) {
						const safeLat = s === 1 ? oldLat : prevPos.lat + (newLatLng.lat - prevPos.lat) * ((s - 1) / steps);
						const safeLng = s === 1 ? oldLng : prevPos.lng + (newLatLng.lng - prevPos.lng) * ((s - 1) / steps);
						
						currentZone.points[midMarker.newVertexIndex] = [safeLat, safeLng];
						e.target.setLatLng([safeLat, safeLng]);
						
						if (currentZone.layer) {
							currentZone.layer.setLatLngs(currentZone.points);
						}
						
						midMarker._prevLatLng = L.latLng(safeLat, safeLng);
						return;
					}
				}
				
				// –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
				currentZone.points[midMarker.newVertexIndex] = [newLatLng.lat, newLatLng.lng];
				midMarker._prevLatLng = newLatLng;
				
				if (currentZone.layer) {
					currentZone.layer.setLatLngs(currentZone.points);
				}
			}
		});
        
        midMarker.on('dragend', function(e) {
            isDragging = false;
            
            const iconElement = midMarker.getElement();
            if (iconElement) iconElement.classList.remove('dragging');
            leafletMap.dragging.enable();
            
            const currentZone = zones.find(z => z.id === midMarker.zoneId);
            if (currentZone) {
                // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ –≤–µ—Ä—à–∏–Ω—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                showZoneVertices(currentZone);
                markMapAsChanged();
            }
            
            midMarker.vertexInserted = false;
        });
        
        if (!zone.midVertexMarkers) zone.midVertexMarkers = [];
        zone.midVertexMarkers.push(midMarker);
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è –ª–∏ –ø–æ–ª–∏–≥–æ–Ω —Å–∞–º —Å —Å–æ–±–æ–π (–∫—Ä–æ–º–µ —Å–æ—Å–µ–¥–Ω–∏—Ö —Å—Ç–æ—Ä–æ–Ω)
function isSelfIntersecting(points) {
    // –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 4 —Ç–æ—á–∫–∏ –¥–ª—è —Å–∞–º–æ–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è (3 —Å—Ç–æ—Ä–æ–Ω—ã + –∑–∞–º—ã–∫–∞—é—â–∞—è)
    if (points.length < 4) return false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –ø–∞—Ä—É –Ω–µ—Å–º–µ–∂–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω
    for (let i = 0; i < points.length - 1; i++) {
        const p1 = points[i];
        const p2 = points[i + 1];
        
        // –ù–∞—á–∏–Ω–∞–µ–º —Å i+2, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–º–µ–∂–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
        for (let j = i + 2; j < points.length - 1; j++) {
            const p3 = points[j];
            const p4 = points[j + 1];
            
            // –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–æ—Ä–æ–Ω—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –æ–±—â–∞—è –≤–µ—Ä—à–∏–Ω–∞
            if (i === 0 && j === points.length - 2) continue; // –ü–µ—Ä–≤–∞—è –∏ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–º–µ–∂–Ω—ã —á–µ—Ä–µ–∑ –∑–∞–º—ã–∫–∞—é—â—É—é
            
            if (linesIntersect(
                p1[0], p1[1], p2[0], p2[1],
                p3[0], p3[1], p4[0], p4[1]
            )) {
                return true;
            }
        }
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–º—ã–∫–∞—é—â—É—é —Å—Ç–æ—Ä–æ–Ω—É (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å –ø–µ—Ä–≤–æ–π)
    if (points.length >= 3) {
        const p1 = points[points.length - 2];
        const p2 = points[points.length - 1];
        const p3 = points[0];
        const p4 = points[1];
        
        if (linesIntersect(
            p1[0], p1[1], p2[0], p2[1],
            p3[0], p3[1], p4[0], p4[1]
        )) {
            return true;
        }
    }
    
    return false;
}

// –°–∫—Ä—ã—Ç—å –≤–µ—Ä—à–∏–Ω—ã –∑–æ–Ω—ã
function hideZoneVertices(zone) {
    if (!leafletMap || !zone) return;
    
    // –£–¥–∞–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã
    if (zone.vertexMarkers) {
        zone.vertexMarkers.forEach(marker => {
            if (leafletMap) leafletMap.removeLayer(marker);
        });
        zone.vertexMarkers = [];
    }
    
    // –£–¥–∞–ª—è–µ–º —Å—Ä–µ–¥–∏–Ω–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã
    if (zone.midVertexMarkers) {
        zone.midVertexMarkers.forEach(marker => {
            if (leafletMap) leafletMap.removeLayer(marker);
        });
        zone.midVertexMarkers = [];
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∑–æ–Ω—ã –ø–æ ID (–∏–∑ –ø–æ–ø–∞–ø–∞)
function deleteZoneById(zoneId) {
    deleteZone(zoneId); // –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º deleteZone –±–µ–∑ editingItem
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
    if (leafletMap) {
        leafletMap.closePopup();
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–æ–Ω
function updateZoneList() {
    const zoneCountEl = document.getElementById('zoneCount');
    const zoneListEl = document.getElementById('zoneList');
    const zoneEmptyEl = document.getElementById('zoneEmptyMessage');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    zoneCountEl.textContent = `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–Ω: ${zones.length}`;
    
    if (zones.length === 0) {
        zoneListEl.style.display = 'none';
        zoneEmptyEl.style.display = 'none'; // ‚Üê –ü–†–û–°–¢–û –°–ö–†–´–í–ê–ï–ú, –ù–ï –ü–û–ö–ê–ó–´–í–ê–ï–ú –¢–ï–ö–°–¢
        return;
    }
    
    zoneListEl.style.display = 'block';
    zoneEmptyEl.style.display = 'none';
    
    zoneListEl.innerHTML = '';
    
    zones.forEach((zone, index) => {
        const listItem = document.createElement('div');
        listItem.className = 'bs-list-item';
        listItem.dataset.id = zone.id;
        
        if (selectedZoneId === zone.id) {
            listItem.classList.add('active');
        }
        
        // –¶–≤–µ—Ç–Ω–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        const colorIndicator = document.createElement('span');
        colorIndicator.style.cssText = `
            display: inline-block;
            width: 12px;
            height: 12px;
            background: ${zone.color};
            border-radius: 3px;
            margin-right: 8px;
            flex-shrink: 0;
        `;
        
        const nameSpan = document.createElement('div');
        nameSpan.className = 'bs-list-item-name';
        nameSpan.textContent = zone.name || `–ó–æ–Ω–∞ ${index + 1}`;
        nameSpan.style.marginLeft = '0';
        
        // –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –ö–ê–ö –£ –Ø–ß–ï–ï–ö
        const infoSpan = document.createElement('div');
        infoSpan.className = 'bs-list-item-info';
        
        if (zone.comment && zone.comment.trim()) {
            const comment = zone.comment.trim();
            if (comment.length > 20) {
                infoSpan.textContent = comment.substring(0, 20) + '...';
                infoSpan.title = comment;
            } else {
                infoSpan.textContent = comment;
            }
            infoSpan.style.color = '#aaa';
        } else {
            infoSpan.textContent = '';
        }
        
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.style.cssText = `
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            margin-left: 4px;
            flex-shrink: 0;
        `;
        editBtn.onclick = (e) => {
            e.stopPropagation();
            editZone(zone.id);
        };
        
        listItem.appendChild(colorIndicator);
        listItem.appendChild(nameSpan);
        listItem.appendChild(infoSpan);  // ‚Üê –¢–û–õ–¨–ö–û –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô
        listItem.appendChild(editBtn);
        
        listItem.addEventListener('click', function(e) {
            if (e.target !== editBtn && !editBtn.contains(e.target)) {
                selectZone(zone.id);
            }
        });
        
        zoneListEl.appendChild(listItem);
    });
}

// –í—ã–±–æ—Ä –∑–æ–Ω—ã
function selectZone(zoneId) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤–µ—Ä—à–∏–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–æ–Ω—ã
    if (selectedZoneId) {
        const oldZone = zones.find(z => z.id === selectedZoneId);
        if (oldZone) {
            hideZoneVertices(oldZone);
        }
    }
    
    selectedZoneId = zoneId;
    
    const zone = zones.find(z => z.id === zoneId);
    if (zone && leafletMap) {
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –∑–æ–Ω–µ
        const bounds = L.latLngBounds(zone.points);
        leafletMap.fitBounds(bounds);
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
        if (zone.layer) {
            zone.layer.openPopup();
        }
        
        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ü–û–ö–ê–ó–´–í–ê–ï–ú –í–ï–†–®–ò–ù–´
        showZoneVertices(zone);
    }
    
    updateZoneList();
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–æ–Ω—ã
function editZone(zoneId) {
    const zone = zones.find(z => z.id === zoneId);
    if (!zone) return;
    
    editingItem = { type: "zone", id: zoneId };
    
    document.getElementById('cellName').value = zone.name || '';
    document.getElementById('cellComment').value = zone.comment || '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
    const deleteBtn = document.getElementById('deleteCellBtn');
    deleteBtn.style.display = 'block';
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥
    const dialog = document.getElementById('cellDialog');
    
    if (zone.layer && leafletMap) {
        const bounds = zone.layer.getBounds();
        const center = bounds.getCenter();
        const point = leafletMap.latLngToContainerPoint(center);
        
        const rect = canvas.getBoundingClientRect();
        dialog.style.left = (rect.left + point.x + 20) + 'px';
        dialog.style.top = (rect.top + point.y) + 'px';
    } else {
        dialog.style.left = '50%';
        dialog.style.top = '20%';
        dialog.style.transform = 'translate(-50%, 0)';
    }
    
    dialog.classList.add('active');
    document.getElementById('cellName').focus();
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∑–æ–Ω—ã
function deleteZone(zoneId) {
    if (!zoneId) return;
    
    const index = zones.findIndex(z => z.id === zoneId);
    if (index !== -1) {
        // –ü–û–õ–ù–û–°–¢–¨–Æ –£–î–ê–õ–Ø–ï–ú –í–°–ï –ú–ê–†–ö–ï–†–´ –í–ï–†–®–ò–ù
        const zone = zones[index];
        
        // –£–¥–∞–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã
        if (zone.vertexMarkers) {
            zone.vertexMarkers.forEach(marker => {
                if (leafletMap) leafletMap.removeLayer(marker);
            });
            zone.vertexMarkers = [];
        }
        
        // –£–¥–∞–ª—è–µ–º —Å—Ä–µ–¥–∏–Ω–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã
        if (zone.midVertexMarkers) {
            zone.midVertexMarkers.forEach(marker => {
                if (leafletMap) leafletMap.removeLayer(marker);
            });
            zone.midVertexMarkers = [];
        }
        
        // –£–¥–∞–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω
        if (zone.layer && leafletMap) {
            leafletMap.removeLayer(zone.layer);
        }
        
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
        zones.splice(index, 1);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
        if (selectedZoneId === zoneId) selectedZoneId = null;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        updateZoneList();
        markMapAsChanged();
    }
}

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∑–æ–Ω
function clearZones() {
    zones.forEach(zone => {
        // –£–¥–∞–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã
        if (zone.vertexMarkers) {
            zone.vertexMarkers.forEach(marker => {
                if (leafletMap) leafletMap.removeLayer(marker);
            });
            zone.vertexMarkers = [];
        }
        
        // –£–¥–∞–ª—è–µ–º —Å—Ä–µ–¥–∏–Ω–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã
        if (zone.midVertexMarkers) {
            zone.midVertexMarkers.forEach(marker => {
                if (leafletMap) leafletMap.removeLayer(marker);
            });
            zone.midVertexMarkers = [];
        }
        
        // –£–¥–∞–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω
        if (zone.layer && leafletMap) {
            leafletMap.removeLayer(zone.layer);
        }
    });
    
    zones = [];
    selectedZoneId = null;
    zoneColorIndex = 0;
    currentZoneColor = null;
    
    const zoneCountEl = document.getElementById('zoneCount');
    if (zoneCountEl) {
        zoneCountEl.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–Ω: 0';
    }
    updateZoneList();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —è—á–µ–µ–∫ –∏ —Å–ø–∏—Å–∫–∞
function updateCellCount() {
    renderClustersAndCells(); // –¢–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è–µ–º –∏ —Å—á–µ—Ç—á–∏–∫, –∏ —Å–ø–∏—Å–æ–∫
}

function createCluster() {
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–∞–Ω—è—Ç—ã–µ –Ω–æ–º–µ—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
    const usedNumbers = new Set();
    
    clusters.forEach(cl => {
        const match = cl.name.match(/–ö–ª–∞—Å—Ç–µ—Ä\s+(\d+)/);
        if (match) {
            const num = parseInt(match[1], 10);
            if (num > 0) usedNumbers.add(num);
        }
    });

    // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤–æ–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ —á–∏—Å–ª–æ, –Ω–∞—á–∏–Ω–∞—è —Å 1
    let freeNum = 1;
    while (usedNumbers.has(freeNum)) {
        freeNum++;
    }

    const clusterName = `–ö–ª–∞—Å—Ç–µ—Ä ${freeNum}`;

    const newCluster = {
        id: Date.now(),
        name: clusterName,
        comment: ""  // –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        // cells: [], // –µ—Å–ª–∏ –ø–æ–∑–∂–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª —Ä–∞–Ω–µ–µ)
    clusters.push(newCluster);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
    document.getElementById('clusterCount').textContent = 
        `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: ${clusters.length}`;

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
    renderClustersAndCells();

    // markMapAsChanged();   // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —è—á–µ–µ–∫
function renderClustersAndCells() {
    const listEl = document.getElementById('cellList');
    const cellCountEl = document.getElementById('cellCount');
    listEl.innerHTML = '';
    
    // –¶–í–ï–¢–ê –î–õ–Ø –ö–õ–ê–°–¢–ï–†–û–í - –¢–ï –ñ–ï, –ß–¢–û –£ –ó–û–ù
    const clusterColors = [
        '#FF3333', // 1. —è—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π
        '#FF9500', // 2. —è—Ä–∫–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π
        '#FFD600', // 3. —è—Ä–∫–æ-–∂–µ–ª—Ç—ã–π
        '#00CCFF', // 4. —è—Ä–∫–æ-–≥–æ–ª—É–±–æ–π
        '#3366FF', // 5. —è—Ä–∫–æ-—Å–∏–Ω–∏–π
        '#FF6699', // 6. —Ä–æ–∑–æ–≤–æ-–∫—Ä–∞—Å–Ω—ã–π
        '#00FF99'  // 7. —è—Ä–∫–æ-–º—è—Ç–Ω—ã–π
    ];

    // 1. –ö–ª–∞—Å—Ç–µ—Ä—ã (—Å–≤–µ—Ä—Ö—É)
	clusters.forEach((cluster, index) => {
		const item = document.createElement('div');
		item.className = 'bs-list-item cluster';
		item.dataset.clusterId = cluster.id;

		// –¶–∏–∫–ª–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤
		const colorIndex = index % clusterColors.length;
		const accentColor = clusterColors[colorIndex];

		// –î–ª—è —Ñ–æ–Ω–∞ –±–µ—Ä—ë–º –±–æ–ª–µ–µ —Ç—ë–º–Ω—ã–π/–ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ç–æ–≥–æ –∂–µ —Ü–≤–µ—Ç–∞
		let bgColor;
		if (accentColor === "#FFEB3B") {
			bgColor = "#FFF9C4";
		} else {
			bgColor = adjustBrightness(accentColor, 0.28);
		}

		item.style.setProperty('--cluster-bg', bgColor);
		item.style.setProperty('--cluster-accent', accentColor);
		item.style.setProperty('--cluster-bg-hover', adjustBrightness(accentColor, 0.45));
		
		const nameSpan = document.createElement('div');
		nameSpan.className = 'bs-list-item-name';
		nameSpan.textContent = cluster.name;

		const infoSpan = document.createElement('div');
		infoSpan.className = 'bs-list-item-info';
		if (cluster.comment?.trim()) {
			const txt = cluster.comment.trim();
			infoSpan.textContent = txt.length > 28 ? txt.slice(0, 25) + '‚Ä¶' : txt;
			infoSpan.title = txt;
		}

		// –ö–ù–û–ü–ö–ê "+" –í –°–¢–ò–õ–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê
		const plusBtn = document.createElement('button');
		plusBtn.innerHTML = '+';
		plusBtn.style.cssText = `
			background: #2a3444;
			border: 1px solid #27ae60;
			color: #27ae60;
			font-size: 16px;
			font-weight: normal;
			cursor: pointer;
			padding: 2px 8px;
			margin-left: 4px;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
			line-height: 1;
		`;
		plusBtn.onmouseover = function() {
			this.style.background = '#27ae60';
			this.style.color = '#fff';
			this.style.borderColor = '#27ae60';
		};
		plusBtn.onmouseout = function() {
			this.style.background = '#2a3444';
			this.style.color = '#27ae60';
			this.style.borderColor = '#27ae60';
		};
		plusBtn.onclick = function(e) {
			e.stopPropagation();
			showClusterMessage(cluster.name);
		};

		const editBtn = document.createElement('button');
		editBtn.innerHTML = '‚úèÔ∏è';
		editBtn.style.cssText = `
			background: transparent;
			border: none;
			color: #aaa;
			cursor: pointer;
			font-size: 14px;
			padding: 2px 6px;
			margin-left: 4px;
			opacity: 0.7;
			transition: opacity 0.2s;
		`;
		editBtn.onmouseover = function() {
			this.style.opacity = '1';
		};
		editBtn.onmouseout = function() {
			this.style.opacity = '0.7';
		};
		editBtn.onclick = e => {
			e.stopPropagation();
			editItem("cluster", cluster.id);
		};

		// –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫
		const controlsDiv = document.createElement('div');
		controlsDiv.style.cssText = `
			display: flex;
			align-items: center;
			margin-left: auto;
			gap: 2px;
		`;
		
		controlsDiv.appendChild(editBtn);
		controlsDiv.appendChild(plusBtn);

		item.append(nameSpan, infoSpan, controlsDiv);
		listEl.appendChild(item);
	});

    // 2. –Ø—á–µ–π–∫–∏
    let index = 1;
    for (const [key, hex] of activeHexes.entries()) {
        const listItem = document.createElement('div');
        listItem.className = 'bs-list-item';
        listItem.dataset.key = key;

        if (key === selectedCellKey) {
            listItem.classList.add('active');
        }

        const nameSpan = document.createElement('div');
        nameSpan.className = 'bs-list-item-name';
        nameSpan.textContent = hex.name || `–Ø—á–µ–π–∫–∞ ${index}`;

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –î–û–ë–ê–í–õ–Ø–ï–ú –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –ö–ê–ö –£ –ë–° ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const infoSpan = document.createElement('div');
        infoSpan.className = 'bs-list-item-info';

        if (hex.comment && hex.comment.trim()) {
            const comment = hex.comment.trim();
            if (comment.length > 20) {
                infoSpan.textContent = comment.substring(0, 20) + '...';
                infoSpan.title = comment;
            } else {
                infoSpan.textContent = comment;
            }
            infoSpan.style.color = '#aaa';
        } else {
            infoSpan.textContent = '';
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const editBtn = document.createElement('button');
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.style.cssText = `
            background: transparent;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            margin-left: 4px;
        `;
        editBtn.onclick = (e) => {
            e.stopPropagation();
            editItem("cell", key);
        };

        listItem.appendChild(nameSpan);
        listItem.appendChild(infoSpan);     // ‚Üê –¥–æ–±–∞–≤–∏–ª–∏
        listItem.appendChild(editBtn);

        listItem.addEventListener('click', (e) => {
            if (e.target !== editBtn) {
                selectCellInList(key);
            }
        });

        listEl.appendChild(listItem);
        index++;
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
    if (clusters.length + activeHexes.size > 0) {
        listEl.style.display = 'block';
    } else {
        listEl.style.display = 'none';
    }

    cellCountEl.textContent = `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —è—á–µ–µ–∫: ${activeHexes.size}`;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–¥–æ–±–∞–≤—å –≥–¥–µ-–Ω–∏–±—É–¥—å –≤ <script>)
function adjustBrightness(hex, factor) {
    let r = parseInt(hex.slice(1,3), 16);
    let g = parseInt(hex.slice(3,5), 16);
    let b = parseInt(hex.slice(5,7), 16);
    
    r = Math.min(255, Math.floor(r * factor + 20));
    g = Math.min(255, Math.floor(g * factor + 20));
    b = Math.min(255, Math.floor(b * factor + 20));
    
    return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}

function editItem(type, id) {
    editingItem = { type, id };

    let name = "";
    let comment = "";

    if (type === "cell") {
        const hex = activeHexes.get(id);
        if (!hex) return;
        name = hex.name || "";
        comment = hex.comment || "";
    } else if (type === "cluster") {
        const cluster = clusters.find(c => c.id === id);
        if (!cluster) return;
        name = cluster.name || "";
        comment = cluster.comment || "";
    }

    document.getElementById('cellName').value = name;
    document.getElementById('cellComment').value = comment;

    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ –¥–ª—è —è—á–µ–µ–∫ –∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
    const deleteBtn = document.getElementById('deleteCellBtn');
    
    if (type === "cell") {
        // –î–ª—è —è—á–µ–µ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è
        deleteBtn.style.display = 'block';
    } else if (type === "cluster") {
        // –î–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—Å–µ–≥–¥–∞
        deleteBtn.style.display = 'block';
    } else {
        deleteBtn.style.display = 'none';
    }

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ —Ü–µ–Ω—Ç—Ä—É –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å)
    const dialog = document.getElementById('cellDialog');
    dialog.style.left = '50%';
    dialog.style.top = '20%';
    dialog.style.transform = 'translate(-50%, 0)';
    dialog.classList.add('active');

    document.getElementById('cellName').focus();
}

function saveItem() {
    if (!editingItem) return;

    const nameInput = document.getElementById('cellName');
    const commentInput = document.getElementById('cellComment');

    let newName = nameInput.value.trim();
    const newComment = commentInput.value.trim();

    if (!newName) newName = "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";

    if (editingItem.type === "cell") {
        const hex = activeHexes.get(editingItem.id);
        if (hex) {
            hex.name = newName;
            hex.comment = newComment;
        }
    } else if (editingItem.type === "cluster") {
        const cluster = clusters.find(c => c.id === editingItem.id);
        if (cluster) {
            cluster.name = newName;
            cluster.comment = newComment;
        }
    } else if (editingItem.type === "zone") {
		const zone = zones.find(z => z.id === editingItem.id);
		if (zone) {
			let newName = nameInput.value.trim();
			
			// –ï—Å–ª–∏ –∏–º—è –ø—É—Å—Ç–æ–µ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ
			if (!newName) {
				const zoneNumber = getNextZoneNumber();
				newName = `–ó–æ–Ω–∞ ${zoneNumber}`;
			}
			
			// –ï—Å–ª–∏ –∏–º—è –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É "–ó–æ–Ω–∞ N", –Ω–æ –Ω–µ –ø—É—Å—Ç–æ–µ - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
			zone.name = newName;
			zone.comment = newComment;
			
			// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ø–∞–ø –Ω–∞ –∫–∞—Ä—Ç–µ
			if (zone.layer) {
				zone.layer.closePopup();
				drawZone(zone);
			}
		}
	}

    hideItemDialog();
    renderClustersAndCells();
    updateZoneList();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–æ–Ω
    markMapAsChanged?.();
}

function deleteItem() {
    if (!editingItem) return;

    if (editingItem.type === "cell") {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —è—á–µ–π–∫—É?")) return;
        activeHexes.delete(editingItem.id);
        if (activeHexes.size === 0) selectedCellKey = null;
        
    } else if (editingItem.type === "cluster") {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä?")) return;
        clusters = clusters.filter(c => c.id !== editingItem.id);
        
    } else if (editingItem.type === "zone") {
    const index = zones.findIndex(z => z.id === editingItem.id);
    if (index !== -1) {
        const zone = zones[index];
        
        // –£–¥–∞–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã
        if (zone.vertexMarkers) {
            zone.vertexMarkers.forEach(marker => {
                if (leafletMap) leafletMap.removeLayer(marker);
            });
            zone.vertexMarkers = [];
        }
        
        // –£–¥–∞–ª—è–µ–º —Å—Ä–µ–¥–∏–Ω–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã
        if (zone.midVertexMarkers) {
            zone.midVertexMarkers.forEach(marker => {
                if (leafletMap) leafletMap.removeLayer(marker);
            });
            zone.midVertexMarkers = [];
        }
        
        // –£–¥–∞–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω
        if (zone.layer && leafletMap) {
            leafletMap.removeLayer(zone.layer);
        }
        
        zones.splice(index, 1);
        if (selectedZoneId === editingItem.id) selectedZoneId = null;
        updateZoneList();
    }
}

    hideItemDialog();
    renderClustersAndCells();
    markMapAsChanged?.();
}

function cancelItem() {
    hideItemDialog();
}

function hideItemDialog() {
    document.getElementById('cellDialog').classList.remove('active');
}


// –í—ã–±–æ—Ä —è—á–µ–π–∫–∏ –≤ —Å–ø–∏—Å–∫–µ
function selectCellInList(cellKey) {
    // –ï—Å–ª–∏ –∫–ª–∏–∫–∞–µ–º –Ω–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—É—é —è—á–µ–π–∫—É - —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    if (selectedCellKey === cellKey) {
        selectedCellKey = null;
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞
        document.querySelectorAll('#cellList .bs-list-item').forEach(item => {
            item.classList.remove('active');
        });
        
        draw(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è
        return;
    }
    
    selectedCellKey = cellKey;
    const hex = activeHexes.get(cellKey);
    if (!hex || !leafletMap) return;
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ —è—á–µ–π–∫–∏
    const screenPos = getHexScreenPosition(hex.q, hex.r);
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ
    if (leafletMap) {
        const latLng = leafletMap.containerPointToLatLng([screenPos.x, screenPos.y]);
        leafletMap.setView(latLng, leafletMap.getZoom());
    }
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —è—á–µ–π–∫—É –≤ —Å–ø–∏—Å–∫–µ
    document.querySelectorAll('#cellList .bs-list-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const selectedItem = document.querySelector(`#cellList .bs-list-item[data-key="${cellKey}"]`);
    if (selectedItem) {
        selectedItem.classList.add('active');
    }
    
    draw(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ —Å –æ–¥–∏–Ω–æ—á–Ω—ã–º –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
function toggleAccordion(sectionId, event) {
    if (event) event.stopPropagation();
    
    const header = document.querySelector(`[onclick="toggleAccordion('${sectionId}')"]`);
    const content = document.getElementById(`${sectionId}-content`);
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ —Å–µ–∫—Ü–∏–∏
    document.querySelectorAll('.accordion-header.active').forEach(otherHeader => {
        if (otherHeader !== header) {
            const otherSectionId = otherHeader.getAttribute('onclick').match(/'([^']+)'/)[1];
            const otherContent = document.getElementById(`${otherSectionId}-content`);
            otherHeader.classList.remove('active');
            otherContent.classList.remove('active');
        }
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–µ–∫—Ü–∏—é
    header.classList.toggle('active');
    content.classList.toggle('active');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –æ–∫–Ω–∞ –ø–æ—Å–ª–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è —Å–µ–∫—Ü–∏–∏
    updateControlWindowHeight();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã
function selectMapType(mapType) {
    if (!mapType) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º bgMode
    bgMode = mapType;
    
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –æ–ø—Ü–∏–π
    document.querySelectorAll('.map-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ–ø—Ü–∏—é
    const selectedOption = Array.from(document.querySelectorAll('.map-option')).find(
        option => option.getAttribute('onclick').includes(mapType)
    );
    if (selectedOption) {
        selectedOption.classList.add('selected');
        const radioButton = selectedOption.querySelector('input[type="radio"]');
        if (radioButton) {
            radioButton.checked = true;
        }
    }
    
    // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —Å –Ω–æ–≤—ã–º —Ç–∏–ø–æ–º
    initBackground();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ –§–∞–π–ª
function updateFileToggleButton() {
    const fileToggle = document.getElementById('fileToggle');
    
    const hasDataToSave = bsMarkers.length > 0 || activeHexes.size > 0;
    
    if (hasDataToSave) {
        fileToggle.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        fileToggle.classList.add('changed');
    } else {
        fileToggle.textContent = '–û—Ç–∫—Ä—ã—Ç—å';
        fileToggle.classList.remove('changed');
    }
}

// –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞—Ä—Ç—É –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—É—é
function markMapAsChanged() {
    const hasDataToSave = bsMarkers.length > 0 || activeHexes.size > 0;
    
    if (hasDataToSave && !isMapChanged) {
        isMapChanged = true;
        updateFileToggleButton();
    }
}

// –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
function resetMapChanged() {
    if (bsMarkers.length > 0 || activeHexes.size > 0) {
        isMapChanged = true;
    } else {
        isMapChanged = false;
    }
    updateFileToggleButton();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ë–°
function updateBsList() {
    const bsCountElement = document.getElementById('bsCount');
    const bsListElement = document.getElementById('bsList');
    const bsEmptyMessage = document.getElementById('bsEmptyMessage');
    
    bsCountElement.textContent = `–ë–∞–∑–æ–≤—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π: ${bsMarkers.length}`;
    
    if (bsMarkers.length === 0) {
        bsListElement.style.display = 'none';
        bsEmptyMessage.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    } else {
        bsListElement.style.display = 'block';
        bsEmptyMessage.style.display = 'none';
        
        bsListElement.innerHTML = '';
        
        bsMarkers.forEach((marker, index) => {
            const listItem = document.createElement('div');
            listItem.className = 'bs-list-item';
            if (selectedBsId === marker.id) {
                listItem.classList.add('active');
            }
            listItem.dataset.id = marker.id;
            
            const nameSpan = document.createElement('div');
            nameSpan.className = 'bs-list-item-name';
            nameSpan.textContent = marker.name || `–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è ${index + 1}`;
            
            const infoSpan = document.createElement('div');
            infoSpan.className = 'bs-list-item-info';
            
            if (marker.comment && marker.comment.trim()) {
                const comment = marker.comment.trim();
                if (comment.length > 20) {
                    infoSpan.textContent = comment.substring(0, 20) + '...';
                    infoSpan.title = comment;
                } else {
                    infoSpan.textContent = comment;
                }
                infoSpan.style.color = '#aaa';
            } else {
                infoSpan.textContent = '';
            }
            
            // –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const editBtn = document.createElement('button');
            editBtn.innerHTML = '‚úèÔ∏è';
            editBtn.style.cssText = `
                background: transparent;
                border: none;
                color: #aaa;
                cursor: pointer;
                font-size: 12px;
                padding: 2px 6px;
                margin-left: 4px;
                opacity: 0.7;
                transition: opacity 0.2s;
            `;
            editBtn.onclick = (e) => {
                e.stopPropagation();
                editMarker(marker.id);
            };
            
            editBtn.addEventListener('mouseover', function() {
                this.style.opacity = '1';
            });
            
            editBtn.addEventListener('mouseout', function() {
                this.style.opacity = '0.7';
            });
            
            listItem.appendChild(nameSpan);
            listItem.appendChild(infoSpan);
            listItem.appendChild(editBtn);
            
            listItem.addEventListener('click', function(e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                if (e.target !== editBtn && !editBtn.contains(e.target)) {
                    selectBsInList(marker.id);
                }
            });
            
            bsListElement.appendChild(listItem);
        });
    }
}

// –í—ã–±–æ—Ä –ë–° –≤ —Å–ø–∏—Å–∫–µ
function selectBsInList(bsId) {
    selectedBsId = bsId;
    
    const markerIndex = leafletMarkers.findIndex(m => m.id === bsId);
    if (markerIndex !== -1 && leafletMap) {
        const marker = leafletMarkers[markerIndex];
        
        leafletMap.setView([marker.lat, marker.lng], leafletMap.getZoom());
        
        marker.marker.openPopup();
        
        updateBsList();
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–¥–∏—É—Å–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –Ω–∞ —Ç–µ–∫—É—â–µ–º –∑—É–º–µ
function getRadiusInPixels() {
    if (!leafletMap) return radiusMeters;
    
    let centerLat, centerLng;
    if (gridCenterLat !== null && gridCenterLng !== null) {
        centerLat = gridCenterLat;
        centerLng = gridCenterLng;
    } else {
        const mapCenter = leafletMap.getCenter();
        centerLat = mapCenter.lat;
        centerLng = mapCenter.lng;
    }
    
    const centerPx = leafletMap.latLngToContainerPoint([centerLat, centerLng]);
    
    const degreesPerMeter = 1 / (111111 * Math.cos(centerLat * Math.PI / 180));
    const eastPoint = L.latLng(centerLat, centerLng + radiusMeters * degreesPerMeter);
    
    const eastPx = leafletMap.latLngToContainerPoint(eastPoint);
    
    return Math.abs(eastPx.x - centerPx.x);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Å–µ—Ç–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
function getGridCenterInPixels() {
    if (leafletMap) {
        if (gridCenterLat !== null && gridCenterLng !== null) {
            return leafletMap.latLngToContainerPoint([gridCenterLat, gridCenterLng]);
        } else {
            const center = leafletMap.getCenter();
            return leafletMap.latLngToContainerPoint([center.lat, center.lng]);
        }
    } else {
        return { 
            x: canvas.width / 2, 
            y: canvas.height / 2 
        };
    }
}

// –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä –≤—Ä–∞—â–µ–Ω–∏—è
function getRotationCenter() {
    return { x: 0, y: 0 };
}

// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≥–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (q, r) –≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
function hexToRelativeCoords(q, r) {
    const radiusPx = getRadiusInPixels();
    const height = Math.sqrt(3) * radiusPx;
    const x = height * (q + r / 2);
    const y = radiusPx * 1.5 * r;
    return { x, y, radius: radiusPx };
}

// –í—Ä–∞—â–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –≤–æ–∫—Ä—É–≥ —Ü–µ–Ω—Ç—Ä–∞
function rotatePointAroundCenter(pointX, pointY, centerX, centerY, angle) {
    const rad = angle * Math.PI / 180;
    const cos = Math.cos(rad);
    const sin = Math.sin(rad);
    
    const x = pointX - centerX;
    const y = pointY - centerY;
    
    const xRotated = x * cos - y * sin;
    const yRotated = x * sin + y * cos;
    
    return {
        x: xRotated + centerX,
        y: yRotated + centerY
    };
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    if (bsModeEnabled) {
        canvas.style.pointerEvents = 'auto';
        document.body.classList.add('bs-cursor');
    } else {
        canvas.style.pointerEvents = (buildEnabled || moveGridEnabled) ? 'auto' : 'none';
        document.body.classList.remove('bs-cursor');
    }
    
    updateCursor();
    draw();
}

function parseNum(str, fallback = 0) {
    if (!str.trim()) return fallback;
    const cleaned = str.trim().replace(',', '.');
    const num = parseFloat(cleaned);
    return isNaN(num) ? fallback : num;
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ —Ä–∞–¥–∏—É—Å–∞
function validateRadiusInput(value) {
    const num = parseInt(value);
    if (isNaN(num)) return false;
    return num >= CONFIG.MIN_RADIUS && num <= CONFIG.MAX_RADIUS;
}

function applyRadius() {
    const slider = document.getElementById('radiusSlider');
    const text = document.getElementById('radiusText');
    
    if (text.value !== slider.value) {
        if (!validateRadiusInput(text.value)) {
            alert(`–†–∞–¥–∏—É—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç ${CONFIG.MIN_RADIUS} –¥–æ ${CONFIG.MAX_RADIUS} –º–µ—Ç—Ä–æ–≤`);
            text.value = radiusMeters;
            return;
        }
        radiusMeters = parseNum(text.value, radiusMeters);
    } else {
        radiusMeters = parseFloat(slider.value) || radiusMeters;
    }
    
    radiusMeters = Math.max(CONFIG.MIN_RADIUS, Math.min(CONFIG.MAX_RADIUS, radiusMeters));
    
    slider.value = radiusMeters;
    text.value = Math.round(radiusMeters * 100) / 100;
    
    if (buildEnabled && activeHexes.size > 0) {
        updatePossibleHexes();
    }
    draw();
}

function applyRotation() {
    const slider = document.getElementById('rotSlider');
    const text = document.getElementById('rotText');
    
    if (text.value !== slider.value) {
        rotation = parseNum(text.value, rotation);
    } else {
        rotation = parseFloat(slider.value) || rotation;
    }
    
    while (rotation < -180) rotation += 360;
    while (rotation > 180) rotation -= 360;
    
    const displayRotation = rotation;
    slider.value = displayRotation;
    text.value = Math.round(displayRotation * 100) / 100;
    
    draw();
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–æ–µ–Ω–∏—è (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø)
function toggleBuild(event) {
    if (event) event.stopPropagation();
    
    if (bsModeEnabled) {
        if (document.getElementById('markerDialog').classList.contains('active')) cancelMarker();
        bsModeEnabled = false;
        document.getElementById('bsToggle').classList.remove('active');
        document.getElementById('bsToggle').textContent = '–í–∫–ª—é—á–∏—Ç—å';
        updateCursor();
        removeTempMarker();
        removePreviewCircle();
        if (leafletMap) leafletMap.dragging.enable(), leafletMap.scrollWheelZoom.enable();
    }
    
    buildEnabled = !buildEnabled;
    const btn = document.getElementById('buildToggleInside');
    btn.textContent = buildEnabled ? '–í—ã–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–µ–Ω–∏–µ' : '–í–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–µ–Ω–∏–µ';
    btn.classList.toggle('active', buildEnabled);
    
    updateCursor();
    canvas.style.pointerEvents = (buildEnabled || moveGridEnabled) ? 'auto' : 'none';
    
    if (buildEnabled && ((leafletMap && gridCenterLat === null && gridCenterLng === null) || (!leafletMap && gridCenterLat === null))) {
        if (leafletMap) {
            const center = leafletMap.getCenter();
            gridCenterLat = center.lat;
            gridCenterLng = center.lng;
        } else {
            gridCenterLat = 0;
            gridCenterLng = 0;
        }
        activeHexes.set("0,0", { q: 0, r: 0, name: null, comment: '' });
        updatePossibleHexes();
        markMapAsChanged();
        renderClustersAndCells();
    } else if (!buildEnabled) {
        possibleHexes.clear();
    } else if (buildEnabled && activeHexes.size > 0) {
        updatePossibleHexes();
    }
    
    renderClustersAndCells();
    draw();
}

// –¢–û–õ–¨–ö–û –°–ú–ï–ù–ê –¢–ï–ö–°–¢–ê –ò –¶–í–ï–¢–ê - –¥–ª—è –∫–Ω–æ–ø–∫–∏ –í—ã–∫–ª—é—á–∏—Ç—å/–í–∫–ª—é—á–∏—Ç—å –≤ –°–æ—Ç–æ–≤–æ–º —Å—Ç—Ä–æ–µ–Ω–∏–∏
function toggleNetworkMode(event) {
    if (event) event.stopPropagation();
    
    const btn = event.currentTarget;
    const arbitraryBtn = document.getElementById('arbitraryToggleBtn');
    
    if (btn.textContent === '–í—ã–∫–ª—é—á–∏—Ç—å') {
        // –í—ã–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â—É—é - –≤–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—É—é
        btn.textContent = '–í–∫–ª—é—á–∏—Ç—å';
        btn.classList.remove('active');
        
        arbitraryBtn.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å';
        arbitraryBtn.classList.add('active');
    } else {
        // –í–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â—É—é - –≤—ã–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—É—é
        btn.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å';
        btn.classList.add('active');
        
        arbitraryBtn.textContent = '–í–∫–ª—é—á–∏—Ç—å';
        arbitraryBtn.classList.remove('active');
    }
}

// –¢–û–õ–¨–ö–û –°–ú–ï–ù–ê –¢–ï–ö–°–¢–ê –ò –¶–í–ï–¢–ê - –¥–ª—è –∫–Ω–æ–ø–∫–∏ –í–∫–ª—é—á–∏—Ç—å/–í—ã–∫–ª—é—á–∏—Ç—å –≤ –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º —Å—Ç—Ä–æ–µ–Ω–∏–∏
function toggleArbitraryMode(event) {
    if (event) event.stopPropagation();
    
    const btn = event.currentTarget;
    const networkBtn = document.getElementById('networkToggleBtn');
    
    if (btn.textContent === '–í–∫–ª—é—á–∏—Ç—å') {
        // –í–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â—É—é - –≤—ã–∫–ª—é—á–∞–µ–º —Å–æ—Ç–æ–≤—É—é
        btn.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å';
        btn.classList.add('active');
        
        networkBtn.textContent = '–í–∫–ª—é—á–∏—Ç—å';
        networkBtn.classList.remove('active');
    } else {
        // –í—ã–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â—É—é - –≤–∫–ª—é—á–∞–µ–º —Å–æ—Ç–æ–≤—É—é
        btn.textContent = '–í–∫–ª—é—á–∏—Ç—å';
        btn.classList.remove('active');
        
        networkBtn.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å';
        networkBtn.classList.add('active');
    }
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –ë–°
function toggleBSMode(event) {
    if (event) event.stopPropagation();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç –ª–∏ –¥–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ë–°
    const dialog = document.getElementById('markerDialog');
    if (dialog.classList.contains('active')) {
        // –ï—Å–ª–∏ –¥–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç, –æ—Ç–º–µ–Ω—è–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        cancelMarker();
        return;
    }
    
    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω, –≤—ã–∫–ª—é—á–∞–µ–º –µ–≥–æ
    if (buildEnabled) {
        buildEnabled = false;
        // !!! –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–Ω–æ–π !!!
        const buildBtn = document.getElementById('buildToggleInside');
        if (buildBtn) {
            buildBtn.textContent = '–í–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–µ–Ω–∏–µ';
            buildBtn.classList.remove('active');
            buildBtn.style.background = '#2a3444';
            buildBtn.style.color = '#ddd';
        }
        possibleHexes.clear();
    }
    
    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å–µ—Ç–∫–∏ –≤–∫–ª—é—á–µ–Ω, –≤—ã–∫–ª—é—á–∞–µ–º –µ–≥–æ
    if (moveGridEnabled) {
        moveGridEnabled = false;
        document.getElementById('moveGrid').checked = false;
        if (leafletMap) {
            leafletMap.dragging.enable();
            leafletMap.scrollWheelZoom.enable();
        }
    }
    
    bsModeEnabled = !bsModeEnabled;
    const btn = document.getElementById('bsToggle');
    btn.textContent = bsModeEnabled ? '–í—ã–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å';
    btn.classList.toggle('active', bsModeEnabled);
    
    updateCursor();
    
    if (leafletMap) {
        if (bsModeEnabled) {
            leafletMap.dragging.enable();
            leafletMap.scrollWheelZoom.enable();
        } else {
            if (!moveGridEnabled) {
                leafletMap.dragging.enable();
                leafletMap.scrollWheelZoom.enable();
            }
        }
    }
    
    if (!bsModeEnabled) {
        removeTempMarker();
        removePreviewCircle();
    }
    
    updateBsList();
    draw();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
function updateCursor() {
    if (bsModeEnabled) {
        canvas.style.cursor = 'crosshair';
        canvas.style.pointerEvents = 'auto';
        document.body.classList.add('bs-cursor');
    } else if (moveGridEnabled && activeHexes.size > 0) {
        canvas.style.cursor = 'move';
        canvas.style.pointerEvents = 'auto';
        document.body.classList.remove('bs-cursor');
    } else if (buildEnabled) {
        canvas.style.cursor = 'pointer';
        canvas.style.pointerEvents = 'auto';
        document.body.classList.remove('bs-cursor');
    } else {
        canvas.style.cursor = 'default';
        canvas.style.pointerEvents = 'none';
        document.body.classList.remove('bs-cursor');
    }
    
    // –î–ª—è —Ä–µ–∂–∏–º–∞ –∑–æ–Ω canvas –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    if (zoneModeEnabled) {
        canvas.style.pointerEvents = 'none';
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ—Å–µ–¥–µ–π –≥–µ–∫—Å–∞–≥–æ–Ω–∞
function getHexNeighbors(q, r) {
    return hexDirections.map(dir => ({
        q: q + dir.q,
        r: r + dir.r
    }));
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —è—á–µ–µ–∫
function updatePossibleHexes() {
    if (!buildEnabled || activeHexes.size === 0) {
        possibleHexes.clear();
        return;
    }
    
    possibleHexes.clear();
    
    for (const hex of activeHexes.values()) {
        const neighbors = getHexNeighbors(hex.q, hex.r);
        
        for (const neighbor of neighbors) {
            const key = `${neighbor.q},${neighbor.r}`;
            
            if (!activeHexes.has(key) && !possibleHexes.has(key)) {
                possibleHexes.set(key, neighbor);
            }
        }
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ü–µ–Ω—Ç—Ä–∞ —è—á–µ–π–∫–∏
function getHexScreenPosition(q, r) {
    const gridCenterPx = getGridCenterInPixels();
    const relativeCoords = hexToRelativeCoords(q, r);
    const rotationCenter = getRotationCenter();
    
    let x = gridCenterPx.x + relativeCoords.x;
    let y = gridCenterPx.y + relativeCoords.y;
    
    if (rotation !== 0) {
        const centerX = gridCenterPx.x + rotationCenter.x;
        const centerY = gridCenterPx.y + rotationCenter.y;
        const rotated = rotatePointAroundCenter(x, y, centerX, centerY, rotation);
        x = rotated.x;
        y = rotated.y;
    }
    
    return { 
        x, 
        y,
        radius: relativeCoords.radius
    };
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∞
function isPointInHexagon(px, py, hexX, hexY, hexRadius) {
    const gridCenterPx = getGridCenterInPixels();
    const rotationCenter = getRotationCenter();
    
    if (rotation !== 0) {
        const centerX = gridCenterPx.x + rotationCenter.x;
        const centerY = gridCenterPx.y + rotationCenter.y;
        
        const unrotatedPoint = rotatePointAroundCenter(px, py, centerX, centerY, -rotation);
        px = unrotatedPoint.x;
        py = unrotatedPoint.y;
        
        const unrotatedCenter = rotatePointAroundCenter(hexX, hexY, centerX, centerY, -rotation);
        hexX = unrotatedCenter.x;
        hexY = unrotatedCenter.y;
    }
    
    const dx = px - hexX;
    const dy = py - hexY;
    
    const distance = Math.sqrt(dx * dx + dy * dy);
    if (distance > hexRadius) return false;
    
    let angle = Math.atan2(dy, dx);
    
    if (angle < 0) angle += 2 * Math.PI;
    
    const segmentAngle = Math.PI / 3;
    const segment = Math.floor(angle / segmentAngle);
    
    const segmentStart = segment * segmentAngle;
    const segmentEnd = segmentStart + segmentAngle;
    const angleInSegment = angle - segmentStart;
    
    const maxDistance = hexRadius * Math.cos(segmentAngle / 2 - angleInSegment) / Math.cos(segmentAngle / 2);
    
    return distance <= maxDistance;
}

// –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
function createTempMarker(lat, lng) {
    if (!leafletMap) return null;
    
    removeTempMarker();
    
    const markerHtml = document.createElement('div');
    markerHtml.className = 'bs-marker temp';
    markerHtml.title = '–ù–æ–≤–∞—è –±–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è';
    
    tempMarker = L.marker([lat, lng], {
        icon: L.divIcon({
            html: markerHtml.outerHTML,
            iconSize: [22, 22],
            iconAnchor: [11, 11],
            className: 'bs-marker-icon'
        }),
        draggable: false
    }).addTo(leafletMap);
    
    return tempMarker;
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
function removeTempMarker() {
    if (tempMarker && leafletMap) {
        leafletMap.removeLayer(tempMarker);
        tempMarker = null;
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫—Ä—É–≥–∞
function createPreviewCircle(lat, lng, radius) {
    if (!leafletMap) return null;
    
    removePreviewCircle();
    
    previewCircle = L.circle([lat, lng], {
        radius: radius,
        color: '#ff4444',
        fillColor: '#ff4444',
        fillOpacity: 0.1,
        weight: 2,
        dashArray: '5, 5'
    }).addTo(leafletMap);
    
    return previewCircle;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫—Ä—É–≥–∞
function updatePreviewCircle(lat, lng, radius) {
    if (!previewCircle) {
        createPreviewCircle(lat, lng, radius);
    } else {
        previewCircle.setLatLng([lat, lng]);
        previewCircle.setRadius(radius);
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫—Ä—É–≥–∞
function removePreviewCircle() {
    if (previewCircle && leafletMap) {
        leafletMap.removeLayer(previewCircle);
        previewCircle = null;
    }
}

// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ —Ä—è–¥–æ–º —Å –∫–ª–∏–∫–æ–º
function positionDialogNearMarker(x, y) {
    const dialog = document.getElementById('markerDialog');
    const rect = canvas.getBoundingClientRect();
    const dialogWidth = 300;
    const dialogHeight = 320;
    
    let left = rect.left + x + 20;
    let top = rect.top + y;
    
    if (left + dialogWidth > window.innerWidth) {
        left = rect.left + x - dialogWidth - 20;
    }
    if (top + dialogHeight > window.innerHeight) {
        top = rect.top + y - dialogHeight;
    }
    
    dialog.style.left = left + 'px';
    dialog.style.top = top + 'px';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞–Ω–≤–∞—Å—É
canvas.addEventListener('click', function(e) {
    if (!buildEnabled && !moveGridEnabled && !bsModeEnabled) return;
    
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    
    currentClickPosition = { x: clickX, y: clickY };
    
    // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ë–°
	if (bsModeEnabled && leafletMap) {
		const latLng = leafletMap.containerPointToLatLng([clickX, clickY]);
		
		createTempMarker(latLng.lat, latLng.lng);
		
		currentMarkerData = {
			lat: latLng.lat,
			lng: latLng.lng,
			temp: true
		};
		
		// –ü–û–õ–£–ß–ê–ï–ú –°–õ–ï–î–£–Æ–©–ò–ô –î–û–°–¢–£–ü–ù–´–ô –ù–û–ú–ï–†
		const nextNumber = getNextBSNumber();
		const defaultName = `–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è ${nextNumber}`;
		
		document.getElementById('markerName').value = defaultName;
		document.getElementById('markerName').placeholder = defaultName;
		
		document.getElementById('markerShowCircle').checked = false;
		document.getElementById('markerCircleSlider').value = CONFIG.DEFAULT_BS_RADIUS;
		document.getElementById('markerCircleText').value = CONFIG.DEFAULT_BS_RADIUS;
		document.getElementById('markerCircleControls').style.display = 'none';
		
		removePreviewCircle();
		
		positionDialogNearMarker(clickX, clickY);
		showMarkerDialog(false);
		return;
	}
    
    // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ —è—á–µ–π–∫–∞–º
    if (buildEnabled) {
        let clickedActiveHex = null;
        for (const hex of activeHexes.values()) {
            const screenPos = getHexScreenPosition(hex.q, hex.r);
            
            if (isPointInHexagon(clickX, clickY, screenPos.x, screenPos.y, screenPos.radius)) {
                clickedActiveHex = hex;
                break;
            }
        }
        
        if (clickedActiveHex) {
            // !!! –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –¥–æ —É–¥–∞–ª–µ–Ω–∏—è –∏ –ø–æ–∑–≤–æ–ª—è–µ–º —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —è—á–µ–π–∫—É !!!
            const key = `${clickedActiveHex.q},${clickedActiveHex.r}`;
            
            // –£–¥–∞–ª—è–µ–º —è—á–µ–π–∫—É (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å –æ–¥–Ω–∞)
            // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é —è—á–µ–π–∫—É - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (selectedCellKey === key) {
                selectedCellKey = null;
            }
            
            activeHexes.delete(key);
            updatePossibleHexes();
            draw();
            renderClustersAndCells();
            markMapAsChanged();
            
            return;
        }
        
        let clickedPossibleHex = null;
        for (const hex of possibleHexes.values()) {
            const screenPos = getHexScreenPosition(hex.q, hex.r);
            
            if (isPointInHexagon(clickX, clickY, screenPos.x, screenPos.y, screenPos.radius)) {
                clickedPossibleHex = hex;
                break;
            }
        }
        
        if (clickedPossibleHex) {
            const key = `${clickedPossibleHex.q},${clickedPossibleHex.r}`;
            activeHexes.set(key, {
                q: clickedPossibleHex.q,
                r: clickedPossibleHex.r,
                name: null,
                comment: ''
            });
            updatePossibleHexes();
            draw();
            renderClustersAndCells();
            updateCellCount();
            markMapAsChanged();
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Å–µ—Ç–∫–∏
canvas.addEventListener('mousedown', function(e) {
    if (!moveGridEnabled || !leafletMap || activeHexes.size === 0) return;
    
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    dragStartPixelX = mouseX;
    dragStartPixelY = mouseY;
    dragStartLat = gridCenterLat;
    dragStartLng = gridCenterLng;
    
    isDragging = true;
    
    e.preventDefault();
});

canvas.addEventListener('mousemove', function(e) {
    if (!isDragging || !moveGridEnabled || !leafletMap) return;
    
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    const deltaPixelX = mouseX - dragStartPixelX;
    const deltaPixelY = mouseY - dragStartPixelY;
    
    const startPx = leafletMap.latLngToContainerPoint([dragStartLat, dragStartLng]);
    
    const newPx = {
        x: startPx.x + deltaPixelX,
        y: startPx.y + deltaPixelY
    };
    
    const newLatLng = leafletMap.containerPointToLatLng([newPx.x, newPx.y]);
    
    gridCenterLat = newLatLng.lat;
    gridCenterLng = newLatLng.lng;
    
    draw();
});

canvas.addEventListener('mouseup', function() {
    isDragging = false;
});

canvas.addEventListener('mouseleave', function() {
    isDragging = false;
});

// –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
function createMarker(lat, lng, name = '', comment = '', id = null, showCircle = false, circleRadius = CONFIG.DEFAULT_BS_RADIUS) {
    if (!leafletMap) return null;
    
    const markerHtml = document.createElement('div');
    markerHtml.className = 'bs-marker';
    markerHtml.title = name || '–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è';
    
    const marker = L.marker([lat, lng], {
        icon: L.divIcon({
            html: markerHtml.outerHTML,
            iconSize: [22, 22],
            iconAnchor: [11, 11],
            className: 'bs-marker-icon'
        }),
        draggable: true
    }).addTo(leafletMap);
    
    marker.on('dragstart', function(e) {
        isDraggingMarker = true;
        draggedMarkerId = id;
        
        const iconElement = marker.getElement();
        if (iconElement) {
            iconElement.classList.add('dragging');
        }
        
        marker.closePopup();
        
        selectedBsId = null;
        updateBsList();
    });
    
    marker.on('drag', function(e) {
        const markerIndex = leafletMarkers.findIndex(m => m.id === id);
        if (markerIndex !== -1) {
            const markerData = leafletMarkers[markerIndex];
            if (markerData.circle) {
                markerData.circle.setLatLng(e.target.getLatLng());
            }
        }
    });
    
    marker.on('dragend', function(e) {
        isDraggingMarker = false;
        draggedMarkerId = null;
        
        const iconElement = marker.getElement();
        if (iconElement) {
            iconElement.classList.remove('dragging');
        }
        
        const markerIndex = leafletMarkers.findIndex(m => m.id === id);
        if (markerIndex !== -1) {
            const newLatLng = e.target.getLatLng();
            leafletMarkers[markerIndex].lat = newLatLng.lat;
            leafletMarkers[markerIndex].lng = newLatLng.lng;
            
            const bsMarkerIndex = bsMarkers.findIndex(m => m.id === id);
            if (bsMarkerIndex !== -1) {
                bsMarkers[bsMarkerIndex].lat = newLatLng.lat;
                bsMarkers[bsMarkerIndex].lng = newLatLng.lng;
                
                markMapAsChanged();
            }
        }
    });
    
    const popupContent = document.createElement('div');
    
    const title = document.createElement('div');
    title.className = 'marker-popup-title';
    title.textContent = name || '–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è';
    popupContent.appendChild(title);
    
    if (comment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'marker-popup-comment';
        commentDiv.textContent = comment;
        popupContent.appendChild(commentDiv);
    }
    
    if (showCircle) {
        const circleInfo = document.createElement('div');
        circleInfo.className = 'marker-popup-comment';
        circleInfo.textContent = `–†–∞–¥–∏—É—Å: ${circleRadius} –º`;
        circleInfo.style.color = '#ff4444';
        popupContent.appendChild(circleInfo);
    }
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'popup-buttons';
    buttonsDiv.innerHTML = `
        <button onclick="editMarker(${id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="deleteMarkerById(${id})" style="background:#ff4444;color:white;">–£–¥–∞–ª–∏—Ç—å</button>
    `;
    popupContent.appendChild(buttonsDiv);
    
    marker.bindPopup(popupContent);
    
    marker.on('popupopen', function(e) {
        if (leafletMap) {
            leafletMap.dragging.enable();
        }
    });
    
    let circle = null;
    if (showCircle && circleRadius > 0) {
        circle = L.circle([lat, lng], {
            radius: circleRadius,
            color: '#ff4444',
            fillColor: '#ff4444',
            fillOpacity: 0.1,
            weight: 2,
            dashArray: '5, 5'
        }).addTo(leafletMap);
    }
    
    return { 
        marker, 
        id: id || Date.now(), 
        lat, 
        lng, 
        name, 
        comment,
        showCircle: showCircle || false,
        circleRadius: circleRadius || CONFIG.DEFAULT_BS_RADIUS,
        circle: circle
    };
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä—É–≥–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞
function updateMarkerCircle(markerData) {
    // –í—Å–µ–≥–¥–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫—Ä—É–≥ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
    if (markerData.circle && leafletMap) {
        leafletMap.removeLayer(markerData.circle);
        markerData.circle = null;
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫—Ä—É–≥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (markerData.showCircle && markerData.circleRadius > 0) {
        markerData.circle = L.circle([markerData.lat, markerData.lng], {
            radius: markerData.circleRadius,
            color: '#ff4444',
            fillColor: '#ff4444',
            fillOpacity: 0.1,
            weight: 2,
            dashArray: '5, 5'
        }).addTo(leafletMap);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ø–∞–ø
    updateMarkerPopup(markerData);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–æ–ø–∞–ø–∞ –º–∞—Ä–∫–µ—Ä–∞
function updateMarkerPopup(markerData) {
    if (!markerData.marker) return;
    
    const popupContent = document.createElement('div');
    
    const title = document.createElement('div');
    title.className = 'marker-popup-title';
    title.textContent = markerData.name || '–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è';
    popupContent.appendChild(title);
    
    if (markerData.comment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'marker-popup-comment';
        commentDiv.textContent = markerData.comment;
        popupContent.appendChild(commentDiv);
    }
    
    if (markerData.showCircle) {
        const circleInfo = document.createElement('div');
        circleInfo.className = 'marker-popup-comment';
        circleInfo.textContent = `–†–∞–¥–∏—É—Å: ${markerData.circleRadius} –º`;
        circleInfo.style.color = '#ff4444';
        popupContent.appendChild(circleInfo);
    }
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'popup-buttons';
    buttonsDiv.innerHTML = `
        <button onclick="editMarker(${markerData.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button onclick="deleteMarkerById(${markerData.id})" style="background:#ff4444;color:white;">–£–¥–∞–ª–∏—Ç—å</button>
    `;
    popupContent.appendChild(buttonsDiv);
    
    markerData.marker.bindPopup(popupContent);
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
function editMarker(markerId) {
    const markerIndex = leafletMarkers.findIndex(m => m.id === markerId);
    if (markerIndex !== -1) {
        leafletMarkers[markerIndex].marker.closePopup();
    }
    
    const markerIndex2 = bsMarkers.findIndex(m => m.id === markerId);
    if (markerIndex2 === -1) return;
    
    const marker = bsMarkers[markerIndex2];
    editingMarkerId = markerId;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    originalMarkerValues = {
        lat: marker.lat,
        lng: marker.lng,
        name: marker.name,
        comment: marker.comment,
        showCircle: marker.showCircle || false,
        circleRadius: marker.circleRadius || CONFIG.DEFAULT_BS_RADIUS
    };
    
    document.getElementById('markerName').value = marker.name || '';
    document.getElementById('markerComment').value = marker.comment || '';
    document.getElementById('markerShowCircle').checked = marker.showCircle || false;
    document.getElementById('markerCircleSlider').value = marker.circleRadius || CONFIG.DEFAULT_BS_RADIUS;
    document.getElementById('markerCircleText').value = marker.circleRadius || CONFIG.DEFAULT_BS_RADIUS;
    
    const circleControls = document.getElementById('markerCircleControls');
    circleControls.style.display = marker.showCircle ? 'block' : 'none';
    
    document.getElementById('deleteMarkerBtn').style.display = 'block';
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫—Ä—É–≥ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    const leafletMarkerIndex = leafletMarkers.findIndex(m => m.id === markerId);
    if (leafletMarkerIndex !== -1) {
        const leafletMarker = leafletMarkers[leafletMarkerIndex];
        if (leafletMarker.circle) {
            leafletMarker.circle.remove(); // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫—Ä—É–≥
        }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫—Ä—É–≥–∞ —Å —Ç–µ–∫—É—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    if (marker.showCircle && marker.circleRadius > 0) {
        createPreviewCircle(marker.lat, marker.lng, marker.circleRadius);
    }
    
    const markerPx = leafletMap.latLngToContainerPoint([marker.lat, marker.lng]);
    positionDialogNearMarker(markerPx.x, markerPx.y);
    
    showMarkerDialog(true);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ ID
function deleteMarkerById(markerId) {
    const markerIndex = bsMarkers.findIndex(m => m.id === markerId);
    if (markerIndex === -1) return;
    
    const leafletMarkerIndex = leafletMarkers.findIndex(m => m.id === markerId);
    if (leafletMarkerIndex !== -1) {
        const leafletMarker = leafletMarkers[leafletMarkerIndex];
        if (leafletMarker.marker && leafletMap) {
            leafletMap.removeLayer(leafletMarker.marker);
        }
        if (leafletMarker.circle && leafletMap) {
            leafletMap.removeLayer(leafletMarker.circle);
        }
        leafletMarkers.splice(leafletMarkerIndex, 1);
    }
    
    bsMarkers.splice(markerIndex, 1);
    
    if (selectedBsId === markerId) {
        selectedBsId = null;
    }
    
    if (editingMarkerId === markerId) {
        hideMarkerDialog();
    }
    
    updateBsList();
    
    markMapAsChanged();
    
    updateControlWindowHeight();
}

// –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ (–∏–∑ –¥–∏–∞–ª–æ–≥–∞)
function deleteMarker() {
    if (!editingMarkerId) return;
    
    deleteMarkerById(editingMarkerId);
    hideMarkerDialog();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–∞
function showMarkerDialog(isEditing = false) {
    const dialog = document.getElementById('markerDialog');
    dialog.classList.add('active');
    
    if (isEditing) {
        document.getElementById('deleteMarkerBtn').style.display = 'block';
    } else {
        // –ü–û–õ–£–ß–ê–ï–ú –°–õ–ï–î–£–Æ–©–ò–ô –î–û–°–¢–£–ü–ù–´–ô –ù–û–ú–ï–†
        const nextNumber = getNextBSNumber();
        const defaultName = `–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è ${nextNumber}`;
        
        document.getElementById('markerName').value = defaultName;
        document.getElementById('markerName').placeholder = defaultName;
        document.getElementById('markerComment').value = '';
        document.getElementById('markerShowCircle').checked = false;
        document.getElementById('markerCircleSlider').value = CONFIG.DEFAULT_BS_RADIUS;
        document.getElementById('markerCircleText').value = CONFIG.DEFAULT_BS_RADIUS;
        document.getElementById('markerCircleControls').style.display = 'none';
        document.getElementById('deleteMarkerBtn').style.display = 'none';
        
        removePreviewCircle();
    }
    
    document.getElementById('markerName').focus();
}

// –°–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥
function hideMarkerDialog() {
    document.getElementById('markerDialog').classList.remove('active');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–ª—è –Ω–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ cancelMarker)
    if (!editingMarkerId) {
        currentMarkerData = null;
        
        document.getElementById('markerShowCircle').checked = false;
        document.getElementById('markerCircleSlider').value = CONFIG.DEFAULT_BS_RADIUS;
        document.getElementById('markerCircleText').value = CONFIG.DEFAULT_BS_RADIUS;
        document.getElementById('markerCircleControls').style.display = 'none';
        
        removePreviewCircle();
    }
    
    editingMarkerId = null;
    originalMarkerValues = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä–∫–µ—Ä
function saveMarker() {
    const nameInput = document.getElementById('markerName');
    let name = nameInput.value.trim();
    const comment = document.getElementById('markerComment').value.trim();
    const showCircle = document.getElementById('markerShowCircle').checked;
    const circleRadius = parseInt(document.getElementById('markerCircleText').value) || CONFIG.DEFAULT_BS_RADIUS;
    
    if (!name) {
        name = `–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è ${bsMarkers.length + 1}`;
        nameInput.value = name;
    }
    
    if (editingMarkerId) {
        const markerIndex = bsMarkers.findIndex(m => m.id === editingMarkerId);
        if (markerIndex !== -1) {
            bsMarkers[markerIndex].name = name;
            bsMarkers[markerIndex].comment = comment;
            bsMarkers[markerIndex].showCircle = showCircle;
            bsMarkers[markerIndex].circleRadius = circleRadius;
            
            const leafletMarkerIndex = leafletMarkers.findIndex(m => m.id === editingMarkerId);
            if (leafletMarkerIndex !== -1) {
                leafletMarkers[leafletMarkerIndex].name = name;
                leafletMarkers[leafletMarkerIndex].comment = comment;
                leafletMarkers[leafletMarkerIndex].showCircle = showCircle;
                leafletMarkers[leafletMarkerIndex].circleRadius = circleRadius;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–≥ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π)
                updateMarkerCircle(leafletMarkers[leafletMarkerIndex]);
            }
            
            updateBsList();
            markMapAsChanged();
        }
    } else if (currentMarkerData) {
    const markerId = Date.now();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è, –µ—Å–ª–∏ –ø—É—Å—Ç–æ–µ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–µ—Ä - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ
    let finalName = name;
    if (!finalName || finalName.trim() === '') {
        const nextNumber = getNextBSNumber();
        finalName = `–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω—Ü–∏—è ${nextNumber}`;
    }
    
    const marker = {
        id: markerId,
        lat: currentMarkerData.lat,
        lng: currentMarkerData.lng,
        name: finalName,
        comment: comment,
        showCircle: showCircle,
        circleRadius: circleRadius
    };
    
    bsMarkers.push(marker);
    
    const leafletMarker = createMarker(
        marker.lat, 
        marker.lng, 
        marker.name, 
        marker.comment, 
        markerId,
        marker.showCircle,
        marker.circleRadius
    );
    
    if (leafletMarker) {
        leafletMarkers.push(leafletMarker);
    }
    
    updateBsList();
    markMapAsChanged();
}
    
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    removePreviewCircle();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    originalMarkerValues = null;
    
    hideMarkerDialog();
    
    if (!editingMarkerId && bsModeEnabled) {
        toggleBSMode();
    }
    
    updateControlWindowHeight();
}

// –û—Ç–º–µ–Ω–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
function cancelMarker() {
    // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–∞—Ä–∫–µ—Ä–∞, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    if (editingMarkerId && originalMarkerValues) {
        const markerIndex = bsMarkers.findIndex(m => m.id === editingMarkerId);
        if (markerIndex !== -1) {
            const leafletMarkerIndex = leafletMarkers.findIndex(m => m.id === editingMarkerId);
            if (leafletMarkerIndex !== -1) {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                leafletMarkers[leafletMarkerIndex].name = originalMarkerValues.name;
                leafletMarkers[leafletMarkerIndex].comment = originalMarkerValues.comment;
                leafletMarkers[leafletMarkerIndex].showCircle = originalMarkerValues.showCircle;
                leafletMarkers[leafletMarkerIndex].circleRadius = originalMarkerValues.circleRadius;
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫—Ä—É–≥
                if (leafletMarkers[leafletMarkerIndex].circle && leafletMap) {
                    leafletMap.removeLayer(leafletMarkers[leafletMarkerIndex].circle);
                }
                
                if (originalMarkerValues.showCircle && originalMarkerValues.circleRadius > 0) {
                    leafletMarkers[leafletMarkerIndex].circle = L.circle(
                        [originalMarkerValues.lat, originalMarkerValues.lng], 
                        {
                            radius: originalMarkerValues.circleRadius,
                            color: '#ff4444',
                            fillColor: '#ff4444',
                            fillOpacity: 0.1,
                            weight: 2,
                            dashArray: '5, 5'
                        }
                    ).addTo(leafletMap);
                } else {
                    leafletMarkers[leafletMarkerIndex].circle = null;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ø–∞–ø
                updateMarkerPopup(leafletMarkers[leafletMarkerIndex]);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
            bsMarkers[markerIndex].name = originalMarkerValues.name;
            bsMarkers[markerIndex].comment = originalMarkerValues.comment;
            bsMarkers[markerIndex].showCircle = originalMarkerValues.showCircle;
            bsMarkers[markerIndex].circleRadius = originalMarkerValues.circleRadius;
        }
    }
    
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    removePreviewCircle();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    originalMarkerValues = null;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
    hideMarkerDialog();
    
    if (!editingMarkerId && bsModeEnabled) {
        toggleBSMode();
    }
}

// –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã
function clearMarkers() {
    leafletMarkers.forEach(markerData => {
        if (markerData.marker && leafletMap) {
            leafletMap.removeLayer(markerData.marker);
        }
        if (markerData.circle && leafletMap) {
            leafletMap.removeLayer(markerData.circle);
        }
    });
    
    bsMarkers = [];
    leafletMarkers = [];
    bsCounter = 0;
    selectedBsId = null;
    
    updateBsList();
    
    markMapAsChanged();
    
    updateControlWindowHeight();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π —Ñ–æ–Ω–∞
function saveMapState() {
    if (!leafletMap) return null;
    
    return {
        center: leafletMap.getCenter(),
        zoom: leafletMap.getZoom(),
        gridCenterLat: gridCenterLat,
        gridCenterLng: gridCenterLng,
        activeHexes: Array.from(activeHexes.entries()),
        bsMarkers: bsMarkers
    };
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ñ–æ–Ω–∞
function restoreMapState(state) {
    if (!state || !leafletMap) return;
    
    leafletMap.setView(state.center, state.zoom);
    
    gridCenterLat = state.gridCenterLat;
    gridCenterLng = state.gridCenterLng;
    
    activeHexes.clear();
	selectedCellKey = null;
    for (const [key, hex] of state.activeHexes) {
        activeHexes.set(key, hex);
    }
    renderClustersAndCells();
    clearMarkers();
    bsMarkers = state.bsMarkers || [];
    
    bsCounter = bsMarkers.length;
    
    bsMarkers.forEach(marker => {
        const leafletMarker = createMarker(
            marker.lat, 
            marker.lng, 
            marker.name, 
            marker.comment, 
            marker.id,
            marker.showCircle,
            marker.circleRadius
        );
        if (leafletMarker) {
            leafletMarkers.push(leafletMarker);
        }
    });
    
    if (buildEnabled && activeHexes.size > 0) {
        updatePossibleHexes();
    }
    
    updateBsList();
    
    resetMapChanged();
}

function initBackground() {
    const savedState = saveMapState();
    
    if (leafletMap) {
        leafletMap.off();
        leafletMap.remove();
        leafletMap = null;
    }
    
    leafletMarkers = [];
    tempMarker = null;
    previewCircle = null;
    
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = '';
    mapDiv.style.background = '';
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–∏–ø–∞ - —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    leafletMap = L.map('map', {
        zoomControl: false,
        attributionControl: true,
        zoomAnimation: false,
        fadeAnimation: false,
        dragging: true
    });
    
    // –í—Å–µ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π —Å–ª–æ–π
    let baseLayer;
    if (bgMode === 'osm') {
        baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        });
    } else if (bgMode === 'google-sat') {
        baseLayer = googleSat;
    } else if (bgMode === 'google-hybrid') {
        baseLayer = googleHybrid;
    } else if (bgMode === 'yandex') {
        baseLayer = yandexMap;
    } else if (bgMode === 'yandex-hybrid') {
        baseLayer = yandexHybrid;
    } else if (bgMode === 'yandex-sat') {
        baseLayer = yandexSat;
    } else {
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º OSM
        baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –Ω–∞ –∫–∞—Ä—Ç—É
    baseLayer.addTo(leafletMap);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∏–¥
    if (savedState) {
        restoreMapState(savedState);
    } else {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        leafletMap.setView([54.7388, 55.9722], 12);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã
    leafletMap.on('move zoom', function() {
        draw();
    });
    
    // –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π
    leafletMap.dragging.enable();
    leafletMap.scrollWheelZoom.enable();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ë–°
    updateBsList();
    
    draw();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
function updateControlWindowHeight() {
    const controls = document.getElementById('controls');
    
    controls.style.maxHeight = 'none';
    const contentHeight = controls.scrollHeight;
    controls.style.maxHeight = '';
    
    const maxAvailableHeight = window.innerHeight * 0.95;
    
    const newHeight = Math.min(contentHeight, maxAvailableHeight);
    controls.style.maxHeight = newHeight + 'px';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawHexagon(ctx, centerX, centerY, radius, color = '#4af', lineWidth = 2, hexRotation = 0) {
    ctx.beginPath();
    for (let i = 0; i < 6; i++) {
        const angle = i * Math.PI / 3 - Math.PI / 2 + hexRotation;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.stroke();
    
    ctx.fillStyle = 'rgba(68, 136, 255, 0.1)';
    ctx.fill();
}

function drawCenter(ctx, centerX, centerY, radius, color = '#f44') {
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
}

function drawCircle(ctx, centerX, centerY, radius, color = 'rgba(244,68,68,0.5)') {
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.strokeStyle = color;
    ctx.lineWidth = 1;
    ctx.stroke();
}

// –†–∏—Å–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —è—á–µ–π–∫–∏
function drawPreviewHex() {
    if (buildEnabled || activeHexes.size > 0) return;
    
    const gridCenterPx = getGridCenterInPixels();
    const radiusPx = getRadiusInPixels();
    const rotationCenter = getRotationCenter();
    
    let centerX = gridCenterPx.x;
    let centerY = gridCenterPx.y;
    
    if (rotation !== 0) {
        const rotationCenterX = gridCenterPx.x + rotationCenter.x;
        const rotationCenterY = gridCenterPx.y + rotationCenter.y;
        const rotated = rotatePointAroundCenter(centerX, centerY, rotationCenterX, rotationCenterY, rotation);
        centerX = rotated.x;
        centerY = rotated.y;
    }
    
    if (showHex) {
        ctx.globalAlpha = 0.3;
        drawHexagon(ctx, centerX, centerY, radiusPx, '#4af', 2, rotation * Math.PI / 180);
        ctx.globalAlpha = 1.0;
    }
    
    if (showCenters) {
        ctx.globalAlpha = 0.3;
        drawCenter(ctx, centerX, centerY, 3, '#f44');
        ctx.globalAlpha = 1.0;
    }
    
    if (showCircles) {
        ctx.globalAlpha = 0.3;
        drawCircle(ctx, centerX, centerY, radiusPx, 'rgba(244,68,68,0.3)');
        ctx.globalAlpha = 1.0;
    }
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ–π —Å–µ—Ç–∫–∏
function drawGrid() {
    const gridCenterPx = getGridCenterInPixels();
    
    if (buildEnabled) {
        for (const hex of possibleHexes.values()) {
            const screenPos = getHexScreenPosition(hex.q, hex.r);
            const { x, y, radius: currentRadius } = screenPos;
            
            if (showHex) {
                drawHexagon(ctx, x, y, currentRadius, '#888', 1.5, rotation * Math.PI / 180);
            }
            
            if (showCenters) {
                drawCenter(ctx, x, y, 3, '#888');
            }
            
            if (showCircles) {
                drawCircle(ctx, x, y, currentRadius, 'rgba(136,136,136,0.5)');
            }
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º–µ–Ω–∞ —è—á–µ–µ–∫ –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π
    updateCellNames();
    
    let cellIndex = 1;
    for (const [key, hex] of activeHexes.entries()) {
        const screenPos = getHexScreenPosition(hex.q, hex.r);
        const { x, y, radius: currentRadius } = screenPos;
        
        // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∏–º—è —è—á–µ–π–∫–µ, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if (!hex.name) {
            hex.name = `–Ø—á–µ–π–∫–∞ ${cellIndex}`;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–∞ —è—á–µ–π–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π
        const isSelected = (key === selectedCellKey);
        
        if (showHex) {
            if (isSelected) {
                // –í—ã–¥–µ–ª–µ–Ω–Ω–∞—è —è—á–µ–π–∫–∞ - —Å –Ω–∞—Å—ã—â–µ–Ω–Ω–æ–π –∑–∞–ª–∏–≤–∫–æ–π
                ctx.save();
                
                // –ù–∞—Å—ã—â–µ–Ω–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = i * Math.PI / 3 - Math.PI / 2 + rotation * Math.PI / 180;
                    const px = x + currentRadius * Math.cos(angle);
                    const py = y + currentRadius * Math.sin(angle);
                    i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
                }
                ctx.closePath();
                ctx.fillStyle = 'rgba(68, 136, 255, 0.4)'; // –ë–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞
                ctx.fill();
                
                // –ö–æ–Ω—Ç—É—Ä –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —è—á–µ–π–∫–∏
                ctx.strokeStyle = '#4af';
                ctx.lineWidth = 2.5; // –ë–æ–ª–µ–µ —Ç–æ–ª—Å—Ç—ã–π –∫–æ–Ω—Ç—É—Ä
                ctx.stroke();
                
                ctx.restore();
                
                // –¶–µ–Ω—Ç—Ä –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —è—á–µ–π–∫–∏ - —Å–∏–Ω–∏–π —Ü–≤–µ—Ç
                drawCenter(ctx, x, y, 5, '#4af'); // –°–∏–Ω–∏–π —Ü–≤–µ—Ç –≤–º–µ—Å—Ç–æ –æ—Ä–∞–Ω–∂–µ–≤–æ–≥–æ
            } else {
                // –û–±—ã—á–Ω–∞—è —è—á–µ–π–∫–∞ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
                drawHexagon(ctx, x, y, currentRadius, '#4af', 2, rotation * Math.PI / 180);
                
                if (showCenters) {
                    drawCenter(ctx, x, y, 4, '#f44');
                }
            }
        } else if (showCenters) {
            // –ï—Å–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∏, –Ω–æ –≤–∫–ª—é—á–µ–Ω—ã —Ü–µ–Ω—Ç—Ä—ã
            if (isSelected) {
                drawCenter(ctx, x, y, 5, '#4af'); // –°–∏–Ω–∏–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π
            } else {
                drawCenter(ctx, x, y, 4, '#f44');
            }
        }
        
        if (showCircles) {
            drawCircle(ctx, x, y, currentRadius, 'rgba(244,68,68,0.5)');
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–º—è —è—á–µ–π–∫–∏ –≤—ã—à–µ —Ü–µ–Ω—Ç—Ä–∞ —è—á–µ–π–∫–∏
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏
        const hasComment = hex.comment && hex.comment.trim().length > 0;
        drawCellName(ctx, x, y, hex.name, currentRadius, hasComment);
        
        cellIndex++;
    }
}

// –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —è—á–µ–π–∫–∏
function drawSelectedHex(ctx, x, y, radius, rotationAngle) {
    ctx.save();
    
    // –í–Ω–µ—à–Ω—è—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
    ctx.beginPath();
    for (let i = 0; i < 6; i++) {
        const angle = i * Math.PI / 3 - Math.PI / 2 + rotationAngle;
        const px = x + (radius + 5) * Math.cos(angle);
        const py = y + (radius + 5) * Math.sin(angle);
        i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
    }
    ctx.closePath();
    ctx.strokeStyle = 'rgba(255, 153, 0, 0.5)'; // –û—Ä–∞–Ω–∂–µ–≤–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
    ctx.lineWidth = 3;
    ctx.stroke();
    
    // –û—Å–Ω–æ–≤–Ω–∞—è —è—á–µ–π–∫–∞ —Å —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
    ctx.globalAlpha = 0.4; // –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
    drawHexagon(ctx, x, y, radius, '#4af', 2, rotationAngle);
    
    // –Ø—Ä–∫–∏–π —Ü–µ–Ω—Ç—Ä
    ctx.globalAlpha = 1.0;
    drawCenter(ctx, x, y, 5, '#4af'); // –û—Ä–∞–Ω–∂–µ–≤—ã–π —Ü–µ–Ω—Ç—Ä
    
    ctx.restore();
}

// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    updateCellCount();
    if ((!leafletMap && bgMode !== 'image') || (activeHexes.size === 0 && !buildEnabled && !moveGridEnabled && !bsModeEnabled)) {
        if (!leafletMap && bgMode !== 'image') return;
        
        drawPreviewHex();
        return;
    }
    
    if (!buildEnabled && activeHexes.size === 0) {
        drawPreviewHex();
    }
    
    if (activeHexes.size > 0 || buildEnabled) {
        drawGrid();
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('radiusSlider').oninput = function() {
    document.getElementById('radiusText').value = this.value;
    applyRadius();
};

document.getElementById('showNames').onchange = function() {
    showNames = this.checked;
    draw();
};

document.getElementById('radiusText').addEventListener('blur', function() {
    applyRadius();
});

document.getElementById('radiusText').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        applyRadius();
    }
});

document.getElementById('rotSlider').oninput = function() {
    document.getElementById('rotText').value = this.value;
    applyRotation();
};

document.getElementById('rotText').addEventListener('blur', function() {
    applyRotation();
});

document.getElementById('rotText').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        applyRotation();
    }
});

document.getElementById('moveGrid').onchange = function() {
    moveGridEnabled = this.checked;
    
    updateCursor();
    
    canvas.style.pointerEvents = (buildEnabled || moveGridEnabled) ? 'auto' : 'none';
    
    if (leafletMap) {
        if (moveGridEnabled) {
            leafletMap.dragging.disable();
            leafletMap.scrollWheelZoom.disable();
        } else {
            leafletMap.dragging.enable();
            leafletMap.scrollWheelZoom.enable();
        }
    }
    
    draw();
};

document.getElementById('showHex').onchange = function() {
    showHex = this.checked;
    draw();
};

document.getElementById('showCenters').onchange = function() {
    showCenters = this.checked;
    draw();
};

document.getElementById('showCircles').onchange = function() {
    showCircles = this.checked;
    draw();
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞–¥–∏—É—Å–∞ –ë–° –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
document.getElementById('markerShowCircle').onchange = function() {
    const circleControls = document.getElementById('markerCircleControls');
    circleControls.style.display = this.checked ? 'block' : 'none';
    
    if (currentMarkerData && tempMarker) {
        const showCircle = this.checked;
        const circleRadius = parseInt(document.getElementById('markerCircleText').value) || CONFIG.DEFAULT_BS_RADIUS;
        
        if (showCircle) {
            createPreviewCircle(currentMarkerData.lat, currentMarkerData.lng, circleRadius);
        } else {
            removePreviewCircle();
        }
    }
    
    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –º–∞—Ä–∫–µ—Ä, –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–Ω–æ –Ω–µ —Å–∞–º –º–∞—Ä–∫–µ—Ä)
    if (editingMarkerId && leafletMap) {
        const markerIndex = bsMarkers.findIndex(m => m.id === editingMarkerId);
        if (markerIndex !== -1) {
            const marker = bsMarkers[markerIndex];
            const circleRadius = parseInt(document.getElementById('markerCircleText').value) || CONFIG.DEFAULT_BS_RADIUS;
            
            if (this.checked) {
                createPreviewCircle(marker.lat, marker.lng, circleRadius);
            } else {
                removePreviewCircle();
            }
        }
    }
};

document.getElementById('markerCircleSlider').oninput = function() {
    const value = this.value;
    document.getElementById('markerCircleText').value = value;
    
    // –î–ª—è –Ω–æ–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
    if (currentMarkerData && tempMarker && document.getElementById('markerShowCircle').checked) {
        updatePreviewCircle(currentMarkerData.lat, currentMarkerData.lng, parseInt(value));
    }
    
    // –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ - —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    if (editingMarkerId && leafletMap && document.getElementById('markerShowCircle').checked) {
        const markerIndex = bsMarkers.findIndex(m => m.id === editingMarkerId);
        if (markerIndex !== -1) {
            const marker = bsMarkers[markerIndex];
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä, –Ω–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫—Ä—É–≥
            updatePreviewCircle(marker.lat, marker.lng, parseInt(value));
        }
    }
};

document.getElementById('markerCircleText').addEventListener('blur', function() {
    const value = parseInt(this.value) || CONFIG.DEFAULT_BS_RADIUS;
    const clampedValue = Math.max(CONFIG.MIN_BS_RADIUS, Math.min(CONFIG.MAX_BS_RADIUS, value));
    this.value = clampedValue;
    document.getElementById('markerCircleSlider').value = clampedValue;
    
    if (currentMarkerData && tempMarker && document.getElementById('markerShowCircle').checked) {
        updatePreviewCircle(currentMarkerData.lat, currentMarkerData.lng, clampedValue);
    }
    
    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –º–∞—Ä–∫–µ—Ä, –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–Ω–æ –Ω–µ —Å–∞–º –º–∞—Ä–∫–µ—Ä)
    if (editingMarkerId && leafletMap && document.getElementById('markerShowCircle').checked) {
        const markerIndex = bsMarkers.findIndex(m => m.id === editingMarkerId);
        if (markerIndex !== -1) {
            const marker = bsMarkers[markerIndex];
            updatePreviewCircle(marker.lat, marker.lng, clampedValue);
        }
    }
});

document.getElementById('markerCircleText').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const value = parseInt(this.value) || CONFIG.DEFAULT_BS_RADIUS;
        const clampedValue = Math.max(CONFIG.MIN_BS_RADIUS, Math.min(CONFIG.MAX_BS_RADIUS, value));
        this.value = clampedValue;
        document.getElementById('markerCircleSlider').value = clampedValue;
        
        if (currentMarkerData && tempMarker && document.getElementById('markerShowCircle').checked) {
            updatePreviewCircle(currentMarkerData.lat, currentMarkerData.lng, clampedValue);
        }
        
        // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –º–∞—Ä–∫–µ—Ä, –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–Ω–æ –Ω–µ —Å–∞–º –º–∞—Ä–∫–µ—Ä)
        if (editingMarkerId && leafletMap && document.getElementById('markerShowCircle').checked) {
            const markerIndex = bsMarkers.findIndex(m => m.id === editingMarkerId);
            if (markerIndex !== -1) {
                const marker = bsMarkers[markerIndex];
                updatePreviewCircle(marker.lat, marker.lng, clampedValue);
            }
        }
    }
});

// –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞
function reset() {
    const currentBgMode = bgMode;
    
    radiusMeters = CONFIG.DEFAULT_RADIUS;
    rotation = 0;
    buildEnabled = false;
    bsModeEnabled = false;
    moveGridEnabled = false;
    gridCenterLat = null;
    gridCenterLng = null;
    activeHexes.clear();
    possibleHexes.clear();
	selectedCellKey = null;
	editingCellKey = null;
    renderClustersAndCells();
    showHex = true;
    showCenters = true;
    showCircles = false;
    showNames = false;
    
    clearMarkers();
    
    document.getElementById('bsToggle').textContent = '–í–∫–ª—é—á–∏—Ç—å';
    document.getElementById('bsToggle').classList.remove('active');
    document.getElementById('moveGrid').checked = false;
    document.getElementById('showHex').checked = true;
    document.getElementById('showCenters').checked = true;
    document.getElementById('showCircles').checked = false;
    document.getElementById('showNames').checked = false; // ‚Üê –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ö–£
    document.getElementById('radiusText').value = CONFIG.DEFAULT_RADIUS.toString();
    document.getElementById('rotText').value = '0';
    document.getElementById('radiusSlider').value = CONFIG.DEFAULT_RADIUS;
    document.getElementById('rotSlider').value = 0;
	
	// –û—á–∏—Å—Ç–∫–∞ –∑–æ–Ω
    clearZones();
    zoneModeEnabled = false;
	currentZoneColor = null;
	zoneColorIndex = 0;
    const zoneBtn = document.getElementById('createZoneBtn');
    if (zoneBtn) {
        zoneBtn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É';
        zoneBtn.classList.remove('active');
        zoneBtn.style.background = '#2a3444';
        zoneBtn.style.color = '#ddd';
        zoneBtn.style.border = 'none';
    }
    
    const zoneCountEl = document.getElementById('zoneCount');
    if (zoneCountEl) {
        zoneCountEl.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–Ω: 0';
    }
    
    cancelPolygon();
    
	const btn = document.getElementById('buildToggleInside');
	if (btn) btn.textContent = '–í–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–µ–Ω–∏–µ', btn.classList.remove('active');
		
		canvas.style.pointerEvents = 'none';
		document.body.classList.remove('bs-cursor');
		updateCursor();
		
		bgMode = currentBgMode;
		
		if (leafletMap) {
			leafletMap.dragging.enable();
			leafletMap.scrollWheelZoom.enable();
		}
		
		isMapChanged = false;
		updateFileToggleButton();
		
		updateControlWindowHeight();
		
		draw();
	}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –º–µ–Ω—é
document.querySelector('.file-btn-close').addEventListener('click', function() {
    reset();
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫–æ–Ω
window.onresize = function() {
    resize();
    updateControlWindowHeight();
};

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω —è—á–µ–µ–∫
function updateCellNames() {
    let index = 1;
    for (const hex of activeHexes.values()) {
        if (!hex.name) {
            hex.name = `–Ø—á–µ–π–∫–∞ ${index}`;
        }
        index++;
    }
    renderClustersAndCells(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–º–µ–Ω
}

// –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —è—á–µ–π–∫–∏ –≤–Ω—É—Ç—Ä–∏ —è—á–µ–π–∫–∏ (–≤—ã—à–µ —Ü–µ–Ω—Ç—Ä–∞)
function drawCellName(ctx, centerX, centerY, name, hexRadius, hasComment = false) {
    // –ï—Å–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω –æ—Ç–∫–ª—é—á–µ–Ω–æ - –Ω–µ —Ä–∏—Å—É–µ–º –Ω–∏—á–µ–≥–æ
    if (!showNames) return;
    
    ctx.save();
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤—ã—à–µ —Ü–µ–Ω—Ç—Ä–∞ —è—á–µ–π–∫–∏
    const textY = centerY - hexRadius * 0.2;
    
    // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
    ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
    ctx.strokeStyle = hasComment ? '#4af' : 'rgba(255, 255, 255, 0.3)'; // –°–∏–Ω—è—è –æ–±–≤–æ–¥–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    ctx.lineWidth = hasComment ? 1.5 : 1;
    
    // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ–Ω - –ø–æ–¥–±–∏—Ä–∞–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ–¥ —Ç–µ–∫—Å—Ç
    ctx.font = 'bold 10px Arial, sans-serif';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ –∏–º–µ–Ω–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    const displayText = hasComment ? `${name} üí¨` : name;
    const textWidth = ctx.measureText(displayText).width + 12;
    const textHeight = 16;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã —Ñ–æ–Ω –Ω–µ –≤—ã—Ö–æ–¥–∏–ª –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —è—á–µ–π–∫–∏
    const maxWidth = hexRadius * 1.5;
    let finalText = displayText;
    if (textWidth > maxWidth) {
        // –°–æ–∫—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç
        const chars = Math.floor((maxWidth - 20) / 6);
        finalText = displayText.substring(0, chars) + '...';
    }
    
    const finalTextWidth = ctx.measureText(finalText).width + 12;
    
    // –†–∏—Å—É–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–π —Ñ–æ–Ω —Å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–º–∏ —É–≥–ª–∞–º–∏
    const cornerRadius = 4;
    const bgX = centerX - finalTextWidth/2;
    const bgY = textY - textHeight/2;
    
    // –§–æ–Ω —Å –∑–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–º–∏ —É–≥–ª–∞–º–∏
    ctx.beginPath();
    ctx.moveTo(bgX + cornerRadius, bgY);
    ctx.lineTo(bgX + finalTextWidth - cornerRadius, bgY);
    ctx.quadraticCurveTo(bgX + finalTextWidth, bgY, bgX + finalTextWidth, bgY + cornerRadius);
    ctx.lineTo(bgX + finalTextWidth, bgY + textHeight - cornerRadius);
    ctx.quadraticCurveTo(bgX + finalTextWidth, bgY + textHeight, bgX + finalTextWidth - cornerRadius, bgY + textHeight);
    ctx.lineTo(bgX + cornerRadius, bgY + textHeight);
    ctx.quadraticCurveTo(bgX, bgY + textHeight, bgX, bgY + textHeight - cornerRadius);
    ctx.lineTo(bgX, bgY + cornerRadius);
    ctx.quadraticCurveTo(bgX, bgY, bgX + cornerRadius, bgY);
    ctx.closePath();
    
    ctx.fill();
    ctx.stroke();
    
    // –¢–µ–∫—Å—Ç
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = hasComment ? '#ffffff' : '#cccccc'; // –ë–æ–ª–µ–µ —Å–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    
    // –õ–µ–≥–∫–∞—è —Ç–µ–Ω—å –¥–ª—è —Ç–µ–∫—Å—Ç–∞
    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
    ctx.shadowBlur = 2;
    ctx.shadowOffsetX = 1;
    ctx.shadowOffsetY = 1;
    
    ctx.fillText(finalText, centerX, textY);
    
    ctx.restore();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
function updateAnalyticsObjectCount() {
    const objectCountEl = document.querySelector('#analytics-content .bs-count');
    if (objectCountEl) {
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤, –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
        objectCountEl.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤: 0';
    }
}

// –í—ã–∑—ã–≤–∞–π—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤–µ–∑–¥–µ, –≥–¥–µ —Å–æ–∑–¥–∞—é—Ç—Å—è/—É–¥–∞–ª—è—é—Ç—Å—è –æ–±—ä–µ–∫—Ç—ã

// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ —Ä—è–¥–æ–º —Å —è—á–µ–π–∫–æ–π
function positionCellDialog(cellKey) {
    const hex = activeHexes.get(cellKey);
    if (!hex || !leafletMap) return;
    
    const dialog = document.getElementById('cellDialog');
    const screenPos = getHexScreenPosition(hex.q, hex.r);
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–∞–Ω–≤–∞—Å–∞ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–∫–Ω–∞
    const rect = canvas.getBoundingClientRect();
    const dialogWidth = 300;
    const dialogHeight = 320;
    
    let left = rect.left + screenPos.x + 20;
    let top = rect.top + screenPos.y;
    
    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é, —á—Ç–æ–±—ã –¥–∏–∞–ª–æ–≥ –Ω–µ –≤—ã—Ö–æ–¥–∏–ª –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
    if (left + dialogWidth > window.innerWidth) {
        left = rect.left + screenPos.x - dialogWidth - 20;
    }
    if (top + dialogHeight > window.innerHeight) {
        top = rect.top + screenPos.y - dialogHeight;
    }
    
    dialog.style.left = left + 'px';
    dialog.style.top = top + 'px';
}

document.addEventListener('click', function(e) {
    // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –ø–æ –ø–æ–ª–∏–≥–æ–Ω—É –∏ –Ω–µ –ø–æ –ø–æ–ø–∞–ø—É
    if (!e.target.closest('.leaflet-popup') && !e.target.closest('.leaflet-interactive')) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ø–∞–ø—ã
        if (leafletMap) {
            leafletMap.closePopup();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤–µ—Ä—à–∏–Ω—ã —Ç–µ–∫—É—â–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–æ–Ω—ã
            if (selectedZoneId) {
                const zone = zones.find(z => z.id === selectedZoneId);
                if (zone) {
                    hideZoneVertices(zone);
                }
                selectedZoneId = null;
                updateZoneList();
            }
        }
    }
});

window.onload = () => {
    resize();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    document.getElementById('radiusSlider').min = CONFIG.MIN_RADIUS;
    document.getElementById('radiusSlider').max = CONFIG.MAX_RADIUS;
    document.getElementById('radiusSlider').value = CONFIG.DEFAULT_RADIUS;
    document.getElementById('radiusSlider').step = 10;
    
    document.getElementById('rotSlider').min = -180;
    document.getElementById('rotSlider').max = 180;
    document.getElementById('rotSlider').value = 0;
    document.getElementById('rotSlider').step = 1;
    
    document.getElementById('radiusText').value = CONFIG.DEFAULT_RADIUS.toString();
    document.getElementById('rotText').value = '0';
    document.getElementById('moveGrid').checked = false;
	document.getElementById('showNames').checked = false;
    
	renderClustersAndCells();
	
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–¥–∏—É—Å–∞ –ë–°
    document.getElementById('markerCircleSlider').min = CONFIG.MIN_BS_RADIUS;
    document.getElementById('markerCircleSlider').max = CONFIG.MAX_BS_RADIUS;
    document.getElementById('markerCircleSlider').value = CONFIG.DEFAULT_BS_RADIUS;
    document.getElementById('markerCircleSlider').step = 10;
    document.getElementById('markerCircleText').value = CONFIG.DEFAULT_BS_RADIUS.toString();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ –§–∞–π–ª
    updateFileToggleButton();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ –ö–∞—Ä—Ç–∞
    const mapOptions = document.querySelectorAll('.map-option');
    mapOptions.forEach(option => {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ onclick –∞—Ç—Ä–∏–±—É—Ç–∞
        const onclickAttr = option.getAttribute('onclick');
        if (onclickAttr) {
            const match = onclickAttr.match(/selectMapType\('([^']+)'\)/);
            if (match) {
                const value = match[1];
                const radio = option.querySelector('input[type="radio"]');
                if (radio) {
                    radio.value = value;
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ OSM, –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π
                    if (value === 'osm') {
                        radio.checked = true;
                        option.classList.add('selected');
                        bgMode = value; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º bgMode –≤ OSM
                    }
                }
            }
        }
    });
	
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∑–æ–Ω
    const zoneCountEl = document.getElementById('zoneCount');
    if (zoneCountEl) {
        zoneCountEl.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–Ω: 0';
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –∑–æ–Ω
    const zoneBtn = document.getElementById('createZoneBtn');
    if (zoneBtn) {
        zoneBtn.style.background = '#2a3444';
        zoneBtn.style.color = '#ddd';
        zoneBtn.style.border = 'none';
    }
	
	const btn = document.getElementById('buildToggleInside');
	if (btn) btn.textContent = buildEnabled ? '–í—ã–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–µ–Ω–∏–µ' : '–í–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–µ–Ω–∏–µ';
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ bgMode —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if (!bgMode || bgMode === '') {
        bgMode = 'osm';
    }
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–µ—Ä–≤–∞—è –æ–ø—Ü–∏—è –æ—Ç–º–µ—á–µ–Ω–∞
    const firstOption = document.querySelector('.map-option.selected');
    if (!firstOption) {
        const osmOption = document.querySelector('.map-option[onclick*="osm"]');
        if (osmOption) {
            osmOption.classList.add('selected');
            const radio = osmOption.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
            }
            bgMode = 'osm';
        }
    }
	
	// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    const createObjBtn = document.getElementById('createObjectBtn');
    if (createObjBtn) {
        createObjBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            alert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        });
    }
    
    const importObjBtn = document.getElementById('importObjectsBtn');
    if (importObjBtn) {
        importObjBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            alert('–§—É–Ω–∫—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
    initBackground();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    updateControlWindowHeight();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∞–π–ª–æ–≤–æ–≥–æ –º–µ–Ω—é (–¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏)
    document.querySelector('.file-btn-open').addEventListener('click', function() {
        alert('–§—É–Ω–∫—Ü–∏—è "–û—Ç–∫—Ä—ã—Ç—å" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
    });
    
    document.querySelector('.file-btn-save').addEventListener('click', function() {
        alert('–§—É–Ω–∫—Ü–∏—è "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
    });
	
	document.getElementById('createClusterBtn').addEventListener('click', createCluster);
    
    document.querySelector('.file-btn-save-image').addEventListener('click', function() {
        alert('–§—É–Ω–∫—Ü–∏—è "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
    });
	
	// –£–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Escape –∏ –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç:
	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape') {
			// –û—Ç–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ –∑–æ–Ω
			if (zoneModeEnabled) {
				e.preventDefault();
				
				zoneModeEnabled = false;
				currentZoneColor = null;
				
				const btn = document.getElementById('createZoneBtn');
				btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É';
				btn.classList.remove('active'); // –£–±–∏—Ä–∞–µ–º active
				btn.style.background = '#2a3444'; // –°–µ—Ä—ã–π —Ü–≤–µ—Ç
				btn.style.color = '#ddd';
				btn.style.border = 'none';
				
				cancelPolygon();
				
				if (leafletMap) {
					leafletMap.dragging.enable();
					leafletMap.off('click', onMapClickForZone);
					leafletMap.off('mousemove', onMapMouseMoveForZone);
				}
				
				canvas.style.pointerEvents = 'none';
				updateCursor();
			}
			
			// –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —è—á–µ–π–∫–∏/–∫–ª–∞—Å—Ç–µ—Ä–∞
			const cellDialog = document.getElementById('cellDialog');
			if (cellDialog.classList.contains('active')) {
				cancelItem();
			}
			
			// –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
			const markerDialog = document.getElementById('markerDialog');
			if (markerDialog.classList.contains('active')) {
				cancelMarker();
			}
		}
	});
	
	// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–≤–∏—à –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —è—á–µ–µ–∫
	document.getElementById('cellName').addEventListener('keydown', function(e) {
		if (e.key === 'Enter') {
			e.preventDefault();
			saveCell();
		}
	});

	document.getElementById('cellComment').addEventListener('keydown', function(e) {
		if (e.key === 'Enter' && e.ctrlKey) {
			e.preventDefault();
			saveCell();
		}
	});
};
</script>
</body>
</html>